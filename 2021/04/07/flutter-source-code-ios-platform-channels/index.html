<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文基于 flutter 1.22.2 源码，在 ios_debug_unopt 产物下调试。  1. 概述本文下面的 demo(来自 Writing custom platform-specific code) 和 flutter 源码来分析 ios platform channels 的实现。 1.1 demo12345678910111213141516171819202122232425">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Flutter Platform Channel">
<meta property="og:url" content="http://example.com/2021/04/07/flutter-source-code-ios-platform-channels/index.html">
<meta property="og:site_name" content="牛易疯先森的开发记录">
<meta property="og:description" content="本文基于 flutter 1.22.2 源码，在 ios_debug_unopt 产物下调试。  1. 概述本文下面的 demo(来自 Writing custom platform-specific code) 和 flutter 源码来分析 ios platform channels 的实现。 1.1 demo12345678910111213141516171819202122232425">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sat02pap001files.storage.live.com/y4mzy8_dvuO_7jpkfRcL_zpKQPzaxo5SWf7xWupP1dN-lR4kd9U5Z-UG7VVpscyQGF7iMkN6ijMHGd6VS5xe-Oc8cJ5pn3-MDVTgn-7Ofeu5LUNkq8JbdlrhzjHkx7vSWZNXT7llmx5wNwpQdHXKPDJi8Gd0zjwISaK4eUHUZSn7WPjvJM2v-JpSKbwzi91ISeq?width=1510&height=298&cropmode=none">
<meta property="og:image" content="https://sat02pap001files.storage.live.com/y4mUGGI2r5i-neno2THQeatT_9IYs5sjV5WBa3nWViDRBvGyKMW4bb7YCEwaZ0301WYHyushCicJOcKu__8oWsEYxJYuvnyKNiWYno_Dc-ahUlx8DoQFNmbi1dJYSNDF2UQocAp9kI6gczqy1xeP092Zq059i_o8kiNDkUA2fbVtqFqo3si12taxoHuocX89LSZ?width=1853&height=653&cropmode=none">
<meta property="og:image" content="https://sat02pap001files.storage.live.com/y4m-rYn8D1lzoPq_wbVvKy3EG6enZmedcNaBygocaNLZcdhSZeNYKXmP680OXlMqRjy7gHBixIXWcDiG9M3HusQuoTt8tRZP8l332NODfLERsK4nqIuhb8-x6ZySt9NsU3-NL3Sdd43joTTZ1rZ0AqR4djHPQzMPZbS2-g6xR8siN8pEl1pengn-_ghou21p20K?width=843&height=483&cropmode=none">
<meta property="og:image" content="https://sat02pap001files.storage.live.com/y4mYWALpdQzLwOseOw8dbeMIzvvFQHdZzr8fEblvx10FYnSauMk-KRCNCVxgYPcZi_ooUOOGJ69jnQVjA-nKBpq-fdPzXuc2Ihwydb02HooyXOBIuUeXQGDFI2swtmsmgSFtaGVO_qHp6cQriPABQCkVdUDa83T_4F72eeaHOMvJyarXiwZ0kaSiNIcwsrjBMfi?width=2223&height=923&cropmode=none">
<meta property="article:published_time" content="2021-04-07T10:37:37.000Z">
<meta property="article:modified_time" content="2021-04-10T14:38:58.102Z">
<meta property="article:author" content="joakim.liu">
<meta property="article:tag" content="flutter">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sat02pap001files.storage.live.com/y4mzy8_dvuO_7jpkfRcL_zpKQPzaxo5SWf7xWupP1dN-lR4kd9U5Z-UG7VVpscyQGF7iMkN6ijMHGd6VS5xe-Oc8cJ5pn3-MDVTgn-7Ofeu5LUNkq8JbdlrhzjHkx7vSWZNXT7llmx5wNwpQdHXKPDJi8Gd0zjwISaK4eUHUZSn7WPjvJM2v-JpSKbwzi91ISeq?width=1510&height=298&cropmode=none">

<link rel="canonical" href="http://example.com/2021/04/07/flutter-source-code-ios-platform-channels/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iOS Flutter Platform Channel | 牛易疯先森的开发记录</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">牛易疯先森的开发记录</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/flutter-source-code-ios-platform-channels/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS Flutter Platform Channel
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-07 18:37:37" itemprop="dateCreated datePublished" datetime="2021-04-07T18:37:37+08:00">2021-04-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">flutter</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>本文基于 flutter 1.22.2 源码，在 ios_debug_unopt 产物下调试。</p>
</blockquote>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文下面的 demo(来自 <a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a>) 和 flutter 源码来分析 ios platform channels 的实现。</p>
<h2 id="1-1-demo"><a href="#1-1-demo" class="headerlink" title="1.1 demo"></a>1.1 demo</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:async&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/services.dart&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> platform = <span class="keyword">const</span> MethodChannel(<span class="string">&#x27;samples.flutter.dev/battery&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get battery level.</span></span><br><span class="line">  <span class="built_in">String</span> _batteryLevel = <span class="string">&#x27;Unknown battery level.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; _getBatteryLevel() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">String</span> batteryLevel;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">int</span> result = <span class="keyword">await</span> platform.invokeMethod(<span class="string">&#x27;getBatteryLevel&#x27;</span>);</span><br><span class="line">      batteryLevel = <span class="string">&#x27;Battery level at <span class="subst">$result</span> % .&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">on</span> PlatformException <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      batteryLevel = <span class="string">&quot;Failed to get battery level: &#x27;<span class="subst">$&#123;e.message&#125;</span>&#x27;.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _batteryLevel = batteryLevel;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Flutter&#x2F;Flutter.h&gt;</span><br><span class="line">#import &quot;GeneratedPluginRegistrant.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation AppDelegate</span><br><span class="line">- (BOOL)application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions &#123;</span><br><span class="line">  FlutterViewController* controller &#x3D; (FlutterViewController*)self.window.rootViewController;</span><br><span class="line"></span><br><span class="line">  FlutterMethodChannel* batteryChannel &#x3D; [FlutterMethodChannel</span><br><span class="line">                                          methodChannelWithName:@&quot;samples.flutter.dev&#x2F;battery&quot;</span><br><span class="line">                                          binaryMessenger:controller.binaryMessenger];</span><br><span class="line"></span><br><span class="line">  __weak typeof(self) weakSelf &#x3D; self;</span><br><span class="line">  [batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) &#123;</span><br><span class="line">      &#x2F;&#x2F; Note: this method is invoked on the UI thread.</span><br><span class="line">      if ([@&quot;getBatteryLevel&quot; isEqualToString:call.method]) &#123;</span><br><span class="line">        int batteryLevel &#x3D; [weakSelf getBatteryLevel];</span><br><span class="line">        </span><br><span class="line">        if (batteryLevel &#x3D;&#x3D; -1) &#123;</span><br><span class="line">          result([FlutterError errorWithCode:@&quot;UNAVAILABLE&quot;</span><br><span class="line">                                     message:@&quot;Battery info unavailable&quot;</span><br><span class="line">                                     details:nil]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          result(@(batteryLevel));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        result(FlutterMethodNotImplemented);</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line">  [GeneratedPluginRegistrant registerWithRegistry:self];</span><br><span class="line">  return [super application:application didFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)getBatteryLevel &#123;</span><br><span class="line">  UIDevice* device &#x3D; UIDevice.currentDevice;</span><br><span class="line">  device.batteryMonitoringEnabled &#x3D; YES;</span><br><span class="line">  if (device.batteryState &#x3D;&#x3D; UIDeviceBatteryStateUnknown) &#123;</span><br><span class="line">    return -1;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return (int)(device.batteryLevel * 100);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-Dart-层"><a href="#2-Dart-层" class="headerlink" title="2. Dart 层"></a>2. Dart 层</h1><h2 id="2-1-MethodChannel-初始化"><a href="#2-1-MethodChannel-初始化" class="headerlink" title="2.1 MethodChannel 初始化"></a>2.1 MethodChannel 初始化</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A named channel for communicating with platform plugins using asynchronous method calls.</span></span></span><br><span class="line"><span class="keyword">const</span> MethodChannel(<span class="keyword">this</span>.name, [<span class="keyword">this</span>.codec = <span class="keyword">const</span> StandardMethodCodec(), BinaryMessenger? binaryMessenger ])</span><br><span class="line">      : <span class="keyword">assert</span>(name != <span class="keyword">null</span>),</span><br><span class="line">        <span class="keyword">assert</span>(codec != <span class="keyword">null</span>),</span><br><span class="line">        _binaryMessenger = binaryMessenger;</span><br></pre></td></tr></table></figure>
<p>初始化，默认是使用标准编解码器 <code>StandardMethodCodec</code>，在发送到 <code>platform plugin</code> 要使用 <code>codec</code> 进行编码，同样 <code>platform plugin</code> 发送过来的消息要解码成 Dart 层的数据。所以，<code>platform plugin</code> 那边需要兼容 Dart 层的 <code>codec</code>。</p>
<h2 id="2-2-MessageCodec-抽象类"><a href="#2-2-MessageCodec-抽象类" class="headerlink" title="2.2 MessageCodec 抽象类"></a>2.2 MessageCodec 抽象类</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A message encoding/decoding mechanism.</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCodec</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  ByteData? encodeMessage(T message);</span><br><span class="line">  T decodeMessage(ByteData? message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StandardMethodCodec</code> 实现了抽象类 <code>MessageCodec</code> 的编解码方法。</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mzy8_dvuO_7jpkfRcL_zpKQPzaxo5SWf7xWupP1dN-lR4kd9U5Z-UG7VVpscyQGF7iMkN6ijMHGd6VS5xe-Oc8cJ5pn3-MDVTgn-7Ofeu5LUNkq8JbdlrhzjHkx7vSWZNXT7llmx5wNwpQdHXKPDJi8Gd0zjwISaK4eUHUZSn7WPjvJM2v-JpSKbwzi91ISeq?width=1510&height=298&cropmode=none" alt="-w755"></p>
<p>从上图可知，目标有四个类实现了 <code>MessageCodec</code> 。</p>
<ul>
<li>BinaryCodec: [MessageCodec] with unencoded binary messages represented using [ByteData]. // 没编码的原始二进制数据类型 </li>
<li>JSONMessageCodec: [MessageCodec] with UTF-8 encoded JSON messages. // utf-8 编码的 json 消息</li>
<li>StandardMessageCodec: [MessageCodec] using the Flutter standard binary encoding. // flutter 标准的二进制编码，可以参考 <a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a> 的 <code>Platform channel data types support and codecs</code> 小节，当然 <code>class StandardMessageCodec implements MessageCodec&lt;dynamic&gt; &#123;</code> 定义上面的注释也有解释。</li>
<li>StringCodec: [MessageCodec] with UTF-8 encoded String messages. // utf-8 编码的字符串消息 </li>
</ul>
<h2 id="2-3-invokeMethod"><a href="#2-3-invokeMethod" class="headerlink" title="2.3 invokeMethod"></a>2.3 invokeMethod</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T?&gt; invokeMethod&lt;T&gt;(<span class="built_in">String</span> method, [ <span class="built_in">dynamic</span> arguments ]) &#123;</span><br><span class="line">    <span class="keyword">return</span> _invokeMethod&lt;T&gt;(method, missingOk: <span class="keyword">false</span>, arguments: arguments);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T?&gt; _invokeMethod&lt;T&gt;(<span class="built_in">String</span> method, &#123; <span class="keyword">required</span> <span class="built_in">bool</span> missingOk, <span class="built_in">dynamic</span> arguments &#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span>(method != <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 见 2.6</span></span><br><span class="line">    <span class="keyword">final</span> ByteData? result = <span class="keyword">await</span> binaryMessenger.send(</span><br><span class="line">      name,</span><br><span class="line">      codec.encodeMethodCall(MethodCall(method, arguments)),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (missingOk) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> MissingPluginException(<span class="string">&#x27;No implementation found for method <span class="subst">$method</span> on channel <span class="subst">$name</span>&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 [6.6]</span></span><br><span class="line">    <span class="keyword">return</span> codec.decodeEnvelope(result) <span class="keyword">as</span> T;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
<ol>
<li>创建 MethodCall 对象[见 2.3.1]</li>
<li>调用 StandardMessageCodec 的 encodeMethodCall, 将 MethodCall 对象编码成 ByteData 数据[见 2.3.2]</li>
<li>调用 BinaryMessenger 来发送 ByteData 数据 [见 2.4]</li>
<li>调用 StandardMessageCodec 的 decodeEnvelope, 将发送返回后的结果进行解码</li>
</ol>
<h3 id="2-3-1-MethodCall初始化"><a href="#2-3-1-MethodCall初始化" class="headerlink" title="2.3.1 MethodCall初始化"></a>2.3.1 MethodCall初始化</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MethodCall(<span class="keyword">this</span>.method, [<span class="keyword">this</span>.arguments])</span><br><span class="line">    : <span class="keyword">assert</span>(method != <span class="keyword">null</span>); <span class="comment">// 方法名，非空</span></span><br></pre></td></tr></table></figure>
<p>这里的参数就是 <code>invokeMethod</code> 方法的入参 <code>method</code> 和 <code>arguments</code> 。</p>
<h3 id="2-3-2-encodeMethodCall"><a href="#2-3-2-encodeMethodCall" class="headerlink" title="2.3.2 encodeMethodCall"></a>2.3.2 encodeMethodCall</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<p>来自抽象类 <code>MethodCodec</code>, 对方法调用和结果进行编解码。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A codec for method calls and enveloped results.</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCodec</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes the specified [methodCall] into binary.</span></span></span><br><span class="line">  ByteData encodeMethodCall(MethodCall methodCall);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Decodes the specified [methodCall] from binary.</span></span></span><br><span class="line">  MethodCall decodeMethodCall(ByteData? methodCall);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Decodes the specified result [envelope] from binary.</span></span></span><br><span class="line">  <span class="built_in">dynamic</span> decodeEnvelope(ByteData envelope);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes a successful [result] into a binary envelope.</span></span></span><br><span class="line">  ByteData encodeSuccessEnvelope(<span class="built_in">dynamic</span> result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes an error result into a binary envelope.</span></span></span><br><span class="line">  ByteData encodeErrorEnvelope(&#123; <span class="keyword">required</span> <span class="built_in">String</span> code, <span class="built_in">String?</span> message, <span class="built_in">dynamic</span> details&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codecs.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">ByteData encodeMethodCall(MethodCall call) &#123;</span><br><span class="line">    <span class="comment">// 创建一个写buffer, 见 [2.3.3]</span></span><br><span class="line">    <span class="keyword">final</span> WriteBuffer buffer = WriteBuffer();</span><br><span class="line">    <span class="comment">// 调用 StandardMessageCodec 的 writeValue 方法，将数据写入 buffer</span></span><br><span class="line">    messageCodec.writeValue(buffer, call.method);</span><br><span class="line">    messageCodec.writeValue(buffer, call.arguments);</span><br><span class="line">    <span class="keyword">return</span> buffer.done();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-WriteBuffer"><a href="#2-3-3-WriteBuffer" class="headerlink" title="2.3.3 WriteBuffer"></a>2.3.3 WriteBuffer</h3><blockquote>
<p>flutter/packages/flutter/lib/src/foundation/serialization.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WriteBuffer()</span><br><span class="line">    : _buffer = Uint8Buffer(),</span><br><span class="line">      _eightBytes = ByteData(<span class="number">8</span>) &#123;</span><br><span class="line">    _eightBytesAsList = _eightBytes.buffer.asUint8List();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> ByteData done() &#123;</span><br><span class="line">    <span class="keyword">final</span> ByteData result = _buffer!.buffer.asByteData(<span class="number">0</span>, _buffer!.lengthInBytes);</span><br><span class="line">    _buffer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 返回最后的写入结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<h2 id="2-4-binaryMessenger-send"><a href="#2-4-binaryMessenger-send" class="headerlink" title="2.4 binaryMessenger.send"></a>2.4 binaryMessenger.send</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BinaryMessenger <span class="keyword">get</span> binaryMessenger =&gt; _binaryMessenger ?? defaultBinaryMessenger;</span><br><span class="line"></span><br><span class="line">BinaryMessenger <span class="keyword">get</span> defaultBinaryMessenger &#123;</span><br><span class="line">  <span class="keyword">assert</span>(() &#123;</span><br><span class="line">    <span class="keyword">if</span> (ServicesBinding.instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> FlutterError(</span><br><span class="line">        <span class="string">&#x27;ServicesBinding.defaultBinaryMessenger was accessed before the &#x27;</span></span><br><span class="line">        <span class="string">&#x27;binding was initialized.\n&#x27;</span></span><br><span class="line">        <span class="string">&quot;If you&#x27;re running an application and need to access the binary &quot;</span></span><br><span class="line">        <span class="string">&#x27;messenger before `runApp()` has been called (for example, during &#x27;</span></span><br><span class="line">        <span class="string">&#x27;plugin initialization), then you need to explicitly call the &#x27;</span></span><br><span class="line">        <span class="string">&#x27;`WidgetsFlutterBinding.ensureInitialized()` first.\n&#x27;</span></span><br><span class="line">        <span class="string">&quot;If you&#x27;re running a test, you can call the &quot;</span></span><br><span class="line">        <span class="string">&#x27;`TestWidgetsFlutterBinding.ensureInitialized()` as the first line in &#x27;</span></span><br><span class="line">        <span class="string">&quot;your test&#x27;s `main()` method to initialize the binding.&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;());</span><br><span class="line">  <span class="comment">// 见 [2.4.1]</span></span><br><span class="line">  <span class="keyword">return</span> ServicesBinding.instance!.defaultBinaryMessenger;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>MethodChannel</code> 初始化的时候没有传 <code>BinaryMessenger</code> 对象，所以这里是用的默认值：<code>ServicesBinding.instance!.defaultBinaryMessenger</code>.</p>
<h3 id="2-4-1-sendPlatformMessage"><a href="#2-4-1-sendPlatformMessage" class="headerlink" title="2.4.1 _sendPlatformMessage"></a>2.4.1 _sendPlatformMessage</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/binding.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DefaultBinaryMessenger</span> <span class="keyword">extends</span> <span class="title">BinaryMessenger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _DefaultBinaryMessenger._();</span><br><span class="line">  Future&lt;ByteData?&gt; _sendPlatformMessage(<span class="built_in">String</span> channel, ByteData? message) &#123;</span><br><span class="line">    <span class="comment">// 见 [2.4.2]</span></span><br><span class="line">    <span class="keyword">final</span> Completer&lt;ByteData?&gt; completer = Completer&lt;ByteData?&gt;();</span><br><span class="line">    <span class="comment">// ui.window is accessed directly instead of using ServicesBinding.instance.window</span></span><br><span class="line">    <span class="comment">// because this method might be invoked before any binding is initialized.</span></span><br><span class="line">    <span class="comment">// This issue was reported in #27541. It is not ideal to statically access</span></span><br><span class="line">    <span class="comment">// ui.window because the Window may be dependency injected elsewhere with</span></span><br><span class="line">    <span class="comment">// a different instance. However, static access at this location seems to be</span></span><br><span class="line">    <span class="comment">// the least bad option.</span></span><br><span class="line">    <span class="comment">// 见 [2.5]</span></span><br><span class="line">    ui.<span class="built_in">window</span>.sendPlatformMessage(channel, message, (ByteData? reply) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 见 [3.1.1], 会在 engine 层保存起来</span></span><br><span class="line">        completer.complete(reply);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-2-Completer-初始化"><a href="#2-4-2-Completer-初始化" class="headerlink" title="2.4.2 Completer 初始化"></a>2.4.2 Completer 初始化</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/async/future.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 见 [2.4.3]</span></span><br><span class="line"><span class="keyword">factory</span> Completer() =&gt; <span class="keyword">new</span> _AsyncCompleter&lt;T&gt;();</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-AsyncCompleter-初始化"><a href="#2-4-3-AsyncCompleter-初始化" class="headerlink" title="2.4.3 _AsyncCompleter 初始化"></a>2.4.3 _AsyncCompleter 初始化</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/async/future_impl.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">_Completer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Completer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _Future&lt;T&gt; future = <span class="keyword">new</span> _Future&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> complete([FutureOr&lt;T&gt;? value]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _completeError(<span class="built_in">Object</span> error, StackTrace stackTrace);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The future&#x27;s _isComplete doesn&#x27;t take into account pending completions.</span></span><br><span class="line">  <span class="comment">// We therefore use _mayComplete.</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isCompleted =&gt; !future._mayComplete;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AsyncCompleter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">_Completer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> complete([FutureOr&lt;T&gt;? value]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!future._mayComplete) <span class="keyword">throw</span> <span class="keyword">new</span> StateError(<span class="string">&quot;Future already completed&quot;</span>);</span><br><span class="line">    <span class="comment">// 见 [6.5]</span></span><br><span class="line">    future._asyncComplete(value == <span class="keyword">null</span> ? value <span class="keyword">as</span> <span class="built_in">dynamic</span> : value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-window-sendPlatformMessage"><a href="#2-5-window-sendPlatformMessage" class="headerlink" title="2.5 window.sendPlatformMessage"></a>2.5 window.sendPlatformMessage</h2><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/ui/window.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                         ByteData? data,</span><br><span class="line">                         PlatformMessageResponseCallback? callback) &#123;</span><br><span class="line">  <span class="comment">// 见[2.5.1]</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> error =</span><br><span class="line">      _sendPlatformMessage(name, _zonedPlatformMessageResponseCallback(callback), data); </span><br><span class="line">  <span class="keyword">if</span> (error != <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> Exception(error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 见 [3.1]</span></span><br><span class="line"><span class="built_in">String?</span> _sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                            PlatformMessageResponseCallback? callback,</span><br><span class="line">                            ByteData? data) native <span class="string">&#x27;PlatformConfiguration_sendPlatformMessage&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><code>_sendPlatformMessage</code> 是一个 Native 代码，会调用到引擎层。</p>
<h3 id="2-5-1-zonedPlatformMessageResponseCallback"><a href="#2-5-1-zonedPlatformMessageResponseCallback" class="headerlink" title="2.5.1 _zonedPlatformMessageResponseCallback"></a>2.5.1 _zonedPlatformMessageResponseCallback</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/ui/window.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">Wraps the given [callback] in another callback that ensures that the</span></span></span><br><span class="line">  <span class="comment">/// <span class="markdown">original callback is called in the zone it was registered in.</span></span></span><br><span class="line">  <span class="keyword">static</span> PlatformMessageResponseCallback? _zonedPlatformMessageResponseCallback(PlatformMessageResponseCallback? callback) &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the zone in which the callback is being registered.</span></span><br><span class="line">    <span class="keyword">final</span> Zone registrationZone = Zone.current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (ByteData? data) &#123;</span><br><span class="line">      registrationZone.runUnaryGuarded(callback, data);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>将当前注册回调的 <code>Zone.current</code> 存起来。</p>
<h1 id="3-engine-层"><a href="#3-engine-层" class="headerlink" title="3. engine 层"></a>3. engine 层</h1><h2 id="3-1-SendPlatformMessage"><a href="#3-1-SendPlatformMessage" class="headerlink" title="3.1 _SendPlatformMessage"></a>3.1 _SendPlatformMessage</h2><blockquote>
<p>engine/src/flutter/lib/ui/window/platform_configuration.cc</p>
</blockquote>
<p>在 flutter 源码中搜索 <code>_sendPlatformMessage</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_configuration.cc -L137</span></span><br><span class="line"><span class="keyword">void</span> _SendPlatformMessage(Dart_NativeArguments args) &#123;</span><br><span class="line">  tonic::DartCallStatic(&amp;SendPlatformMessage, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// platform_configuration.cc -L105</span></span><br><span class="line"><span class="function">Dart_Handle <span class="title">SendPlatformMessage</span><span class="params">(Dart_Handle window,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle data_handle)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取当前 dart_state                               </span></span><br><span class="line">  UIDartState* dart_state = UIDartState::Current();</span><br><span class="line">  <span class="comment">// 没有 platform_configuration, 抛出异常</span></span><br><span class="line">  <span class="keyword">if</span> (!dart_state-&gt;platform_configuration()) &#123;</span><br><span class="line">    <span class="keyword">return</span> tonic::ToDart(</span><br><span class="line">        <span class="string">&quot;Platform messages can only be sent from the main isolate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fml::RefPtr&lt;PlatformMessageResponse&gt; response;</span><br><span class="line">  <span class="keyword">if</span> (!Dart_IsNull(callback)) &#123;</span><br><span class="line">    <span class="comment">// 见 [3.1.1] 和 [3.1.2]</span></span><br><span class="line">    response = fml::MakeRefCounted&lt;PlatformMessageResponseDart&gt;(</span><br><span class="line">        tonic::DartPersistentValue(dart_state, callback),</span><br><span class="line">        dart_state-&gt;GetTaskRunners().GetUITaskRunner());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsNull(data_handle)) &#123;</span><br><span class="line">    dart_state-&gt;platform_configuration()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(name, response));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tonic::DartByteData data(data_handle);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* buffer = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(data.data());</span><br><span class="line">    <span class="comment">// 见 [3.2]</span></span><br><span class="line">    dart_state-&gt;platform_configuration()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(</span><br><span class="line">            name, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;(buffer, buffer + data.length_in_bytes()),</span><br><span class="line">            response));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Dart_Null();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
<ol>
<li>发送平台消息，只允许在主 isolate 中发出，否则会抛出异常</li>
<li>相关参数<ol>
<li>window: Dart 层的 window</li>
<li>name: channel 名</li>
<li>callback: 见 [3.1.1] 的描述</li>
<li>data_handle: 编码后的 <code>MethodCall</code> 对象，也就是待执行的方法和参数，后续赋值给 PlatformMessage 对象的 data 成员变量</li>
</ol>
</li>
<li>创建 PlatformMessageResponseDart 对象，保存 callback 和 GetUITaskRunner</li>
<li>调用 RuntimeController 的 HandlePlatformMessage 方法，入参为 PlatformMessage, 见 [3.1.3]</li>
</ol>
<h3 id="3-1-1-DartPersistentValue"><a href="#3-1-1-DartPersistentValue" class="headerlink" title="3.1.1 DartPersistentValue"></a>3.1.1 DartPersistentValue</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dart_persistent_value.cc -L20</span></span><br><span class="line">DartPersistentValue::DartPersistentValue(DartState* dart_state,</span><br><span class="line">                                         Dart_Handle value)</span><br><span class="line">    : value_(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">  Set(dart_state, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dart_persistent_value.cc -L30</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DartPersistentValue::Set</span><span class="params">(DartState* dart_state, Dart_Handle value)</span> </span>&#123;</span><br><span class="line">  TONIC_DCHECK(is_empty());</span><br><span class="line">  dart_state_ = dart_state-&gt;GetWeakPtr();</span><br><span class="line">  value_ = Dart_NewPersistentHandle(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>dart_state</code> 和 <code>callback</code> 封装成 <code>DartPersistentValue</code> 对象，这里的 <code>callback</code> 就是 [2.4] 中的 <code>completer.complete(reply);</code>，处理发送返回的数据。</p>
<h3 id="3-1-2-PlatformMessageResponseDart-初始化"><a href="#3-1-2-PlatformMessageResponseDart-初始化" class="headerlink" title="3.1.2 PlatformMessageResponseDart 初始化"></a>3.1.2 PlatformMessageResponseDart 初始化</h3><blockquote>
<p>engine/src/flutter/lib/ui/window/platform_message_response_dart.cc</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PlatformMessageResponseDart::PlatformMessageResponseDart(</span><br><span class="line">    tonic::DartPersistentValue callback,</span><br><span class="line">    fml::RefPtr&lt;fml::TaskRunner&gt; ui_task_runner)</span><br><span class="line">    : callback_(<span class="built_in">std</span>::move(callback)),</span><br><span class="line">      ui_task_runner_(<span class="built_in">std</span>::move(ui_task_runner)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>简单的赋初始值。</p>
<h3 id="3-1-3-PlatformMessage-初始化"><a href="#3-1-3-PlatformMessage-初始化" class="headerlink" title="3.1.3 PlatformMessage 初始化"></a>3.1.3 PlatformMessage 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message.cc -L11</span></span><br><span class="line">PlatformMessage::PlatformMessage(<span class="built_in">std</span>::<span class="built_in">string</span> channel,</span><br><span class="line">                                 <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; data,</span><br><span class="line">                                 fml::RefPtr&lt;PlatformMessageResponse&gt; response)</span><br><span class="line">    : channel_(<span class="built_in">std</span>::move(channel)),</span><br><span class="line">      data_(<span class="built_in">std</span>::move(data)),</span><br><span class="line">      hasData_(<span class="literal">true</span>),</span><br><span class="line">      response_(<span class="built_in">std</span>::move(response)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>该方法相关入参</p>
<ul>
<li>channel: channel 名</li>
<li>data: data_handle(见 [3.1] 的描述) 转换后的值</li>
<li>response: 见 [3.1.1], 对 <code>3.1.1</code> 和 <code>callback</code> 的封装</li>
</ul>
<p>至此， Dart 层传过来的数据以及在 engine 层转换后的数据，都封装在了 <code>PlatformMessage</code> 对象中，后续在 engine 层都是操作该 <code>PlatformMessage</code> 对象。</p>
<h2 id="3-2-RuntimeController-HandlePlatformMessage"><a href="#3-2-RuntimeController-HandlePlatformMessage" class="headerlink" title="3.2 RuntimeController::HandlePlatformMessage"></a>3.2 RuntimeController::HandlePlatformMessage</h2><blockquote>
<p>engine/src/flutter/runtime/runtime_controller.cc </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |PlatformConfigurationClient|</span></span><br><span class="line"><span class="comment">// runtime_controller.cc -L328</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RuntimeController::HandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 3.3 </span></span><br><span class="line">  client_.HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>note: 这块的逻辑代码需要了解 flutter 的引擎启动。</p>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime_controller.cc -L64</span></span><br><span class="line">RuntimeController::RuntimeController(</span><br><span class="line">    RuntimeDelegate&amp; p_client,</span><br><span class="line">    DartVM* p_vm,</span><br><span class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; p_isolate_snapshot,</span><br><span class="line">    TaskRunners p_task_runners,</span><br><span class="line">    fml::WeakPtr&lt;SnapshotDelegate&gt; p_snapshot_delegate,</span><br><span class="line">    fml::WeakPtr&lt;HintFreedDelegate&gt; p_hint_freed_delegate,</span><br><span class="line">    fml::WeakPtr&lt;IOManager&gt; p_io_manager,</span><br><span class="line">    fml::RefPtr&lt;SkiaUnrefQueue&gt; p_unref_queue,</span><br><span class="line">    fml::WeakPtr&lt;ImageDecoder&gt; p_image_decoder,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_uri,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_entrypoint,</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">int64_t</span>)&gt;&amp; idle_notification_callback,</span><br><span class="line">    <span class="keyword">const</span> PlatformData&amp; p_platform_data,</span><br><span class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_create_callback,</span><br><span class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_shutdown_callback,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="keyword">const</span> fml::Mapping&gt; p_persistent_isolate_data)</span><br><span class="line">    : client_(p_client),</span><br><span class="line">      vm_(p_vm),</span><br><span class="line">      isolate_snapshot_(<span class="built_in">std</span>::move(p_isolate_snapshot)),</span><br><span class="line">      task_runners_(p_task_runners),</span><br><span class="line">      snapshot_delegate_(p_snapshot_delegate),</span><br><span class="line">      hint_freed_delegate_(p_hint_freed_delegate),</span><br><span class="line">      io_manager_(p_io_manager),</span><br><span class="line">      unref_queue_(p_unref_queue),</span><br><span class="line">      image_decoder_(p_image_decoder),</span><br><span class="line">      advisory_script_uri_(p_advisory_script_uri),</span><br><span class="line">      advisory_script_entrypoint_(p_advisory_script_entrypoint),</span><br><span class="line">      idle_notification_callback_(idle_notification_callback),</span><br><span class="line">      platform_data_(<span class="built_in">std</span>::move(p_platform_data)),</span><br><span class="line">      isolate_create_callback_(p_isolate_create_callback),</span><br><span class="line">      isolate_shutdown_callback_(p_isolate_shutdown_callback),</span><br><span class="line">      persistent_isolate_data_(<span class="built_in">std</span>::move(p_persistent_isolate_data)) &#123;</span><br><span class="line">  <span class="comment">// Create the root isolate as soon as the runtime controller is initialized.</span></span><br><span class="line">  <span class="comment">// It will be run at a later point when the engine provides a run</span></span><br><span class="line">  <span class="comment">// configuration and then runs the isolate.</span></span><br><span class="line">  <span class="keyword">auto</span> strong_root_isolate =</span><br><span class="line">      DartIsolate::CreateRootIsolate(</span><br><span class="line">          vm_-&gt;GetVMData()-&gt;GetSettings(),                <span class="comment">//</span></span><br><span class="line">          isolate_snapshot_,                              <span class="comment">//</span></span><br><span class="line">          task_runners_,                                  <span class="comment">//</span></span><br><span class="line">          <span class="built_in">std</span>::make_unique&lt;PlatformConfiguration&gt;(<span class="keyword">this</span>),  <span class="comment">//</span></span><br><span class="line">          snapshot_delegate_,                             <span class="comment">//</span></span><br><span class="line">          hint_freed_delegate_,                           <span class="comment">//</span></span><br><span class="line">          io_manager_,                                    <span class="comment">//</span></span><br><span class="line">          unref_queue_,                                   <span class="comment">//</span></span><br><span class="line">          image_decoder_,                                 <span class="comment">//</span></span><br><span class="line">          p_advisory_script_uri,                          <span class="comment">//</span></span><br><span class="line">          p_advisory_script_entrypoint,                   <span class="comment">//</span></span><br><span class="line">          <span class="literal">nullptr</span>,                                        <span class="comment">//</span></span><br><span class="line">          isolate_create_callback_,                       <span class="comment">//</span></span><br><span class="line">          isolate_shutdown_callback_                      <span class="comment">//</span></span><br><span class="line">          )</span><br><span class="line">          .lock();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;PlatformConfiguration&gt;(this)</code>: 将当前 <code>RuntimeController</code> 对象作为入参初始化 <code>PlatformConfiguration</code> 对象(赋值给 <code>client_</code> 成员变量)。</p>
<h2 id="3-3-Engine-HandlePlatformMessage"><a href="#3-3-Engine-HandlePlatformMessage" class="headerlink" title="3.3 Engine::HandlePlatformMessage"></a>3.3 Engine::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L496</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Engine::HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kAssetChannel) &#123;</span><br><span class="line">    HandleAssetPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 见 [3.4]</span></span><br><span class="line">    delegate_.OnEngineHandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L59</span></span><br><span class="line">Engine::Engine(Delegate&amp; delegate,</span><br><span class="line">               <span class="keyword">const</span> PointerDataDispatcherMaker&amp; dispatcher_maker,</span><br><span class="line">               DartVM&amp; vm,</span><br><span class="line">               fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</span><br><span class="line">               TaskRunners task_runners,</span><br><span class="line">               <span class="keyword">const</span> PlatformData platform_data,</span><br><span class="line">               Settings settings,</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Animator&gt; animator,</span><br><span class="line">               fml::WeakPtr&lt;IOManager&gt; io_manager,</span><br><span class="line">               fml::RefPtr&lt;SkiaUnrefQueue&gt; unref_queue,</span><br><span class="line">               fml::WeakPtr&lt;SnapshotDelegate&gt; snapshot_delegate)</span><br><span class="line">    : Engine(delegate,</span><br><span class="line">             dispatcher_maker,</span><br><span class="line">             vm.GetConcurrentWorkerTaskRunner(),</span><br><span class="line">             task_runners,</span><br><span class="line">             settings,</span><br><span class="line">             <span class="built_in">std</span>::move(animator),</span><br><span class="line">             io_manager,</span><br><span class="line">             <span class="literal">nullptr</span>) &#123;</span><br><span class="line">  runtime_controller_ = <span class="built_in">std</span>::make_unique&lt;RuntimeController&gt;(</span><br><span class="line">      *<span class="keyword">this</span>,                                 <span class="comment">// runtime delegate</span></span><br><span class="line">      &amp;vm,                                   <span class="comment">// VM</span></span><br><span class="line">      <span class="built_in">std</span>::move(isolate_snapshot),           <span class="comment">// isolate snapshot</span></span><br><span class="line">      task_runners_,                         <span class="comment">// task runners</span></span><br><span class="line">      <span class="built_in">std</span>::move(snapshot_delegate),          <span class="comment">// snapshot delegate</span></span><br><span class="line">      GetWeakPtr(),                          <span class="comment">// hint freed delegate</span></span><br><span class="line">      <span class="built_in">std</span>::move(io_manager),                 <span class="comment">// io manager</span></span><br><span class="line">      <span class="built_in">std</span>::move(unref_queue),                <span class="comment">// Skia unref queue</span></span><br><span class="line">      image_decoder_.GetWeakPtr(),           <span class="comment">// image decoder</span></span><br><span class="line">      settings_.advisory_script_uri,         <span class="comment">// advisory script uri</span></span><br><span class="line">      settings_.advisory_script_entrypoint,  <span class="comment">// advisory script entrypoint</span></span><br><span class="line">      settings_.idle_notification_callback,  <span class="comment">// idle notification callback</span></span><br><span class="line">      platform_data,                         <span class="comment">// platform data</span></span><br><span class="line">      settings_.isolate_create_callback,     <span class="comment">// isolate create callback</span></span><br><span class="line">      settings_.isolate_shutdown_callback,   <span class="comment">// isolate shutdown callback</span></span><br><span class="line">      settings_.persistent_isolate_data      <span class="comment">// persistent isolate data</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;RuntimeController&gt;(</code>: 将当前 <code>engine</code> 对象作为入参初始化 <code>RuntimeController</code> 对象(赋值给 <code>client_</code> 成员变量)。</p>
<h2 id="3-4-Shell-OnEngineHandlePlatformMessage"><a href="#3-4-Shell-OnEngineHandlePlatformMessage" class="headerlink" title="3.4 Shell::OnEngineHandlePlatformMessage"></a>3.4 Shell::OnEngineHandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |Engine::Delegate|</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Shell::OnEngineHandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  FML_DCHECK(is_setup_);</span><br><span class="line">  FML_DCHECK(task_runners_.GetUITaskRunner()-&gt;RunsTasksOnCurrentThread());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kSkiaChannel) &#123;</span><br><span class="line">    HandleEngineSkiaMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在 Platform 线程中执行任务  </span></span><br><span class="line">  task_runners_.GetPlatformTaskRunner()-&gt;PostTask(</span><br><span class="line">      [view = platform_view_-&gt;GetWeakPtr(), message = <span class="built_in">std</span>::move(message)]() &#123;</span><br><span class="line">        <span class="keyword">if</span> (view) &#123;</span><br><span class="line">          <span class="comment">// 见 [3.5]</span></span><br><span class="line">          view-&gt;HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L152</span></span><br><span class="line">  fml::TaskRunner::RunNowOrPostTask(</span><br><span class="line">      shell-&gt;GetTaskRunners().GetUITaskRunner(),</span><br><span class="line">      fml::MakeCopyable([&amp;engine_promise,                                 <span class="comment">//</span></span><br><span class="line">                         shell = shell.get(),                             <span class="comment">//</span></span><br><span class="line">                         &amp;dispatcher_maker,                               <span class="comment">//</span></span><br><span class="line">                         &amp;platform_data,                                  <span class="comment">//</span></span><br><span class="line">                         isolate_snapshot = <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">//</span></span><br><span class="line">                         vsync_waiter = <span class="built_in">std</span>::move(vsync_waiter),          <span class="comment">//</span></span><br><span class="line">                         &amp;weak_io_manager_future,                         <span class="comment">//</span></span><br><span class="line">                         &amp;snapshot_delegate_future,                       <span class="comment">//</span></span><br><span class="line">                         &amp;unref_queue_future                              <span class="comment">//</span></span><br><span class="line">  ]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">        TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;ShellSetupUISubsystem&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; task_runners = shell-&gt;GetTaskRunners();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The animator is owned by the UI thread but it gets its vsync pulses</span></span><br><span class="line">        <span class="comment">// from the platform.</span></span><br><span class="line">        <span class="keyword">auto</span> animator = <span class="built_in">std</span>::make_unique&lt;Animator&gt;(*shell, task_runners,</span><br><span class="line">                                                   <span class="built_in">std</span>::move(vsync_waiter));</span><br><span class="line"></span><br><span class="line">        engine_promise.set_value(<span class="built_in">std</span>::make_unique&lt;Engine&gt;(</span><br><span class="line">            *shell,                         <span class="comment">//</span></span><br><span class="line">            dispatcher_maker,               <span class="comment">//</span></span><br><span class="line">            *shell-&gt;GetDartVM(),            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">std</span>::move(isolate_snapshot),    <span class="comment">//</span></span><br><span class="line">            task_runners,                   <span class="comment">//</span></span><br><span class="line">            platform_data,                  <span class="comment">//</span></span><br><span class="line">            shell-&gt;GetSettings(),           <span class="comment">//</span></span><br><span class="line">            <span class="built_in">std</span>::move(animator),            <span class="comment">//</span></span><br><span class="line">            weak_io_manager_future.get(),   <span class="comment">//</span></span><br><span class="line">            unref_queue_future.get(),       <span class="comment">//</span></span><br><span class="line">            snapshot_delegate_future.get()  <span class="comment">//</span></span><br><span class="line">            ));</span><br><span class="line">      &#125;));</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;Engine&gt;(</code>: 将 <code>*shell</code> 指针作为入参初始化 <code>Engine</code> 对象(赋值给 <code>delegate_</code> 成员变量)。</p>
<h2 id="3-5-PlatformViewIOS-HandlePlatformMessage"><a href="#3-5-PlatformViewIOS-HandlePlatformMessage" class="headerlink" title="3.5 PlatformViewIOS::HandlePlatformMessage"></a>3.5 PlatformViewIOS::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |PlatformView|</span></span><br><span class="line"><span class="comment">// platform_view_ios.mm -L61</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformViewIOS::HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;flutter::PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 [3.6]</span></span><br><span class="line">  platform_message_router_.HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>platform_view_</p>
<p>相关调用链如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L544, 给 platform_view_ 赋值</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Shell::Setup</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PlatformView&gt; platform_view,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Engine&gt; engine,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Rasterizer&gt; rasterizer,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ShellIOManager&gt; io_manager)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  platform_view_ = <span class="built_in">std</span>::move(platform_view);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shell.cc -L167</span></span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; <span class="title">Shell::CreateShellOnPlatformThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    DartVMRef vm,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskRunners task_runners,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> PlatformData platform_data,</span></span></span><br><span class="line"><span class="function"><span class="params">    Settings settings,</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Shell::CreateCallback&lt;PlatformView&gt;&amp; on_create_platform_view,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Shell::CreateCallback&lt;Rasterizer&gt;&amp; on_create_rasterizer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取 platform_view</span></span><br><span class="line">    <span class="keyword">auto</span> platform_view = on_create_platform_view(*shell.get());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!shell-&gt;Setup(<span class="built_in">std</span>::move(platform_view),  <span class="comment">//</span></span><br><span class="line">                    engine_future.get(),       <span class="comment">//</span></span><br><span class="line">                    rasterizer_future.get(),   <span class="comment">//</span></span><br><span class="line">                    io_manager_future.get())   <span class="comment">//</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FlutterEngine.mm -L513</span></span><br><span class="line">- (BOOL)createShell:(NSString*)entrypoint</span><br><span class="line">         libraryURI:(NSString*)libraryURI</span><br><span class="line">       initialRoute:(NSString*)initialRoute &#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   <span class="comment">// on_create_platform_view 回调</span></span><br><span class="line">   flutter::Shell::CreateCallback&lt;flutter::PlatformView&gt; on_create_platform_view =</span><br><span class="line">      [](flutter::Shell&amp; shell) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;flutter::PlatformViewIOS&gt;(</span><br><span class="line">            shell, flutter::GetRenderingAPIForProcess(), shell.GetTaskRunners());</span><br><span class="line">      &#125;;      </span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-6-PlatformMessageRouter-HandlePlatformMessage"><a href="#3-6-PlatformMessageRouter-HandlePlatformMessage" class="headerlink" title="3.6 PlatformMessageRouter::HandlePlatformMessage"></a>3.6 PlatformMessageRouter::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_router.mm -L17</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageRouter::HandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;flutter::PlatformMessage&gt; message)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// [3.1.2] 中的 PlatformMessageResponseDart 对象  </span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessageResponse&gt; completer = message-&gt;response();</span><br><span class="line">  <span class="comment">// message-&gt;channel(): [3.1] 中的 channel 名</span></span><br><span class="line">  <span class="keyword">auto</span> it = message_handlers_.find(message-&gt;channel());</span><br><span class="line">  <span class="keyword">if</span> (it != message_handlers_.end()) &#123;</span><br><span class="line">    FlutterBinaryMessageHandler handler = it-&gt;second;</span><br><span class="line">    NSData* data = nil;</span><br><span class="line">    <span class="keyword">if</span> (message-&gt;hasData()) &#123;</span><br><span class="line">      <span class="comment">// 由 [3.1.3] 可知， message-&gt;data() 就是编码后的 `MethodCall` 对象</span></span><br><span class="line">      data = GetNSDataFromVector(message-&gt;data());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 [5.4]</span></span><br><span class="line">    handler(data, ^(NSData* reply) &#123;</span><br><span class="line">      <span class="keyword">if</span> (completer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">          <span class="comment">// 见 [6.1]</span></span><br><span class="line">          completer-&gt;Complete(GetMappingFromNSData(reply));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          completer-&gt;CompleteEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (completer) &#123;</span><br><span class="line">      completer-&gt;CompleteEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法注意功能：</p>
<ol>
<li>根据 channel 名在 message_handlers_ unordered_map 中找到对应的 FlutterBinaryMessageHandler 类型的 handler</li>
<li>调用 handler 回调方法获取 reply 数据</li>
<li>将 reply 数据作为入参，调用 PlatformMessageResponseDart 对象的 Complete 方法</li>
</ol>
<p>现在的问题是， FlutterBinaryMessageHandler 类型的 handler 是在哪里赋值的，也就是什么时候调用 [4.4] 的方法，详见下一小节：[4]。</p>
<h1 id="4-shell-层"><a href="#4-shell-层" class="headerlink" title="4. shell 层"></a>4. shell 层</h1><p>note: 这块的逻辑代码需要了解 flutter 的引擎启动。<br>在创建 engine 的时候，会设置 engine 层相关的 channel. </p>
<blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterEngine.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm  -L541</span></span><br><span class="line">- (BOOL)createShell:(NSString*)entrypoint</span><br><span class="line">         libraryURI:(NSString*)libraryURI</span><br><span class="line">       initialRoute:(NSString*)initialRoute &#123;</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">   <span class="comment">// 见 [4.1]</span></span><br><span class="line">   [self setupChannels];</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">   [self maybeSetupPlatformViewChannels];</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-1-setupChannels"><a href="#4-1-setupChannels" class="headerlink" title="4.1 setupChannels"></a>4.1 setupChannels</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterEngine.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L367</span></span><br><span class="line">- (<span class="keyword">void</span>)setupChannels &#123;</span><br><span class="line">  <span class="comment">// This will be invoked once the shell is done setting up and the isolate ID</span></span><br><span class="line">  <span class="comment">// for the UI isolate is available.</span></span><br><span class="line">  fml::WeakPtr&lt;FlutterEngine&gt; weakSelf = [self getWeakPtr];</span><br><span class="line">  <span class="comment">// 见 [4.2]</span></span><br><span class="line">  [_binaryMessenger setMessageHandlerOnChannel:@<span class="string">&quot;flutter/isolate&quot;</span></span><br><span class="line">                          binaryMessageHandler:^(NSData* message, FlutterBinaryReply reply) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (weakSelf) &#123;</span><br><span class="line">                              weakSelf.get().isolateId =</span><br><span class="line">                                  [[FlutterStringCodec sharedInstance] decode:message];</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;];</span><br><span class="line">  <span class="comment">// ...                          </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置 <code>flutter/isolate</code> channel。</p>
<h3 id="4-1-1-FlutterBinaryMessengerRelay-初始化"><a href="#4-1-1-FlutterBinaryMessengerRelay-初始化" class="headerlink" title="4.1.1 FlutterBinaryMessengerRelay 初始化"></a>4.1.1 FlutterBinaryMessengerRelay 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L132</span></span><br><span class="line">- (instancetype)initWithName:(NSString*)labelPrefix</span><br><span class="line">                     project:(FlutterDartProject*)project</span><br><span class="line">      allowHeadlessExecution:(BOOL)allowHeadlessExecution &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// 将当前 FlutterEngine 对象赋值给 FlutterBinaryMessengerRelay 对象 _binaryMessenger 的 parent 成员变量。</span></span><br><span class="line">      _binaryMessenger = [[FlutterBinaryMessengerRelay alloc] initWithParent:self];</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-setMessageHandlerOnChannel"><a href="#4-2-setMessageHandlerOnChannel" class="headerlink" title="4.2 setMessageHandlerOnChannel"></a>4.2 setMessageHandlerOnChannel</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterBinaryMessengerRelay.mm</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterBinaryMessengerRelay.mm -L42</span></span><br><span class="line">- (FlutterBinaryMessengerConnection)setMessageHandlerOnChannel:(NSString*)channel</span><br><span class="line">                                          binaryMessageHandler:</span><br><span class="line">                                              (FlutterBinaryMessageHandler)handler &#123;</span><br><span class="line">  <span class="keyword">if</span> (self.parent) &#123;</span><br><span class="line">    <span class="comment">// 见 [4.3]</span></span><br><span class="line">    <span class="keyword">return</span> [self.parent setMessageHandlerOnChannel:channel binaryMessageHandler:handler];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FML_LOG(WARNING) &lt;&lt; <span class="string">&quot;Communicating on a dead channel.&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-setMessageHandlerOnChannel"><a href="#4-3-setMessageHandlerOnChannel" class="headerlink" title="4.3 setMessageHandlerOnChannel"></a>4.3 setMessageHandlerOnChannel</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L730</span></span><br><span class="line">- (FlutterBinaryMessengerConnection)setMessageHandlerOnChannel:(NSString*)channel</span><br><span class="line">                                          binaryMessageHandler:</span><br><span class="line">                                              (FlutterBinaryMessageHandler)handler &#123;</span><br><span class="line">  NSParameterAssert(channel);</span><br><span class="line">  <span class="keyword">if</span> (_shell &amp;&amp; _shell-&gt;IsSetup()) &#123;</span><br><span class="line">    <span class="comment">// 见 [4.4]</span></span><br><span class="line">    self.iosPlatformView-&gt;GetPlatformMessageRouter().SetMessageHandler(channel.UTF8String, handler);</span><br><span class="line">    <span class="keyword">return</span> _connections-&gt;AquireConnection(channel.UTF8String);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    NSAssert(!handler, @<span class="string">&quot;Setting a message handler before the FlutterEngine has been run.&quot;</span>);</span><br><span class="line">    <span class="comment">// Setting a handler to nil for a not setup channel is a noop.</span></span><br><span class="line">    <span class="keyword">return</span> flutter::ConnectionCollection::MakeErrorConnection(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-PlatformMessageRouter-SetMessageHandler"><a href="#4-4-PlatformMessageRouter-SetMessageHandler" class="headerlink" title="4.4 PlatformMessageRouter::SetMessageHandler"></a>4.4 PlatformMessageRouter::SetMessageHandler</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_router.mm -L43</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageRouter::SetMessageHandler</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; channel,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              FlutterBinaryMessageHandler handler)</span> </span>&#123;</span><br><span class="line">  message_handlers_.erase(channel);</span><br><span class="line">  <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">    message_handlers_[channel] =</span><br><span class="line">        fml::ScopedBlock&lt;FlutterBinaryMessageHandler&gt;&#123;handler, fml::OwnershipPolicy::Retain&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-native-层"><a href="#5-native-层" class="headerlink" title="5. native 层"></a>5. native 层</h1><p>现在来看下 native 层的 Objective-C 的代码，来自 [1.1] 节。</p>
<h2 id="5-1-FlutterMethodChannel-初始化"><a href="#5-1-FlutterMethodChannel-初始化" class="headerlink" title="5.1 FlutterMethodChannel 初始化"></a>5.1 FlutterMethodChannel 初始化</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Source/FlutterChannels.mm</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L181</span></span><br><span class="line">+ (instancetype)methodChannelWithName:(NSString*)name</span><br><span class="line">                      binaryMessenger:(NSObject&lt;FlutterBinaryMessenger&gt;*)messenger &#123;</span><br><span class="line">  <span class="comment">// 见 [5.1.1]                    </span></span><br><span class="line">  NSObject&lt;FlutterMethodCodec&gt;* codec = [FlutterStandardMethodCodec sharedInstance];</span><br><span class="line">  <span class="comment">// 创建 FlutterMethodChannel 对象</span></span><br><span class="line">  <span class="keyword">return</span> [FlutterMethodChannel methodChannelWithName:name binaryMessenger:messenger codec:codec];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法注意功能</p>
<ol>
<li>入参<ol>
<li>name: channel 名</li>
<li>messenger: (FlutterViewController *)controller.binaryMessenger // 也就是 [4.1.1] 里面的对象</li>
</ol>
</li>
<li>创建 FlutterMethodChannel 对象，后面调用它的 <code>setMethodCallHandler</code> 来处理 Dart 层的调用方法 // 见 [5.2]</li>
</ol>
<h3 id="5-1-1-FlutterStandardMethodCodec"><a href="#5-1-1-FlutterStandardMethodCodec" class="headerlink" title="5.1.1 FlutterStandardMethodCodec"></a>5.1.1 FlutterStandardMethodCodec</h3><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Source/FlutterStandardCodec.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L60</span></span><br><span class="line">@implementation FlutterStandardMethodCodec &#123;</span><br><span class="line">  FlutterStandardReaderWriter* _readerWriter;</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)sharedInstance &#123;</span><br><span class="line">  <span class="keyword">static</span> id _sharedInstance = nil;</span><br><span class="line">  <span class="keyword">if</span> (!_sharedInstance) &#123;</span><br><span class="line">    <span class="comment">// 见 [5.1.2]</span></span><br><span class="line">    FlutterStandardReaderWriter* readerWriter =</span><br><span class="line">        [[[FlutterStandardReaderWriter alloc] init] autorelease];</span><br><span class="line">    _sharedInstance = [[FlutterStandardMethodCodec alloc] initWithReaderWriter:readerWriter];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _sharedInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2-FlutterMessageCodec"><a href="#5-1-2-FlutterMessageCodec" class="headerlink" title="5.1.2 FlutterMessageCodec"></a>5.1.2 FlutterMessageCodec</h3><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Headers/FlutterCodecs.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A factory of compatible reader/writer instances using the Flutter standard</span></span><br><span class="line"><span class="comment"> * binary encoding or extensions thereof.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FLUTTER_EXPORT</span><br><span class="line">@interface FlutterStandardReaderWriter : NSObject</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A message encoding/decoding mechanism.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FLUTTER_EXPORT</span><br><span class="line">@protocol FlutterMessageCodec</span><br></pre></td></tr></table></figure>
<p>上面的注释 <code>A message encoding/decoding mechanism.</code> 跟 [2.2] 是一样的，所以 <code>FlutterCodecs</code> 文件中的相关编解码类是跟 Dart 层是相对应的(Dart 层中 ByteData8 对应 iOS 中的 NSData)。</p>
<h2 id="5-2-setMethodCallHandler-方法"><a href="#5-2-setMethodCallHandler-方法" class="headerlink" title="5.2 setMethodCallHandler 方法"></a>5.2 setMethodCallHandler 方法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L231</span></span><br><span class="line">- (<span class="keyword">void</span>)setMethodCallHandler:(FlutterMethodCallHandler)handler &#123;</span><br><span class="line">  <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_connection &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      [_messenger cleanupConnection:_connection];</span><br><span class="line">      _connection = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [_messenger setMessageHandlerOnChannel:_name binaryMessageHandler:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Make sure the block captures the codec, not self.</span></span><br><span class="line">  NSObject&lt;FlutterMethodCodec&gt;* codec = _codec;</span><br><span class="line">  <span class="comment">// 见 [5.3], 这里 messageHandler 就是 [3.6] 中的 handler 。</span></span><br><span class="line">  FlutterBinaryMessageHandler messageHandler = ^(NSData* message, FlutterBinaryReply callback) &#123;</span><br><span class="line">    <span class="comment">// 见 [5.3.1]</span></span><br><span class="line">    FlutterMethodCall* call = [codec decodeMethodCall:message];</span><br><span class="line">    <span class="comment">// 见 [5.4]</span></span><br><span class="line">    handler(call, ^(id result) &#123;</span><br><span class="line">      <span class="keyword">if</span> (result == FlutterMethodNotImplemented)</span><br><span class="line">        callback(nil);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ([result isKindOfClass:[FlutterError class]])</span><br><span class="line">        <span class="comment">// 见 [5.3.2]</span></span><br><span class="line">        callback([codec encodeErrorEnvelope:(FlutterError*)result]);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 见 [5.3.3]</span></span><br><span class="line">        callback([codec encodeSuccessEnvelope:result]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 见 [4.2]</span></span><br><span class="line">  _connection = [_messenger setMessageHandlerOnChannel:_name binaryMessageHandler:messageHandler];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-messageHandler"><a href="#5-3-messageHandler" class="headerlink" title="5.3 messageHandler"></a>5.3 messageHandler</h2><p>由前面 [3.6] 可知，根据 channel 名(<code>samples.flutter.dev/battery</code>) 找到 FlutterBinaryMessageHandler 回调后，就会调用它，里面就是 NSData 和 FlutterMethodCall 的相互转换，见 [5.3.1 ~ 5.3.3] 小节。</p>
<h3 id="5-3-1-decodeMethodCall"><a href="#5-3-1-decodeMethodCall" class="headerlink" title="5.3.1 decodeMethodCall"></a>5.3.1 decodeMethodCall</h3><p>由 [5.1.1] 可知，在 <code>FlutterStandardMethodCodec</code> 中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L115</span></span><br><span class="line">- (FlutterMethodCall*)decodeMethodCall:(NSData*)message &#123;</span><br><span class="line">  FlutterStandardReader* reader = [_readerWriter readerWithData:message];</span><br><span class="line">  id value1 = [reader readValue];</span><br><span class="line">  id value2 = [reader readValue];</span><br><span class="line">  NSAssert(![reader hasMore], @<span class="string">&quot;Corrupted standard method call&quot;</span>);</span><br><span class="line">  NSAssert([value1 isKindOfClass:[NSString class]], @<span class="string">&quot;Corrupted standard method call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> [FlutterMethodCall methodCallWithMethodName:value1 arguments:value2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将消息读出来，然后封装成 <code>FlutterMethodCall</code> 对象。</p>
<h3 id="5-3-2-encodeErrorEnvelope"><a href="#5-3-2-encodeErrorEnvelope" class="headerlink" title="5.3.2 encodeErrorEnvelope"></a>5.3.2 encodeErrorEnvelope</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L105</span></span><br><span class="line">- (NSData*)encodeErrorEnvelope:(FlutterError*)error &#123;</span><br><span class="line">  NSMutableData* data = [NSMutableData dataWithCapacity:<span class="number">32</span>];</span><br><span class="line">  FlutterStandardWriter* writer = [_readerWriter writerWithData:data];</span><br><span class="line">  [writer writeByte:<span class="number">1</span>];</span><br><span class="line">  [writer writeValue:error.code];</span><br><span class="line">  [writer writeValue:error.message];</span><br><span class="line">  [writer writeValue:error.details];</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 Error 组装成二进制数据。</p>
<h3 id="5-3-3-encodeSuccessEnvelope"><a href="#5-3-3-encodeSuccessEnvelope" class="headerlink" title="5.3.3 encodeSuccessEnvelope"></a>5.3.3 encodeSuccessEnvelope</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L97</span></span><br><span class="line">- (NSData*)encodeSuccessEnvelope:(id)result &#123;</span><br><span class="line">  NSMutableData* data = [NSMutableData dataWithCapacity:<span class="number">32</span>];</span><br><span class="line">  FlutterStandardWriter* writer = [_readerWriter writerWithData:data];</span><br><span class="line">  [writer writeByte:<span class="number">0</span>];</span><br><span class="line">  [writer writeValue:result];</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将成功数据组装成二进制数据。</p>
<h3 id="5-4-setMethodCallHandler-回调"><a href="#5-4-setMethodCallHandler-回调" class="headerlink" title="5.4 setMethodCallHandler 回调"></a>5.4 setMethodCallHandler 回调</h3><p>这里以 [1.1] 为例，就是获取当前电量值，然后回调 result，在通过 [5.3.3] 或 [5.3.4] 转成 NSData 后，作为入参给 Complete 调用（见[6.1]）。</p>
<h1 id="6-回传结果"><a href="#6-回传结果" class="headerlink" title="6. 回传结果"></a>6. 回传结果</h1><h2 id="6-1-PlatformMessageResponseDart-Complete"><a href="#6-1-PlatformMessageResponseDart-Complete" class="headerlink" title="6.1 PlatformMessageResponseDart::Complete"></a>6.1 PlatformMessageResponseDart::Complete</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_dart.cc -L30</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageResponseDart::Complete</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;fml::Mapping&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (callback_.is_empty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  FML_DCHECK(!is_complete_);</span><br><span class="line">  is_complete_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 在 UI 线程中执行任务</span></span><br><span class="line">  ui_task_runner_-&gt;PostTask(fml::MakeCopyable(</span><br><span class="line">      [callback = <span class="built_in">std</span>::move(callback_), data = <span class="built_in">std</span>::move(data)]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">        <span class="comment">// callback_ 见 [3.1.1] 的赋初始值</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;tonic::DartState&gt; dart_state =</span><br><span class="line">            callback.dart_state().lock();</span><br><span class="line">        <span class="keyword">if</span> (!dart_state) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tonic::DartState::Scope scope(dart_state);</span><br><span class="line">        <span class="comment">// 见 [6.2]</span></span><br><span class="line">        Dart_Handle byte_buffer =</span><br><span class="line">            tonic::DartByteData::Create(data-&gt;GetMapping(), data-&gt;GetSize());</span><br><span class="line">        <span class="comment">// 见 [6.3]    </span></span><br><span class="line">        tonic::DartInvoke(callback.Release(), &#123;byte_buffer&#125;);</span><br><span class="line">      &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-DartByteData-Create"><a href="#6-2-DartByteData-Create" class="headerlink" title="6.2 DartByteData::Create"></a>6.2 DartByteData::Create</h2><blockquote>
<p>engine/src/flutter/third_party/tonic/typed_data/dart_byte_data.cc </p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dart_Handle <span class="title">DartByteData::Create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">size_t</span> length)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (length &lt; kExternalSizeThreshold) &#123;</span><br><span class="line">    <span class="keyword">auto</span> handle = DartByteData&#123;data, length&#125;.dart_handle();</span><br><span class="line">    <span class="comment">// The destructor should release the typed data.</span></span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">void</span>* buf = ::<span class="built_in">malloc</span>(length);</span><br><span class="line">    TONIC_DCHECK(buf);</span><br><span class="line">    ::<span class="built_in">memcpy</span>(buf, data, length);</span><br><span class="line">    <span class="keyword">return</span> Dart_NewExternalTypedDataWithFinalizer(</span><br><span class="line">        Dart_TypedData_kByteData, buf, length, buf, length, FreeFinalizer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 [5.4.3] 或 [5.4.4] 返回的 NSData 转成 Dart 层的 Data 类型。</p>
<h2 id="6-3-DartInvoke"><a href="#6-3-DartInvoke" class="headerlink" title="6.3 DartInvoke"></a>6.3 DartInvoke</h2><blockquote>
<p>engine/src/flutter/third_party/tonic/logging/dart_invoke.cc </p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dart_Handle <span class="title">DartInvoke</span><span class="params">(Dart_Handle closure,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;Dart_Handle&gt; args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> argc = args.size();</span><br><span class="line">  Dart_Handle* argv = <span class="keyword">const_cast</span>&lt;Dart_Handle*&gt;(args.begin());</span><br><span class="line">  <span class="comment">// 见 [6.4]</span></span><br><span class="line">  Dart_Handle handle = Dart_InvokeClosure(closure, argc, argv);</span><br><span class="line">  LogIfError(handle);</span><br><span class="line">  <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-4-Dart-InvokeClosure"><a href="#6-4-Dart-InvokeClosure" class="headerlink" title="6.4 Dart_InvokeClosure"></a>6.4 Dart_InvokeClosure</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DART_EXPORT Dart_Handle <span class="title">Dart_InvokeClosure</span><span class="params">(Dart_Handle closure,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">int</span> number_of_arguments,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           Dart_Handle* arguments)</span> </span>&#123;</span><br><span class="line">  DARTSCOPE(Thread::Current());</span><br><span class="line">  API_TIMELINE_DURATION(T);</span><br><span class="line">  CHECK_CALLBACK_STATE(T);</span><br><span class="line">  <span class="keyword">const</span> Instance&amp; closure_obj = Api::UnwrapInstanceHandle(Z, closure);</span><br><span class="line">  <span class="keyword">if</span> (closure_obj.IsNull() || !closure_obj.IsCallable(<span class="literal">NULL</span>)) &#123;</span><br><span class="line">    RETURN_TYPE_ERROR(Z, closure, Instance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number_of_arguments &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Api::NewError(</span><br><span class="line">        <span class="string">&quot;%s expects argument &#x27;number_of_arguments&#x27; to be non-negative.&quot;</span>,</span><br><span class="line">        CURRENT_FUNC);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up arguments to include the closure as the first argument.</span></span><br><span class="line">  <span class="keyword">const</span> Array&amp; args = Array::Handle(Z, Array::New(number_of_arguments + <span class="number">1</span>));</span><br><span class="line">  Object&amp; obj = Object::Handle(Z);</span><br><span class="line">  args.SetAt(<span class="number">0</span>, closure_obj);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; number_of_arguments; i++) &#123;</span><br><span class="line">    obj = Api::UnwrapHandle(arguments[i]);</span><br><span class="line">    <span class="keyword">if</span> (!obj.IsNull() &amp;&amp; !obj.IsInstance()) &#123;</span><br><span class="line">      RETURN_TYPE_ERROR(Z, arguments[i], Instance);</span><br><span class="line">    &#125;</span><br><span class="line">    args.SetAt(i + <span class="number">1</span>, obj);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Now try to invoke the closure.</span></span><br><span class="line">  <span class="keyword">return</span> Api::NewHandle(T, DartEntry::InvokeClosure(args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 Closure 的回调，也就是前面 [3.1] 的 <code>callback</code>, 详见 [3.1.1] 的描述，最终会调用到 [2.4.1] 的回调，也就是 [2.4.3] 中的方法。</p>
<h2 id="6-5-asyncComplete"><a href="#6-5-asyncComplete" class="headerlink" title="6.5 _asyncComplete"></a>6.5 _asyncComplete</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// future_impl.dart -L540</span></span><br><span class="line"><span class="keyword">void</span> _asyncComplete(FutureOr&lt;T&gt; value) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(!_isComplete);</span><br><span class="line">    <span class="comment">// Two corner cases if the value is a future:</span></span><br><span class="line">    <span class="comment">//   1. the future is already completed and an error.</span></span><br><span class="line">    <span class="comment">//   2. the future is not yet completed but might become an error.</span></span><br><span class="line">    <span class="comment">// The first case means that we must not immediately complete the Future,</span></span><br><span class="line">    <span class="comment">// as our code would immediately start propagating the error without</span></span><br><span class="line">    <span class="comment">// giving the time to install error-handlers.</span></span><br><span class="line">    <span class="comment">// However the second case requires us to deal with the value immediately.</span></span><br><span class="line">    <span class="comment">// Otherwise the value could complete with an error and report an</span></span><br><span class="line">    <span class="comment">// unhandled error, even though we know we are already going to listen to</span></span><br><span class="line">    <span class="comment">// it.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">is</span> Future&lt;T&gt;) &#123;</span><br><span class="line">      _chainFuture(value);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(40014): Remove cast when type promotion works.</span></span><br><span class="line">    <span class="comment">// This would normally be `as T` but we use `as dynamic` to make the</span></span><br><span class="line">    <span class="comment">// unneeded check be implict to match dart2js unsound optimizations in the</span></span><br><span class="line">    <span class="comment">// user code.</span></span><br><span class="line">    _asyncCompleteWithValue(value <span class="keyword">as</span> <span class="built_in">dynamic</span>); <span class="comment">// Value promoted to T.</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里的 value 就是 [6.1] 的入参 data, 就是 [1.1] <code>setMethodCallHandler</code> 后回调的值，通过 Complete 异步调用后，最终会调用到 [6.6].</p>
<h2 id="6-6-decodeEnvelope"><a href="#6-6-decodeEnvelope" class="headerlink" title="6.6 decodeEnvelope"></a>6.6 decodeEnvelope</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// message_codecs.dart -L570</span></span><br><span class="line"><span class="built_in">dynamic</span> decodeEnvelope(ByteData envelope) &#123;</span><br><span class="line">    <span class="comment">// First byte is zero in success case, and non-zero otherwise.</span></span><br><span class="line">    <span class="keyword">if</span> (envelope.lengthInBytes == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Expected envelope, got nothing&#x27;</span>);</span><br><span class="line">    <span class="comment">// 创建 ReadBuffer 对象</span></span><br><span class="line">    <span class="keyword">final</span> ReadBuffer buffer = ReadBuffer(envelope);</span><br><span class="line">    <span class="keyword">if</span> (buffer.getUint8() == <span class="number">0</span>)</span><br><span class="line">      <span class="comment">// 见 [6.6.1]</span></span><br><span class="line">      <span class="keyword">return</span> messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorCode = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorMessage = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorDetails = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String?</span> errorStacktrace = (buffer.hasRemaining) ? messageCodec.readValue(buffer) <span class="keyword">as</span> <span class="built_in">String</span> : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (errorCode <span class="keyword">is</span> <span class="built_in">String</span> &amp;&amp; (errorMessage == <span class="keyword">null</span> || errorMessage <span class="keyword">is</span> <span class="built_in">String</span>) &amp;&amp; !buffer.hasRemaining)</span><br><span class="line">      <span class="keyword">throw</span> PlatformException(code: errorCode, message: errorMessage <span class="keyword">as</span> <span class="built_in">String</span>, details: errorDetails, stacktrace: errorStacktrace);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Invalid envelope&#x27;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-6-1-readValue"><a href="#6-6-1-readValue" class="headerlink" title="6.6.1 readValue"></a>6.6.1 readValue</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dynamic</span> readValue(ReadBuffer buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!buffer.hasRemaining)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Message corrupted&#x27;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> type = buffer.getUint8();</span><br><span class="line">    <span class="comment">// 转成 await 调用处需要的数据类型</span></span><br><span class="line">    <span class="keyword">return</span> readValueOfType(type, buffer);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-native-gt-dart"><a href="#7-native-gt-dart" class="headerlink" title="7. native -&gt; dart"></a>7. native -&gt; dart</h1><p>前面讲的是 dart 层异步调用 native 层，现在来讲下 native -&gt; dart 的大致逻辑，代码来自我们项目中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">    &#x2F;&#x2F; 见 [7.1]</span><br><span class="line">    [_channel invokeMethod:@&quot;didBeforeLoadRequest&quot; arguments:urlStr result:^(id  _Nullable result) &#123;</span><br><span class="line">        if ([result isKindOfClass:[NSNumber class]]) &#123;</span><br><span class="line">            if ([result boolValue]) &#123;</span><br><span class="line">                decisionHandler(WKNavigationActionPolicyAllow);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                decisionHandler(WKNavigationActionPolicyCancel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            decisionHandler(WKNavigationActionPolicyAllow);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-1-invokeMethod-arguments-result"><a href="#7-1-invokeMethod-arguments-result" class="headerlink" title="7.1 invokeMethod:arguments:result:"></a>7.1 invokeMethod:arguments:result:</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L219</span></span><br><span class="line">- (<span class="keyword">void</span>)invokeMethod:(NSString*)method arguments:(id)arguments result:(FlutterResult)callback &#123;</span><br><span class="line">  <span class="comment">// 初始化 FlutterMethodCall</span></span><br><span class="line">  FlutterMethodCall* methodCall = [FlutterMethodCall methodCallWithMethodName:method</span><br><span class="line">                                                                    arguments:arguments];</span><br><span class="line">  <span class="comment">// 将 FlutterMethodCall 编码成 NSData </span></span><br><span class="line">  NSData* message = [_codec encodeMethodCall:methodCall];</span><br><span class="line">  <span class="comment">// 回调操作</span></span><br><span class="line">  FlutterBinaryReply reply = ^(NSData* data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      callback((data == nil) ? FlutterMethodNotImplemented : [_codec decodeEnvelope:data]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 见 [7.2.1]</span></span><br><span class="line">  [_messenger sendOnChannel:_name message:message binaryReply:reply];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法主要功能：</p>
<ol>
<li>创建 <code>FlutterMethodCall</code> 对象，跟 [2.3] 是类似的</li>
<li>对 <code>FlutterMethodCall</code> 对象进行编码操作</li>
<li>reply: 对 dart 层返回的数据进行解码操作，并执行 callback 回调</li>
</ol>
<h3 id="7-2-1-sendOnChannel-message"><a href="#7-2-1-sendOnChannel-message" class="headerlink" title="7.2.1 sendOnChannel:message:"></a>7.2.1 sendOnChannel:message:</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterBinaryMessengerRelay.mm -L28</span></span><br><span class="line">- (<span class="keyword">void</span>)sendOnChannel:(NSString*)channel</span><br><span class="line">              message:(NSData*)message</span><br><span class="line">          binaryReply:(FlutterBinaryReply)callback &#123;</span><br><span class="line">  <span class="keyword">if</span> (self.parent) &#123;</span><br><span class="line">    <span class="comment">// 见 [7.2.2]</span></span><br><span class="line">    [self.parent sendOnChannel:channel message:message binaryReply:callback];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FML_LOG(WARNING) &lt;&lt; <span class="string">&quot;Communicating on a dead channel.&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-2-sendOnChannel-message-binaryReply"><a href="#7-2-2-sendOnChannel-message-binaryReply" class="headerlink" title="7.2.2 sendOnChannel:message:binaryReply:"></a>7.2.2 sendOnChannel:message:binaryReply:</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L704</span></span><br><span class="line">- (<span class="keyword">void</span>)sendOnChannel:(NSString*)channel</span><br><span class="line">              message:(NSData*)message</span><br><span class="line">          binaryReply:(FlutterBinaryReply)callback &#123;</span><br><span class="line">  NSParameterAssert(channel);</span><br><span class="line">  NSAssert(_shell &amp;&amp; _shell-&gt;IsSetup(),</span><br><span class="line">           @<span class="string">&quot;Sending a message before the FlutterEngine has been run.&quot;</span>);</span><br><span class="line">  <span class="comment">// 创建 PlatformMessageResponseDarwin 对象，后续在 Platform 线程中执行任务，见 [7.2.3]</span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessageResponseDarwin&gt; response =</span><br><span class="line">      (callback == nil) ? <span class="literal">nullptr</span></span><br><span class="line">                        : fml::MakeRefCounted&lt;flutter::PlatformMessageResponseDarwin&gt;(</span><br><span class="line">                              ^(NSData* reply) &#123;</span><br><span class="line">                                callback(reply);</span><br><span class="line">                              &#125;,</span><br><span class="line">                              _shell-&gt;GetTaskRunners().GetPlatformTaskRunner());</span><br><span class="line">  <span class="comment">// 创建 PlatformMessage 对象，跟 [3.1.3] 是类似的                           </span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessage&gt; platformMessage =</span><br><span class="line">      (message == nil) ? fml::MakeRefCounted&lt;flutter::PlatformMessage&gt;(channel.UTF8String, response)</span><br><span class="line">                       : fml::MakeRefCounted&lt;flutter::PlatformMessage&gt;(</span><br><span class="line">                             channel.UTF8String, flutter::GetVectorFromNSData(message), response);</span><br><span class="line">  <span class="comment">// 见 [7.3]</span></span><br><span class="line">  _shell-&gt;GetPlatformView()-&gt;DispatchPlatformMessage(platformMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-3-PlatformMessageResponseDarwin"><a href="#7-2-3-PlatformMessageResponseDarwin" class="headerlink" title="7.2.3 PlatformMessageResponseDarwin"></a>7.2.3 PlatformMessageResponseDarwin</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_darwin.mm -L9</span></span><br><span class="line">PlatformMessageResponseDarwin::PlatformMessageResponseDarwin(</span><br><span class="line">    PlatformMessageResponseCallback callback,</span><br><span class="line">    fml::RefPtr&lt;fml::TaskRunner&gt; platform_task_runner)</span><br><span class="line">    : callback_(callback, fml::OwnershipPolicy::Retain),</span><br><span class="line">      platform_task_runner_(<span class="built_in">std</span>::move(platform_task_runner)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-3-4-PlatformMessageResponseDarwin-Complete"><a href="#7-3-4-PlatformMessageResponseDarwin-Complete" class="headerlink" title="7.3.4 PlatformMessageResponseDarwin::Complete"></a>7.3.4 PlatformMessageResponseDarwin::Complete</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_darwin.mm -L17</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageResponseDarwin::Complete</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;fml::Mapping&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="function">fml::RefPtr&lt;PlatformMessageResponseDarwin&gt; <span class="title">self</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">  <span class="comment">// 在 platform 线程中执行任务</span></span><br><span class="line">  platform_task_runner_-&gt;PostTask(fml::MakeCopyable([self, data = <span class="built_in">std</span>::move(data)]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">    self-&gt;callback_.get()(GetNSDataFromMapping(<span class="built_in">std</span>::move(data)));</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>callback_</code> 就是 [7.2.2] 里面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^(NSData* reply) &#123;</span><br><span class="line">    callback(reply);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>从而 <code>callback</code> 回调到 [7.1] 的 <code>reply</code>，最终会将调用到 [7] 的 <code>result</code> 回调，自此，整个链路就完成了。</p>
<h2 id="7-3-PlatformView-DispatchPlatformMessage"><a href="#7-3-PlatformView-DispatchPlatformMessage" class="headerlink" title="7.3 PlatformView::DispatchPlatformMessage"></a>7.3 PlatformView::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_view.cc -L35</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformView::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 [7.4]  </span></span><br><span class="line">  delegate_.OnPlatformViewDispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 <code>PlatformView</code> 是前面 <code>PlatformViewIOS</code> 的父类，所以看下 <code>PlatformViewIOS</code> 的初始化方法，看 <code>delegate_</code>.</p>
<h3 id="7-3-1-PlatformViewIOS-初始化"><a href="#7-3-1-PlatformViewIOS-初始化" class="headerlink" title="7.3.1 PlatformViewIOS 初始化"></a>7.3.1 PlatformViewIOS 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_view_ios.mm -47</span></span><br><span class="line">PlatformViewIOS::PlatformViewIOS(PlatformView::Delegate&amp; delegate,</span><br><span class="line">                                 IOSRenderingAPI rendering_api,</span><br><span class="line">                                 flutter::TaskRunners task_runners)</span><br><span class="line">    : PlatformView(delegate, <span class="built_in">std</span>::move(task_runners)),</span><br><span class="line">      ios_context_(IOSContext::Create(rendering_api)),</span><br><span class="line">      accessibility_bridge_([<span class="keyword">this</span>](<span class="keyword">bool</span> enabled) &#123; PlatformView::SetSemanticsEnabled(enabled); &#125;) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>由前面 [3.5] 可知，这里的 <code>delegate_</code> 就是 Shell 对象。</p>
<h2 id="7-4-Shell-OnPlatformViewDispatchPlatformMessage"><a href="#7-4-Shell-OnPlatformViewDispatchPlatformMessage" class="headerlink" title="7.4 Shell::OnPlatformViewDispatchPlatformMessage"></a>7.4 Shell::OnPlatformViewDispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L838</span></span><br><span class="line"><span class="comment">// |PlatformView::Delegate|</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Shell::OnPlatformViewDispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  FML_DCHECK(is_setup_);</span><br><span class="line">  FML_DCHECK(task_runners_.GetPlatformTaskRunner()-&gt;RunsTasksOnCurrentThread());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在 UI 线程中执行任务  </span></span><br><span class="line">  task_runners_.GetUITaskRunner()-&gt;PostTask(</span><br><span class="line">      [engine = engine_-&gt;GetWeakPtr(), message = <span class="built_in">std</span>::move(message)] &#123;</span><br><span class="line">        <span class="keyword">if</span> (engine) &#123;</span><br><span class="line">          <span class="comment">// 见 [7.5]  </span></span><br><span class="line">          engine-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-5-Engine-DispatchPlatformMessage"><a href="#7-5-Engine-DispatchPlatformMessage" class="headerlink" title="7.5 Engine::DispatchPlatformMessage"></a>7.5 Engine::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L333</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Engine::DispatchPlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 判断相关 channel 名，在调用前面 [4.1] setupChannels 方法的时候，会设置这些 channel</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> channel = message-&gt;channel();</span><br><span class="line">  <span class="keyword">if</span> (channel == kLifecycleChannel) &#123;</span><br><span class="line">    <span class="keyword">if</span> (HandleLifecyclePlatformMessage(message.get())) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (channel == kLocalizationChannel) &#123;</span><br><span class="line">    <span class="keyword">if</span> (HandleLocalizationPlatformMessage(message.get())) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (channel == kSettingsChannel) &#123;</span><br><span class="line">    HandleSettingsPlatformMessage(message.get());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!runtime_controller_-&gt;IsRootIsolateRunning() &amp;&amp;</span><br><span class="line">             channel == kNavigationChannel) &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no runtime_, we may still need to set the initial route.</span></span><br><span class="line">    HandleNavigationPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在主 isolate 中执行任务</span></span><br><span class="line">  <span class="keyword">if</span> (runtime_controller_-&gt;IsRootIsolateRunning() &amp;&amp;</span><br><span class="line">      <span class="comment">// 见 [7.6]</span></span><br><span class="line">      runtime_controller_-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message))) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FML_DLOG(WARNING) &lt;&lt; <span class="string">&quot;Dropping platform message on channel: &quot;</span> &lt;&lt; channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-6-RuntimeController-DispatchPlatformMessage"><a href="#7-6-RuntimeController-DispatchPlatformMessage" class="headerlink" title="7.6 RuntimeController::DispatchPlatformMessage"></a>7.6 RuntimeController::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RuntimeController::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span>* platform_configuration = GetPlatformConfigurationIfAvailable()) &#123;</span><br><span class="line">    TRACE_EVENT1(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;RuntimeController::DispatchPlatformMessage&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;mode&quot;</span>, <span class="string">&quot;basic&quot;</span>);</span><br><span class="line">    <span class="comment">// 见 [7.7]             </span></span><br><span class="line">    platform_configuration-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-7-PlatformConfiguration-DispatchPlatformMessage"><a href="#7-7-PlatformConfiguration-DispatchPlatformMessage" class="headerlink" title="7.7 PlatformConfiguration::DispatchPlatformMessage"></a>7.7 PlatformConfiguration::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformConfiguration::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;tonic::DartState&gt; dart_state = library_.dart_state().lock();</span><br><span class="line">  <span class="keyword">if</span> (!dart_state) &#123;</span><br><span class="line">    FML_DLOG(WARNING)</span><br><span class="line">        &lt;&lt; <span class="string">&quot;Dropping platform message for lack of DartState on channel: &quot;</span></span><br><span class="line">        &lt;&lt; message-&gt;channel();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tonic::<span class="function">DartState::Scope <span class="title">scope</span><span class="params">(dart_state)</span></span>;</span><br><span class="line">  <span class="comment">// message-&gt;hasData() 是前面 [7.1] 中的 FlutterMethodCall 对象</span></span><br><span class="line">  Dart_Handle data_handle =</span><br><span class="line">      (message-&gt;hasData()) ? ToByteData(message-&gt;data()) : Dart_Null();</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsError(data_handle)) &#123;</span><br><span class="line">    FML_DLOG(WARNING)</span><br><span class="line">        &lt;&lt; <span class="string">&quot;Dropping platform message because of a Dart error on channel: &quot;</span></span><br><span class="line">        &lt;&lt; message-&gt;channel();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> response_id = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 跟 response_id 和 response 关联起来，由前面 [7.2.2] 可知这里 message-&gt;response() 为空</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> response = message-&gt;response()) &#123;</span><br><span class="line">    response_id = next_response_id_++;</span><br><span class="line">    pending_responses_[response_id] = response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// native -&gt; dart, 见 [7.8]  </span></span><br><span class="line">  tonic::LogIfError(</span><br><span class="line">      tonic::DartInvokeField(library_.value(), <span class="string">&quot;_dispatchPlatformMessage&quot;</span>,</span><br><span class="line">                             &#123;tonic::ToDart(message-&gt;channel()), data_handle,</span><br><span class="line">                              tonic::ToDart(response_id)&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-8-dispatchPlatformMessage"><a href="#7-8-dispatchPlatformMessage" class="headerlink" title="7.8 _dispatchPlatformMessage"></a>7.8 _dispatchPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hooks.dart -L144</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&#x27;vm:entry-point&#x27;</span>)</span><br><span class="line"><span class="comment">// ignore: unused_element</span></span><br><span class="line"><span class="keyword">void</span> _dispatchPlatformMessage(<span class="built_in">String</span> name, ByteData? data, <span class="built_in">int</span> responseId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (name == ChannelBuffers.kControlChannelName) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      channelBuffers.handleMessage(data!);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">      _printDebug(<span class="string">&#x27;Message to &quot;<span class="subst">$name</span>&quot; caused exception <span class="subst">$ex</span>&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>._respondToPlatformMessage(responseId, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.onPlatformMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 见 [7.8.1]</span></span><br><span class="line">    _invoke3&lt;<span class="built_in">String</span>, ByteData?, PlatformMessageResponseCallback&gt;(</span><br><span class="line">      <span class="built_in">window</span>.onPlatformMessage,</span><br><span class="line">      <span class="built_in">window</span>._onPlatformMessageZone,</span><br><span class="line">      name,</span><br><span class="line">      data,</span><br><span class="line">      (ByteData? responseData) &#123;</span><br><span class="line">        <span class="built_in">window</span>._respondToPlatformMessage(responseId, responseData);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    channelBuffers.push(name, data, (ByteData? responseData) &#123;</span><br><span class="line">      <span class="built_in">window</span>._respondToPlatformMessage(responseId, responseData);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-8-1"><a href="#7-8-1" class="headerlink" title="7.8.1"></a>7.8.1</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hooks.dart -L270</span></span><br><span class="line"><span class="comment">/// <span class="markdown">Invokes [callback] inside the given [zone] passing it [arg1], [arg2], and [arg3].</span></span></span><br><span class="line"><span class="keyword">void</span> _invoke3&lt;A1, A2, A3&gt;(<span class="keyword">void</span> callback(A1 a1, A2 a2, A3 a3)?, Zone zone, A1 arg1, A2 arg2, A3 arg3) &#123;</span><br><span class="line">  <span class="keyword">if</span> (callback == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">assert</span>(zone != <span class="keyword">null</span>); <span class="comment">// ignore: unnecessary_null_comparison</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (identical(zone, Zone.current)) &#123;</span><br><span class="line">    callback(arg1, arg2, arg3);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    zone.runGuarded(() &#123;</span><br><span class="line">      callback(arg1, arg2, arg3);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在给定的 Zone 里面，根据参数回调 callback.</p>
<ul>
<li>callback: window.onPlatformMessage, 见 [7.9]</li>
<li>zone: window._onPlatformMessageZone</li>
<li>arg1: name // channel 名</li>
<li>arg2: data // FlutterMethodCall 对象，见 [7.7]</li>
<li>arg3: window._respondToPlatformMessage, 见 [7.10]</li>
</ul>
<h2 id="7-9-onPlatformMessage"><a href="#7-9-onPlatformMessage" class="headerlink" title="7.9 onPlatformMessage"></a>7.9 onPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Listens for platform messages and directs them to the [defaultBinaryMessenger].</span></span><br><span class="line"><span class="keyword">mixin</span> ServicesBinding <span class="keyword">on</span> BindingBase, SchedulerBinding &#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    _defaultBinaryMessenger = createBinaryMessenger();</span><br><span class="line">    _restorationManager = createRestorationManager();</span><br><span class="line">    <span class="comment">// 见 [7.9.1]</span></span><br><span class="line">    <span class="built_in">window</span>.onPlatformMessage = defaultBinaryMessenger.handlePlatformMessage;</span><br><span class="line">    initLicenses();</span><br><span class="line">    SystemChannels.system.setMessageHandler((<span class="built_in">dynamic</span> message) =&gt; handleSystemMessage(message <span class="keyword">as</span> <span class="built_in">Object</span>));</span><br><span class="line">    SystemChannels.lifecycle.setMessageHandler(_handleLifecycleMessage);</span><br><span class="line">    readInitialLifecycleStateFromNativeWindow();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-9-1-handlePlatformMessage"><a href="#7-9-1-handlePlatformMessage" class="headerlink" title="7.9.1 handlePlatformMessage"></a>7.9.1 handlePlatformMessage</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; handlePlatformMessage(</span><br><span class="line">    <span class="built_in">String</span> channel,</span><br><span class="line">    ByteData? data,</span><br><span class="line">    ui.PlatformMessageResponseCallback? callback,</span><br><span class="line">  ) <span class="keyword">async</span> &#123;</span><br><span class="line">    ByteData? response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 获取 handler, 跟 [3.6] 类似，现在的问题是在哪里设置的 _handlers 呢？见 [7.13]</span></span><br><span class="line">      <span class="keyword">final</span> MessageHandler? handler = _handlers[channel];</span><br><span class="line">      <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 执行 handler </span></span><br><span class="line">        response = <span class="keyword">await</span> handler(data);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ui.channelBuffers.push(channel, data, callback!);</span><br><span class="line">        callback = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">      FlutterError.reportError(FlutterErrorDetails(</span><br><span class="line">        exception: exception,</span><br><span class="line">        stack: stack,</span><br><span class="line">        <span class="keyword">library</span>: <span class="string">&#x27;services library&#x27;</span>,</span><br><span class="line">        context: ErrorDescription(<span class="string">&#x27;during a platform message callback&#x27;</span>),</span><br><span class="line">      ));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 回调 response, 见 [7.10]</span></span><br><span class="line">        callback(response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-10-respondToPlatformMessage"><a href="#7-10-respondToPlatformMessage" class="headerlink" title="7.10 _respondToPlatformMessage"></a>7.10 _respondToPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// window -L1216, 见 [7.11]</span></span><br><span class="line"><span class="comment">/// <span class="markdown">Called by [<span class="emphasis">_dispatchPlatformMessage].</span></span></span></span><br><span class="line">  <span class="keyword">void</span> _respondToPlatformMessage(<span class="built_in">int</span> responseId, ByteData? data)</span><br><span class="line">      native <span class="string">&#x27;PlatformConfiguration_respondToPlatformMessage&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><code>_dispatchPlatformMessage</code> 会调用 <code>_respondToPlatformMessage</code> 方法，而 <code>_respondToPlatformMessage</code> 又是一个 native 方法。</p>
<h2 id="7-11-RespondToPlatformMessage"><a href="#7-11-RespondToPlatformMessage" class="headerlink" title="7.11 _RespondToPlatformMessage"></a>7.11 _RespondToPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_configuration.cc -L159</span></span><br><span class="line"><span class="keyword">void</span> _RespondToPlatformMessage(Dart_NativeArguments args) &#123;</span><br><span class="line">  tonic::DartCallStatic(&amp;RespondToPlatformMessage, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// platform_configuration.cc -L141</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RespondToPlatformMessage</span><span class="params">(Dart_Handle window,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> response_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> tonic::DartByteData&amp; data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsNull(data.dart_handle())) &#123;</span><br><span class="line">    UIDartState::Current()</span><br><span class="line">        -&gt;platform_configuration()</span><br><span class="line">        -&gt;CompletePlatformMessageEmptyResponse(response_id);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// TODO(engine): Avoid this copy.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* buffer = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(data.data());</span><br><span class="line">    <span class="comment">// 见 [7.11.1]</span></span><br><span class="line">    UIDartState::Current()</span><br><span class="line">        -&gt;platform_configuration()</span><br><span class="line">        -&gt;CompletePlatformMessageResponse(</span><br><span class="line">            response_id,</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;(buffer, buffer + data.length_in_bytes()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-11-1-PlatformConfiguration-CompletePlatformMessageResponse"><a href="#7-11-1-PlatformConfiguration-CompletePlatformMessageResponse" class="headerlink" title="7.11.1 PlatformConfiguration::CompletePlatformMessageResponse"></a>7.11.1 PlatformConfiguration::CompletePlatformMessageResponse</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformConfiguration::CompletePlatformMessageResponse</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> response_id,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 这 response_id 为 0, 对应着 [7.1] result 入参为 nil 的情况</span></span><br><span class="line">  <span class="keyword">if</span> (!response_id) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = pending_responses_.find(response_id);</span><br><span class="line">  <span class="comment">// 根据 response_id 没找到内容</span></span><br><span class="line">  <span class="keyword">if</span> (it == pending_responses_.end()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取 [7.7] 的 message-&gt;response(), 对应 [7.2.2] 的 response 对象</span></span><br><span class="line">  <span class="keyword">auto</span> response = <span class="built_in">std</span>::move(it-&gt;second);</span><br><span class="line">  <span class="comment">// 移除该回调</span></span><br><span class="line">  pending_responses_.erase(it);</span><br><span class="line">  <span class="comment">// 见 [7.3.4]</span></span><br><span class="line">  response-&gt;Complete(<span class="built_in">std</span>::make_unique&lt;fml::DataMapping&gt;(<span class="built_in">std</span>::move(data)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-12-setMethodCallHandler"><a href="#7-12-setMethodCallHandler" class="headerlink" title="7.12 setMethodCallHandler"></a>7.12 setMethodCallHandler</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// paltform_channel.dart -L377</span></span><br><span class="line"><span class="keyword">void</span> setMethodCallHandler(Future&lt;<span class="built_in">dynamic</span>&gt; <span class="built_in">Function</span>(MethodCall call)? handler) &#123;</span><br><span class="line">    <span class="comment">// 见 MethodChannel(this) 和 handler 关联起来 </span></span><br><span class="line">    _methodChannelHandlers[<span class="keyword">this</span>] = handler;</span><br><span class="line">    <span class="comment">// 见 [7.13]</span></span><br><span class="line">    binaryMessenger.setMessageHandler(</span><br><span class="line">      name,</span><br><span class="line">      handler == <span class="keyword">null</span></span><br><span class="line">        ? <span class="keyword">null</span></span><br><span class="line">        : (ByteData? message) =&gt; _handleAsMethodCall(message, handler),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-13-setMessageHandler"><a href="#7-13-setMessageHandler" class="headerlink" title="7.13 setMessageHandler"></a>7.13 setMessageHandler</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// binding.dart -L311</span></span><br><span class="line"><span class="keyword">void</span> setMessageHandler(<span class="built_in">String</span> channel, MessageHandler? handler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>)</span><br><span class="line">      _handlers.remove(channel);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      _handlers[channel] = handler;</span><br><span class="line">      ui.channelBuffers.drain(channel, (ByteData? data, ui.PlatformMessageResponseCallback callback) <span class="keyword">async</span> &#123;</span><br><span class="line">       <span class="keyword">await</span> handlePlatformMessage(channel, data, callback);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里跟前面 [7.9.1] 串联起来了，对 <code>_handlers</code> 进行赋值。</p>
<h1 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h1><h2 id="8-1-调用链路"><a href="#8-1-调用链路" class="headerlink" title="8.1 调用链路"></a>8.1 调用链路</h2><h3 id="8-1-1-dart-gt-native"><a href="#8-1-1-dart-gt-native" class="headerlink" title="8.1.1 dart -&gt; native"></a>8.1.1 dart -&gt; native</h3><p>调用流程如下：</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mUGGI2r5i-neno2THQeatT_9IYs5sjV5WBa3nWViDRBvGyKMW4bb7YCEwaZ0301WYHyushCicJOcKu__8oWsEYxJYuvnyKNiWYno_Dc-ahUlx8DoQFNmbi1dJYSNDF2UQocAp9kI6gczqy1xeP092Zq059i_o8kiNDkUA2fbVtqFqo3si12taxoHuocX89LSZ?width=1853&height=653&cropmode=none"></p>
<p>赋值 handler 流程图如下：<br><img src="https://sat02pap001files.storage.live.com/y4m-rYn8D1lzoPq_wbVvKy3EG6enZmedcNaBygocaNLZcdhSZeNYKXmP680OXlMqRjy7gHBixIXWcDiG9M3HusQuoTt8tRZP8l332NODfLERsK4nqIuhb8-x6ZySt9NsU3-NL3Sdd43joTTZ1rZ0AqR4djHPQzMPZbS2-g6xR8siN8pEl1pengn-_ghou21p20K?width=843&height=483&cropmode=none"></p>
<p>method channel 的执行涉及到主线程和UI线程的交互，代码调用从 dart -&gt; shell -&gt; native(ios), 执行完成后再原路返回 native(ios) -&gt; shell -&gt; dart.</p>
<ul>
<li>3.4 Shell::OnEngineHandlePlatformMessage, 在 UI 线程(io.flutter.1.ui), 将任务派发给主线程</li>
<li>6.1 PlatformMessageResponseDart::Complete, 在主线程(platform), 将任务派发给 UI 线程</li>
</ul>
<h3 id="8-1-2-native-gt-dart"><a href="#8-1-2-native-gt-dart" class="headerlink" title="8.1.2 native -&gt; dart"></a>8.1.2 native -&gt; dart</h3><p>调用流程如下：</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mYWALpdQzLwOseOw8dbeMIzvvFQHdZzr8fEblvx10FYnSauMk-KRCNCVxgYPcZi_ooUOOGJ69jnQVjA-nKBpq-fdPzXuc2Ihwydb02HooyXOBIuUeXQGDFI2swtmsmgSFtaGVO_qHp6cQriPABQCkVdUDa83T_4F72eeaHOMvJyarXiwZ0kaSiNIcwsrjBMfi?width=2223&height=923&cropmode=none"></p>
<p>同 [8.1.1],  method channel 的执行涉及到主线程和UI线程的交互，代码调用从 native(ios) -&gt; shell -&gt; dart, 执行完成后再原路返回 dart -&gt; shell -&gt; native(ios).</p>
<ul>
<li>7.3.4 PlatformMessageResponseDarwin::Complete, 在 UI 线程(io.flutter.1.ui), 将任务派发给主线程</li>
<li>7.4 Shell::OnPlatformViewDispatchPlatformMessage,  在主线程(platform), 将任务派发给 UI 线程</li>
</ul>
<h2 id="8-2-相关概念"><a href="#8-2-相关概念" class="headerlink" title="8.2 相关概念"></a>8.2 相关概念</h2><ol>
<li>shell </li>
<li>isolate(和线程的关系)</li>
<li>ui platform 等线程，flutter 中有多少线程？</li>
<li>future Complete 异步调用</li>
<li>dart 和 native(ios) 中的相关编解码类</li>
</ol>
<h2 id="8-3-问题"><a href="#8-3-问题" class="headerlink" title="8.3 问题"></a>8.3 问题</h2><ol>
<li>dart 层和 native 层数据通信的本质是什么？</li>
<li>怎么监控 platform channel 的执行过程，方便调试？</li>
</ol>
<p>answer</p>
<ol>
<li>看源码可知，双方交互都是传递二进制数据，然后通过双方的编解码类来转成当前层所需要的对象，所以是二进制数据流；</li>
<li>可以自定义一个 <code>BinaryMessenger</code> 类，然后替换系统的 <code>ServicesBinding.defaultBinaryMessenger</code>，从而达到监控的目的；</li>
</ol>
<h1 id="10-参考链接"><a href="#10-参考链接" class="headerlink" title="10. 参考链接"></a>10. 参考链接</h1><ul>
<li><a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a></li>
<li><a href="http://gityuan.com/2019/08/10/flutter_channel/">深入理解Flutter的Platform Channel机制</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flutter/" rel="tag"># flutter</a>
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/02/24/matrix-flip/" rel="prev" title="矩阵翻转">
      <i class="fa fa-chevron-left"></i> 矩阵翻转
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/09/flutter-main-runApp/" rel="next" title="iOS Flutter Main runApp">
      iOS Flutter Main runApp <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">1. 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-demo"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 demo</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Dart-%E5%B1%82"><span class="nav-number">2.</span> <span class="nav-text">2. Dart 层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-MethodChannel-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 MethodChannel 初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-MessageCodec-%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 MessageCodec 抽象类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-invokeMethod"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 invokeMethod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-MethodCall%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 MethodCall初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-encodeMethodCall"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2 encodeMethodCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-WriteBuffer"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3 WriteBuffer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-binaryMessenger-send"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 binaryMessenger.send</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-sendPlatformMessage"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.1 _sendPlatformMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-Completer-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.4.2 Completer 初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-AsyncCompleter-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.4.3.</span> <span class="nav-text">2.4.3 _AsyncCompleter 初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-window-sendPlatformMessage"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 window.sendPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-zonedPlatformMessageResponseCallback"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.1 _zonedPlatformMessageResponseCallback</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-engine-%E5%B1%82"><span class="nav-number">3.</span> <span class="nav-text">3. engine 层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-SendPlatformMessage"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 _SendPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-DartPersistentValue"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 DartPersistentValue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-PlatformMessageResponseDart-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2 PlatformMessageResponseDart 初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-PlatformMessage-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.1.3.</span> <span class="nav-text">3.1.3 PlatformMessage 初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-RuntimeController-HandlePlatformMessage"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 RuntimeController::HandlePlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-Engine-HandlePlatformMessage"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 Engine::HandlePlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Shell-OnEngineHandlePlatformMessage"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 Shell::OnEngineHandlePlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-PlatformViewIOS-HandlePlatformMessage"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 PlatformViewIOS::HandlePlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-PlatformMessageRouter-HandlePlatformMessage"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 PlatformMessageRouter::HandlePlatformMessage</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-shell-%E5%B1%82"><span class="nav-number">4.</span> <span class="nav-text">4. shell 层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-setupChannels"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 setupChannels</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-FlutterBinaryMessengerRelay-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 FlutterBinaryMessengerRelay 初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-setMessageHandlerOnChannel"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 setMessageHandlerOnChannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-setMessageHandlerOnChannel"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 setMessageHandlerOnChannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-PlatformMessageRouter-SetMessageHandler"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 PlatformMessageRouter::SetMessageHandler</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-native-%E5%B1%82"><span class="nav-number">5.</span> <span class="nav-text">5. native 层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-FlutterMethodChannel-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 FlutterMethodChannel 初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-FlutterStandardMethodCodec"><span class="nav-number">5.1.1.</span> <span class="nav-text">5.1.1 FlutterStandardMethodCodec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-FlutterMessageCodec"><span class="nav-number">5.1.2.</span> <span class="nav-text">5.1.2 FlutterMessageCodec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-setMethodCallHandler-%E6%96%B9%E6%B3%95"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 setMethodCallHandler 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-messageHandler"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 messageHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-decodeMethodCall"><span class="nav-number">5.3.1.</span> <span class="nav-text">5.3.1 decodeMethodCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-encodeErrorEnvelope"><span class="nav-number">5.3.2.</span> <span class="nav-text">5.3.2 encodeErrorEnvelope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-encodeSuccessEnvelope"><span class="nav-number">5.3.3.</span> <span class="nav-text">5.3.3 encodeSuccessEnvelope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-setMethodCallHandler-%E5%9B%9E%E8%B0%83"><span class="nav-number">5.3.4.</span> <span class="nav-text">5.4 setMethodCallHandler 回调</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E5%9B%9E%E4%BC%A0%E7%BB%93%E6%9E%9C"><span class="nav-number">6.</span> <span class="nav-text">6. 回传结果</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-PlatformMessageResponseDart-Complete"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 PlatformMessageResponseDart::Complete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-DartByteData-Create"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 DartByteData::Create</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-DartInvoke"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 DartInvoke</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-Dart-InvokeClosure"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 Dart_InvokeClosure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-asyncComplete"><span class="nav-number">6.5.</span> <span class="nav-text">6.5 _asyncComplete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-decodeEnvelope"><span class="nav-number">6.6.</span> <span class="nav-text">6.6 decodeEnvelope</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-1-readValue"><span class="nav-number">6.6.1.</span> <span class="nav-text">6.6.1 readValue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-native-gt-dart"><span class="nav-number">7.</span> <span class="nav-text">7. native -&gt; dart</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-invokeMethod-arguments-result"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 invokeMethod:arguments:result:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-sendOnChannel-message"><span class="nav-number">7.1.1.</span> <span class="nav-text">7.2.1 sendOnChannel:message:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-sendOnChannel-message-binaryReply"><span class="nav-number">7.1.2.</span> <span class="nav-text">7.2.2 sendOnChannel:message:binaryReply:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-3-PlatformMessageResponseDarwin"><span class="nav-number">7.1.3.</span> <span class="nav-text">7.2.3 PlatformMessageResponseDarwin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-4-PlatformMessageResponseDarwin-Complete"><span class="nav-number">7.1.4.</span> <span class="nav-text">7.3.4 PlatformMessageResponseDarwin::Complete</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-PlatformView-DispatchPlatformMessage"><span class="nav-number">7.2.</span> <span class="nav-text">7.3 PlatformView::DispatchPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-1-PlatformViewIOS-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">7.2.1.</span> <span class="nav-text">7.3.1 PlatformViewIOS 初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-Shell-OnPlatformViewDispatchPlatformMessage"><span class="nav-number">7.3.</span> <span class="nav-text">7.4 Shell::OnPlatformViewDispatchPlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-Engine-DispatchPlatformMessage"><span class="nav-number">7.4.</span> <span class="nav-text">7.5 Engine::DispatchPlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-RuntimeController-DispatchPlatformMessage"><span class="nav-number">7.5.</span> <span class="nav-text">7.6 RuntimeController::DispatchPlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7-PlatformConfiguration-DispatchPlatformMessage"><span class="nav-number">7.6.</span> <span class="nav-text">7.7 PlatformConfiguration::DispatchPlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-8-dispatchPlatformMessage"><span class="nav-number">7.7.</span> <span class="nav-text">7.8 _dispatchPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-8-1"><span class="nav-number">7.7.1.</span> <span class="nav-text">7.8.1</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-9-onPlatformMessage"><span class="nav-number">7.8.</span> <span class="nav-text">7.9 onPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-9-1-handlePlatformMessage"><span class="nav-number">7.8.1.</span> <span class="nav-text">7.9.1 handlePlatformMessage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-10-respondToPlatformMessage"><span class="nav-number">7.9.</span> <span class="nav-text">7.10 _respondToPlatformMessage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-11-RespondToPlatformMessage"><span class="nav-number">7.10.</span> <span class="nav-text">7.11 _RespondToPlatformMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-11-1-PlatformConfiguration-CompletePlatformMessageResponse"><span class="nav-number">7.10.1.</span> <span class="nav-text">7.11.1 PlatformConfiguration::CompletePlatformMessageResponse</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-12-setMethodCallHandler"><span class="nav-number">7.11.</span> <span class="nav-text">7.12 setMethodCallHandler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-13-setMessageHandler"><span class="nav-number">7.12.</span> <span class="nav-text">7.13 setMessageHandler</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">8. 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 调用链路</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-dart-gt-native"><span class="nav-number">8.1.1.</span> <span class="nav-text">8.1.1 dart -&gt; native</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-native-gt-dart"><span class="nav-number">8.1.2.</span> <span class="nav-text">8.1.2 native -&gt; dart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 相关概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E9%97%AE%E9%A2%98"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">9.</span> <span class="nav-text">10. 参考链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">joakim.liu</p>
  <div class="site-description" itemprop="description">你不解决问题，就会成为问题。iOS菜逗一枚。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/JoakimLiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JoakimLiu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/JoakimLiu" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;JoakimLiu" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">joakim.liu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  var disqus_config = function() {
    this.page.url = "http://example.com/2021/04/07/flutter-source-code-ios-platform-channels/";
    this.page.identifier = "2021/04/07/flutter-source-code-ios-platform-channels/";
    this.page.title = "iOS Flutter Platform Channel";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://http-joakimliu-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
