<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
<meta property="og:type" content="website">
<meta property="og:title" content="牛易疯先森的开发记录">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="牛易疯先森的开发记录">
<meta property="og:description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="joakim.liu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>牛易疯先森的开发记录</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">牛易疯先森的开发记录</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/30/stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/30/stack/" class="post-title-link" itemprop="url">iOS 函数调用栈那些事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-30 08:26:20" itemprop="dateCreated datePublished" datetime="2022-09-30T08:26:20+08:00">2022-09-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>《<a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a>》 <code>10.2 栈与调用惯例</code> 里面讲到了堆栈帧这块的内容，联想到同事面试时说到捕获奔溃调用栈的问题，感觉挺有意思，于是记录一下。<br>本文主要讲解以下内容</p>
<ol>
<li>栈帧是什么东西？</li>
<li>Arm64 汇编基础，Arm64 栈帧</li>
<li>栈帧回溯怎么玩？怎么符号化？常见的三方库又是怎么玩的？</li>
</ol>
<h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><p>《<a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a>》是这么描述栈的：</p>
<blockquote>
<p>栈（stack）是现代计算机程序里最为重要的概念之一，几乎每一个程序都使用了栈，没有栈就没有函数，没有局部变量，也就没有我们如今能够看见的所有的计算机语言。<br>在经典的计算机科学中，栈被定义为一个特殊的容器，用户可以将数据压入栈中（入栈，push），也可以将已经压入栈中的数据弹出（出栈，pop），但栈这个容器必须遵守一条规则：先入栈的数据后出栈（First In Last Out, FIFO），多多少少像叠成一叠的书：先叠上去的书在最下面，因此要最后才能取出。<br>在计算机系统中，栈则是一个具有以上属性的动态内存区域。程序可以将数据压入栈中，也可以将数据从栈顶弹出。压栈操作使得栈增大，而弹出操作使栈减小。</p>
</blockquote>
<h2 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h2><p>栈保存了函数调用所需的信息，而这些信息称为堆栈帧（Stack Frame）或活动记录（Activate Record），包括以下内容：</p>
<ul>
<li>函数的返回地址和参数</li>
<li>临时变量：包括函数的非静态局部变量以及编译器自动生成的其他临时变量</li>
<li>保存的上下文：包括在函数调用前后需要保持不变的寄存器</li>
</ul>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/stack/20220930091349.png" alt="栈帧"></p>
<p>上图是 i386 中一个函数的栈帧，根据 ebp(Frame Pointer, 帧寄存器) 和 esp(Stack Pointer, 栈寄存器) 这两寄存器可以划分一个函数的堆栈。</p>
<ol>
<li>ebp 是固定的，始终指向栈底（高地址）</li>
<li>esp 始终指向栈顶（低地址），它是动态变化的</li>
<li>可以通过 ebp esp 和获取栈帧中的数据，比如，ebp+4 获取函数的返回地址</li>
</ol>
<h2 id="调用惯例"><a href="#调用惯例" class="headerlink" title="调用惯例"></a>调用惯例</h2><p>调用惯例：函数的调用方和被调用方对于函数如何调用须要有一个明确的约定。就像两个人沟通一样的，只有使用相同的语言（普通话）才能进行友好的沟通。<br>而调用惯例包括以下几方面的内容：</p>
<ol>
<li>函数参数的传递顺序和方式<ol>
<li>函数参数的传递有很多种方式，最常见的一种是通过栈传递。函数的调用方将参数压入栈中，函数自己再从栈中将参数取出。对于有多个参数的函数，调用惯例要规定函数调用方将参数压栈的顺序：是从左至右，还是从右至左。有些调用惯例还允许使用寄存器传递参数，以提高性能。</li>
</ol>
</li>
<li>栈的维护方式<ol>
<li>在函数将参数压栈之后，函数体会被调用，此后需要将被压入栈中的参数全部弹出，以使得栈在函数调用前后保持一致。这个弹出的工作可以由函数的调用方来完成，也可以由函数本身来完成。 // PS: 如果不进行栈回退 pop 操作的话，函数调用会将程序的栈空间用完，从而出现经典的 stackoverflow 错误</li>
</ol>
</li>
<li>名字修饰（Name-mangling）的策略<ol>
<li>为了链接的时候对调用惯例进行区分，调用管理要对函数本身的名字进行修饰。不同的调用惯例有不同的名字修饰策略。</li>
</ol>
</li>
</ol>
<h1 id="Arm64"><a href="#Arm64" class="headerlink" title="Arm64"></a>Arm64</h1><p>有了上面书本基础知识的加持，现在到 Arm64 架构下实践一波吧。</p>
<h2 id="汇编基础"><a href="#汇编基础" class="headerlink" title="汇编基础"></a>汇编基础</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p><a href="https://zh.wikipedia.org/wiki/%E5%AF%84%E5%AD%98%E5%99%A8">寄存器</a>（Register）是中央处理器内用来暂存指令、数据和地址的电脑存储器。 它就是 CPU 内部用来存储数据的存储器件，容量小、访问速度快。<br><br/></p>
<p>而 Arm64 有 31 个通用寄存器，相关用途如下。 </p>
<blockquote>
<p>The 64-bit ARM (AArch64) calling convention allocates the 31 general-purpose registers as:<br>x31 (SP): Stack pointer or a zero register, depending on context.<br>x30 (LR): Procedure link register, used to return from subroutines.<br>x29 (FP): Frame pointer.<br>x19 to x29: Callee-saved.<br>x18 (PR): Platform register. Used for some operating-system-specific special purpose, or an additional caller-saved register.<br>x16 (IP0) and x17 (IP1): Intra-Procedure-call scratch registers.<br>x9 to x15: Local variables, caller saved.<br>x8 (XR): Indirect return value address.<br>x0 to x7: Argument values passed to and results returned from a subroutine.</p>
</blockquote>
<p>摘自 <a href="https://en.wikipedia.org/wiki/Calling_convention#ARM_(A64)">Calling_convention#ARM_(A64)</a>。</p>
<br/>

<p>总结下常用的:</p>
<ol>
<li>x0-x7: 用来存放函数调用的参数和函数返回值(x0)，更多参数可以使用堆栈来存放</li>
<li>x29 (FP): 上图 i386 中的 ebp, 它里面存储的是上一个函数（该函数的调用方 caller） ebp 的地址</li>
<li>x30 (LR): 存储函数的返回地址</li>
<li>SP: 上图 i386 中的 esp, 指向栈顶<ol>
<li>现在执行 lldb 命令<code>register read x31</code> 会报错：<code>error: Invalid register name &#39;x31&#39;.</code></li>
</ol>
</li>
<li>PC: 记录 CPU 当前执行的是哪条指令</li>
</ol>
<h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h3><p>一些常见的指令，内容摘自 <a href="https://blackteachinese.github.io/2017/07/12/arm64/">10分钟入门arm64汇编</a>，具体的可以参加 ARM 操作手册。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add x0,x0,#1            ;x0 &lt;&#x3D;&#x3D;x0+1 ,把x0的内容加1。</span><br><span class="line">add x0,x0,#0x30         ;x0 &lt;&#x3D;&#x3D;x0+0x30,把x0的内容加 0x30。</span><br><span class="line">add x0,x1,x3            ;x0 &lt;&#x3D;&#x3D;x1+x3, 把x1的内容加上x3的内容放入x0</span><br><span class="line">add x0,x1,x3,lsl #3     ;x0 &lt;&#x3D;&#x3D;x0+x3*8 ,x3的值左移3位就是乘以8，结果与x1的值相, 放入x0.</span><br><span class="line">add x0,x1,[x2]          ;x0 &lt;&#x3D;&#x3D;x1+[x2], 把x1的内容加上x2的内容作为地址取内存内容放入x0</span><br><span class="line">ldr x0,[x1]             ;x0 &lt;&#x3D;&#x3D;[x1], 把x1的内容作为地址取内存内容放入x0</span><br><span class="line">str x0,[x1]             ;[x1] &lt;&#x3D;&#x3D; x0, 把x0的内容放入x1的内容作为地址的内存中</span><br><span class="line">ldr x0,[x1,#4]          ;x0 &lt;&#x3D;&#x3D;[x1+4], 把x1的内容加上4, 作为内存地址, 取其内容放入x0</span><br><span class="line">ldr x0,[x1,#4]!         ;x0 &lt;&#x3D;&#x3D;[x1+4]、 x1&lt;&#x3D;&#x3D;x1+4, 把x1的内容加上4, 作为内存地址, 取其内容放入x0, 然后把x1的内容加上4放入x1</span><br><span class="line">ldr x0,[x1],#4          ;x0 &lt;&#x3D;&#x3D;[x1] 、x1 &lt;&#x3D;&#x3D;x1+4, 把x1的内容作为内存地址取内存内容放入x0, 并把x1的内容加上4放入x1</span><br><span class="line">ldr x0,[x1,x2]          ;x0 &lt;&#x3D;&#x3D;[x1+x2], 把x1和x2的内容相加, 作为内存地址取内存内容放入x0</span><br></pre></td></tr></table></figure>

<h2 id="栈帧-1"><a href="#栈帧-1" class="headerlink" title="栈帧"></a>栈帧</h2><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/stack/aapcs64-variadic-stack.png" alt="aapcs64-variadic-stack"><br>跟《<a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a>》里面的栈帧差不多，图片来自 <a href="https://github.com/ARM-software/abi-aa/blob/60a8eb8c55e999d74dac5e368fc9d7e36e38dda4/aapcs64/aapcs64.rst#the-stack">Procedure Call Standard for the Arm® 64-bit Architecture (AArch64)</a>。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>用一个 Demo 将上面的内容串联起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (int)test1:(int)a &#123;</span><br><span class="line">    int res &#x3D; [self test2:a b:2];</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)test2:(int)a b:(int)b &#123;</span><br><span class="line">    int res &#x3D; a + b;</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    int res &#x3D; [self test1:1];</span><br><span class="line">    NSLog(@&quot;res: %d&quot;, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在函数调用方 <code>test1</code> 和被调方 <code>test2</code> 的第一行代码处下断点，并用汇编查看。</p>
<h3 id="caller-test1"><a href="#caller-test1" class="headerlink" title="caller - test1"></a>caller - test1</h3><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/stack/20220930104416.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Demo_fishhook&#96;-[ViewController test1:]:</span><br><span class="line">    0x102067294 &lt;+0&gt;:  sub    sp, sp, #0x30     ; sp &#x3D; sp - 0x30(48), 开辟栈空间</span><br><span class="line">    0x102067298 &lt;+4&gt;:  stp    x29, x30, [sp, #0x20] ; 将 x29(fp) 里面的内容存入 sp+0x20(32)的位置，占 8B(x29 共 64bit, 8B) 长度；将 x30(lr) 的内容存入 sp+0x20+8&#x3D;sp+40 的位置，占 8B</span><br><span class="line">    0x10206729c &lt;+8&gt;:  add    x29, sp, #0x20 ; x29 &#x3D; sp + 0x20</span><br><span class="line">    0x1020672a0 &lt;+12&gt;: stur   x0, [x29, #-0x8] ; 将 x0 的内容，x29-0x8 的位置</span><br><span class="line">    0x1020672a4 &lt;+16&gt;: str    x1, [sp, #0x10] ; 将 x1 的内容放入 sp+0x10 的位置</span><br><span class="line">    0x1020672a8 &lt;+20&gt;: str    w2, [sp, #0xc] ; w2 是 x2 的低32位，占 4B</span><br><span class="line">-&gt;  0x1020672ac &lt;+24&gt;: ldur   x0, [x29, #-0x8] ; 数据读取，就是将上面的数据再读出来</span><br><span class="line">    0x1020672b0 &lt;+28&gt;: ldr    w2, [sp, #0xc] ; 数据读取</span><br><span class="line">    0x1020672b4 &lt;+32&gt;: adrp   x8, 87</span><br><span class="line">    0x1020672b8 &lt;+36&gt;: ldr    x1, [x8, #0xb80] ; 数据读取放入 x1 寄存器中</span><br><span class="line">    0x1020672bc &lt;+40&gt;: mov    w3, #0x2 ; x3 的低32位存的值是 0x2</span><br><span class="line">    0x1020672c0 &lt;+44&gt;: bl     0x102d2f0e4               ; symbol stub for: objc_msgSend ; 函数跳转</span><br><span class="line">    0x1020672c4 &lt;+48&gt;: str    w0, [sp, #0x8] ; 存储 test2 的结果</span><br><span class="line">    0x1020672c8 &lt;+52&gt;: ldr    w0, [sp, #0x8] ; 读取 w0 </span><br><span class="line">    0x1020672cc &lt;+56&gt;: ldp    x29, x30, [sp, #0x20] ; 将 [sp, #0x20] 的内容放入 x29 x30 寄存器</span><br><span class="line">    0x1020672d0 &lt;+60&gt;: add    sp, sp, #0x30 ; sp &#x3D; sp + 0x30</span><br><span class="line">    0x1020672d4 &lt;+64&gt;: ret    </span><br></pre></td></tr></table></figure>
<br/>

<p>这里大概做了下面几件事</p>
<ol>
<li>开辟栈空间，存储 x29 x30 的值到栈，因为后面会修改 x29 x30 的值</li>
<li>给 x29 赋值，即固定当前函数 x29 的位置</li>
<li>存储和读取 x0 x1 w2<code>test2:b:</code> 函数入参的值</li>
<li>给 x3 赋值为 2, 相当于 <code>test2:b:</code> 函数入参 b 的值</li>
<li><code>bl</code> 调用 <code>test2:b:</code> 函数</li>
<li>从栈中取出 x29 x30 的值，回退栈空间</li>
<li>ret: 函数返回到 x30 所指向的地址</li>
</ol>
<br/>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">        x0 &#x3D; 0x0000000102709160</span><br><span class="line">        x1 &#x3D; 0x00000001020ab733  &quot;test1:&quot;</span><br><span class="line">        x2 &#x3D; 0x0000000000000001</span><br><span class="line">        x3 &#x3D; 0x000000016dd9dbf0</span><br><span class="line">        x4 &#x3D; 0x0000000000000010</span><br><span class="line">        x5 &#x3D; 0x0000000000000020</span><br><span class="line">        x6 &#x3D; 0x000000016dd9d8f0</span><br><span class="line">        x7 &#x3D; 0x0000000000000000</span><br><span class="line">        x8 &#x3D; 0x00000001020be000  (void *)0x00000001020ab182: initWithCodeType:baseAddress:size:name:uuid:.hex + 7651</span><br><span class="line">        x9 &#x3D; 0x0000000000000000</span><br><span class="line">       x10 &#x3D; 0x000000000000005d</span><br><span class="line">       x11 &#x3D; 0x00000001030221d8</span><br><span class="line">       x12 &#x3D; 0x000000000000005d</span><br><span class="line">       x13 &#x3D; 0x0000000000000000</span><br><span class="line">       x14 &#x3D; 0x0000000180964000</span><br><span class="line">       x15 &#x3D; 0x000000020b12c000</span><br><span class="line">       x16 &#x3D; 0x00000001020bf9b2  (void *)0xe12800000001020b</span><br><span class="line">       x17 &#x3D; 0x0000000102067294  Demo_fishhook&#96;-[ViewController test1:] at ViewController.m:144</span><br><span class="line">       x18 &#x3D; 0x0000000000000000</span><br><span class="line">       x19 &#x3D; 0x0000000102709160</span><br><span class="line">       x20 &#x3D; 0x0000000000000000</span><br><span class="line">       x21 &#x3D; 0x00000001f59e3000  UIKitCore&#96;_UIInternalPreference_IdleSchedulerTargetDeadlineFraction</span><br><span class="line">       x22 &#x3D; 0x000000019b10ec13  </span><br><span class="line">       x23 &#x3D; 0x000000019b7043f5  </span><br><span class="line">       x24 &#x3D; 0x0000000000000000</span><br><span class="line">       x25 &#x3D; 0x00000001f630c000  UIKitCore&#96;_UIPreviewPresentationAnimator._startMediaTime</span><br><span class="line">       x26 &#x3D; 0x00000001027083f0</span><br><span class="line">       x27 &#x3D; 0x000000019bb48a24  </span><br><span class="line">       x28 &#x3D; 0x00000001fab5f4e8  CoreFoundation&#96;__NSArray0__struct</span><br><span class="line">        fp &#x3D; 0x000000016dd9da20</span><br><span class="line">        lr &#x3D; 0x000000010206718c  Demo_fishhook&#96;-[ViewController viewDidLoad] + 76 at ViewController.m:84:9</span><br><span class="line">        sp &#x3D; 0x000000016dd9da00</span><br><span class="line">        pc &#x3D; 0x00000001020672ac  Demo_fishhook&#96;-[ViewController test1:] + 24 at ViewController.m:145:16</span><br><span class="line">      cpsr &#x3D; 0x40000000</span><br></pre></td></tr></table></figure>
<p>现在来 debug 看下相关寄存器里面的值，分别看.</p>
<ul>
<li>x0-x7, 存放参数和返回值<ul>
<li>x0 和 x1 存储的是 OC 方法的前两个隐藏入参: self 和 _cmd.  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po 0x0000000102709160</span><br><span class="line">&lt;ViewController: 0x102709160&gt;</span><br><span class="line"></span><br><span class="line">(lldb) po (char *)0x00000001020ab733</span><br><span class="line">&quot;test2:b:&quot; </span><br></pre></td></tr></table></figure></li>
<li> <code>x2 = 0x0000000000000001</code> 存储的值是 1, 主上面的汇编代码使用的 w2, 即 x2 低 32 位(即 000000001), 就是值 1 </li>
<li> 断点指向到 0x1020672c0 处后，<code>x3 = 0x0000000000000002</code>，同 x2, 值 2</li>
</ul>
</li>
<li>pc, 当前断点指向的地址</li>
</ul>
<br/>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000000016f351a20 - 0x000000016f351a00</span><br><span class="line">(long) $13 &#x3D; 0x0000000000000020</span><br></pre></td></tr></table></figure>
<p>fp-sp=0x20, 因为上面开始开辟栈空间 0x30, 但存储 x29 和 x30 用了 0x10, 所以还剩 0x20 大小的空间可用。</p>
<h3 id="callee-test2"><a href="#callee-test2" class="headerlink" title="callee - test2"></a>callee - test2</h3><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/stack/20220930105031.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Demo_fishhook&#96;-[ViewController test2:b:]:</span><br><span class="line">    0x1020672d8 &lt;+0&gt;:  sub    sp, sp, #0x20</span><br><span class="line">    0x1020672dc &lt;+4&gt;:  str    x0, [sp, #0x18]</span><br><span class="line">    0x1020672e0 &lt;+8&gt;:  str    x1, [sp, #0x10]</span><br><span class="line">    0x1020672e4 &lt;+12&gt;: str    w2, [sp, #0xc]</span><br><span class="line">    0x1020672e8 &lt;+16&gt;: str    w3, [sp, #0x8]</span><br><span class="line">-&gt;  0x1020672ec &lt;+20&gt;: ldr    w8, [sp, #0xc]</span><br><span class="line">    0x1020672f0 &lt;+24&gt;: ldr    w9, [sp, #0x8]</span><br><span class="line">    0x1020672f4 &lt;+28&gt;: add    w8, w8, w9</span><br><span class="line">    0x1020672f8 &lt;+32&gt;: str    w8, [sp, #0x4]</span><br><span class="line">    0x1020672fc &lt;+36&gt;: ldr    w0, [sp, #0x4]</span><br><span class="line">    0x102067300 &lt;+40&gt;: add    sp, sp, #0x20</span><br><span class="line">    0x102067304 &lt;+44&gt;: ret    </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">        x0 &#x3D; 0x0000000102709160</span><br><span class="line">        x1 &#x3D; 0x00000001020ab740  &quot;test2:b:&quot;</span><br><span class="line">        x2 &#x3D; 0x0000000000000001</span><br><span class="line">        x3 &#x3D; 0x0000000000000002</span><br><span class="line">        x4 &#x3D; 0x0000000000000010</span><br><span class="line">        x5 &#x3D; 0x0000000000000020</span><br><span class="line">        x6 &#x3D; 0x000000016dd9d8f0</span><br><span class="line">        x7 &#x3D; 0x0000000000000000</span><br><span class="line">        x8 &#x3D; 0x00000001020be000  (void *)0x00000001020ab182: initWithCodeType:baseAddress:size:name:uuid:.hex + 7651</span><br><span class="line">        x9 &#x3D; 0x0000000000000000</span><br><span class="line">       x10 &#x3D; 0x000000000000002e</span><br><span class="line">       x11 &#x3D; 0x0000000103021ee8</span><br><span class="line">       x12 &#x3D; 0x000000000000002e</span><br><span class="line">       x13 &#x3D; 0x0000000000000000</span><br><span class="line">       x14 &#x3D; 0x0000000180964000</span><br><span class="line">       x15 &#x3D; 0x000000020b12c000</span><br><span class="line">       x16 &#x3D; 0x00000001020bf9b2  (void *)0xe12800000001020b</span><br><span class="line">       x17 &#x3D; 0x00000001020672d8  Demo_fishhook&#96;-[ViewController test2:b:] at ViewController.m:149</span><br><span class="line">       x18 &#x3D; 0x0000000000000000</span><br><span class="line">       x19 &#x3D; 0x0000000102709160</span><br><span class="line">       x20 &#x3D; 0x0000000000000000</span><br><span class="line">       x21 &#x3D; 0x00000001f59e3000  UIKitCore&#96;_UIInternalPreference_IdleSchedulerTargetDeadlineFraction</span><br><span class="line">       x22 &#x3D; 0x000000019b10ec13  </span><br><span class="line">       x23 &#x3D; 0x000000019b7043f5  </span><br><span class="line">       x24 &#x3D; 0x0000000000000000</span><br><span class="line">       x25 &#x3D; 0x00000001f630c000  UIKitCore&#96;_UIPreviewPresentationAnimator._startMediaTime</span><br><span class="line">       x26 &#x3D; 0x00000001027083f0</span><br><span class="line">       x27 &#x3D; 0x000000019bb48a24  </span><br><span class="line">       x28 &#x3D; 0x00000001fab5f4e8  CoreFoundation&#96;__NSArray0__struct</span><br><span class="line">        fp &#x3D; 0x000000016dd9da20</span><br><span class="line">        lr &#x3D; 0x00000001020672c4  Demo_fishhook&#96;-[ViewController test1:] + 48 at ViewController.m:145:9</span><br><span class="line">        sp &#x3D; 0x000000016dd9d9e0</span><br><span class="line">        pc &#x3D; 0x00000001020672ec  Demo_fishhook&#96;-[ViewController test2:b:] + 20 at ViewController.m:151:15</span><br><span class="line">      cpsr &#x3D; 0x40000000</span><br><span class="line"></span><br><span class="line">(lldb)  </span><br></pre></td></tr></table></figure>
<br/>

<p>继续来看寄存器的值</p>
<ul>
<li>x0-x7, 存放参数和返回值<ul>
<li>x0 x1 跟 test1 一样，它们两个的 x0 值都是 0x0000000102709160</li>
<li>x2 = 0x0000000000000001, 入参 a 的值为 1</li>
<li>x3 = 0x0000000000000002, 入参 b 的值为 2</li>
<li>返回值，当断点在 <code>0x102067304</code> 的时候，变化的寄存器值如下，x0 就是返回值<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x0 &#x3D; 0x0000000100f0ac70</span><br><span class="line">x8 &#x3D; 0x0000000100a26000  (void *)0x0000000100a13182: initWithCodeType:baseAddress:size:name:uuid:.hex + 7651</span><br><span class="line">x9 &#x3D; 0x0000000000000000</span><br><span class="line">sp &#x3D; 0x000000016f4359e0</span><br><span class="line">pc &#x3D; 0x00000001009cf2ec  Demo_fishhook&#96;-[ViewController test2:b:] + 20 at ViewController.m:151:15</span><br></pre></td></tr></table></figure>
sp 和 pc 变化是可以理解的，因为回退栈空间了；但 x8 和 x9 也发生变化就不知道原因了</li>
</ul>
</li>
<li>fp = 0x000000016dd9da20, 跟 test1 的 fp 值相同</li>
<li>lr = 0x00000001020672c4, 就是 test1 处的 0x1020672c4(即函数跳转处的下一条指令)</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>lr 寄存器存储的是函数返回值，根据 lr 可以回溯到上个函数</li>
<li>test2 没有存储 x29 x30 到栈中, 而 test1 则有存储；因为 test2 是<code>叶子函数</code>，它里面没有调用其他函数。函数调用会用到 bl, 而 bl 则会把下一条指令的地址存入 x30 寄存器，会改变 x30 的值，所以出于保护现场的目的需要提前保存 x30 的值。而这里没有函数调用，意味着不会改变 x30, 所以就没有存储 x30 的意义了。</li>
<li>关于 fp 也是一个有趣的点，分别在 viewDidLoad 和 test1 处下断点，见下图<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/stack/20220930115939.png"></li>
</ol>
<ul>
<li>viewDidLoad.fp = 0x000000016f705a60</li>
<li>test1.fp = 0x000000016f705a20</li>
<li>由于 fp 是指针，那就看它所指向地址存储的数据（x 0x000000016f705a20）：<code>0x16f705a20: 60 5a 70 6f 01 00 00 00</code>, 因为是小端，所有读取出来就是 <code>0x016f705a60</code>(viewDidLoad.fp)，从而验证了该函数的 fp 指向上个函数的 fp</li>
<li><code>0x16f705a8: 8c f1 6f 00 01 00 00 00</code> 就是 <code>0x01006ff18c</code> (test1.lr)，因为在 x29 x30 在 test1 里面就是连续存储的，见 <code>stp    x29, x30, [sp, #0x20]</code></li>
</ul>
<h1 id="获取函数调用栈"><a href="#获取函数调用栈" class="headerlink" title="获取函数调用栈"></a>获取函数调用栈</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>根据前面的 <code>Arm64/Demo/总结</code> 可知，如果要获取函数调用栈的话，首先要找到当前函数的 pc 和 lr 指针。</p>
<ol>
<li>获取当前函数的 pc, 得到当前函数的地址</li>
<li>根据 lr 得到上个函数的地址</li>
<li>循环进行 2 步，直到 lr 为空</li>
<li>拿到相关地址后符号化</li>
</ol>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>从易后难，先看符号化的逻辑。</p>
<h3 id="符号化"><a href="#符号化" class="headerlink" title="符号化"></a>符号化</h3><p>看上面的 <code>Arm64/Demo</code>, 如果在 test2 获取的话，相关寄存器的值如下</p>
<ol>
<li>pc: 0x00000001020672ec</li>
<li>lr: 0x00000001020672c4</li>
</ol>
<p>而 test2 和 test1 的函数地址分别是</p>
<ol>
<li>0x1020672d8</li>
<li>0x102067294</li>
</ol>
<p>也就是说获取的地址值是大于实际地址值的，那这要怎么处理呢？带着这个问题，看下经典库 <a href="https://github.com/kstenerud/KSCrash/blob/498aa21d23541b0bb4990f8d3d20bea2c280a18b/Source/KSCrash/Recording/Tools/KSDynamicLinker.c#L232">KSCrash</a> 是怎么处理的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">bool ksdl_dladdr(const uintptr_t address, Dl_info* const info)</span><br><span class="line">&#123;</span><br><span class="line">    info-&gt;dli_fname &#x3D; NULL;</span><br><span class="line">    info-&gt;dli_fbase &#x3D; NULL;</span><br><span class="line">    info-&gt;dli_sname &#x3D; NULL;</span><br><span class="line">    info-&gt;dli_saddr &#x3D; NULL;</span><br><span class="line">	&#x2F;&#x2F; 在哪个 image</span><br><span class="line">    const uint32_t idx &#x3D; imageIndexContainingAddress(address);</span><br><span class="line">    if(idx &#x3D;&#x3D; UINT_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    const struct mach_header* header &#x3D; _dyld_get_image_header(idx);</span><br><span class="line">    &#x2F;&#x2F; ALSR 值</span><br><span class="line">    const uintptr_t imageVMAddrSlide &#x3D; (uintptr_t)_dyld_get_image_vmaddr_slide(idx);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 就是没有 ALSR 的 VMaddress</span><br><span class="line">    const uintptr_t addressWithSlide &#x3D; address - imageVMAddrSlide;</span><br><span class="line">    &#x2F;&#x2F; 虚拟基地址+ALSR值, 就是包含 ALSR 的虚拟内存地址, 其实就是 header, 验证结果见下面 segmentBase fishhook</span><br><span class="line">    const uintptr_t segmentBase &#x3D; segmentBaseOfImageIndex(idx) + imageVMAddrSlide;</span><br><span class="line">    if(segmentBase &#x3D;&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info-&gt;dli_fname &#x3D; _dyld_get_image_name(idx);</span><br><span class="line">    info-&gt;dli_fbase &#x3D; (void*)header;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Find symbol tables and get whichever symbol is closest to the address.</span><br><span class="line">    const nlist_t* bestMatch &#x3D; NULL;</span><br><span class="line">    uintptr_t bestDistance &#x3D; ULONG_MAX;</span><br><span class="line">    uintptr_t cmdPtr &#x3D; firstCmdAfterHeader(header);</span><br><span class="line">    if(cmdPtr &#x3D;&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    for(uint32_t iCmd &#x3D; 0; iCmd &lt; header-&gt;ncmds; iCmd++)</span><br><span class="line">    &#123;</span><br><span class="line">        const struct load_command* loadCmd &#x3D; (struct load_command*)cmdPtr;</span><br><span class="line">        &#x2F;&#x2F; 符号表查询</span><br><span class="line">        if(loadCmd-&gt;cmd &#x3D;&#x3D; LC_SYMTAB)</span><br><span class="line">        &#123;</span><br><span class="line">            const struct symtab_command* symtabCmd &#x3D; (struct symtab_command*)cmdPtr;</span><br><span class="line">            const nlist_t* symbolTable &#x3D; (nlist_t*)(segmentBase + symtabCmd-&gt;symoff);</span><br><span class="line">            const uintptr_t stringTable &#x3D; segmentBase + symtabCmd-&gt;stroff;</span><br><span class="line"></span><br><span class="line">            for(uint32_t iSym &#x3D; 0; iSym &lt; symtabCmd-&gt;nsyms; iSym++)</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; If n_value is 0, the symbol refers to an external object.</span><br><span class="line">                if(symbolTable[iSym].n_value !&#x3D; 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 符号表的值，是不包含 ASLR 值的，所以上面 addressWithSlide 是要减去 ASLR</span><br><span class="line">                    uintptr_t symbolBase &#x3D; symbolTable[iSym].n_value;</span><br><span class="line">                    &#x2F;&#x2F; 两种相减，找距离最近的</span><br><span class="line">                    uintptr_t currentDistance &#x3D; addressWithSlide - symbolBase;</span><br><span class="line">                    &#x2F;*</span><br><span class="line">                	&#96;(addressWithSlide &gt;&#x3D; symbolBase)&#96; : 因为 symbolBase 是具体符号值；而 addressWithSlide 则是需要查找的地址值, 二者可能想到，所以是 &gt;&#x3D; symbolBase</span><br><span class="line">                	(currentDistance &lt;&#x3D; bestDistance) : 寻找最匹配的，距离越近越好</span><br><span class="line">                	*&#x2F;</span><br><span class="line">                    if((addressWithSlide &gt;&#x3D; symbolBase) &amp;&amp;</span><br><span class="line">                       (currentDistance &lt;&#x3D; bestDistance))</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#x2F;&#x2F; iSym 符号表的下标，跟 fishhook 里面的字符串计算是一样的道理</span><br><span class="line">                        bestMatch &#x3D; symbolTable + iSym;</span><br><span class="line">                        bestDistance &#x3D; currentDistance;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if(bestMatch !&#x3D; NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; + imageVMAddrSlide(ASLR值)，因为前面 addressWithSlide 有减去 imageVMAddrSlide ASLR 值</span><br><span class="line">                info-&gt;dli_saddr &#x3D; (void*)(bestMatch-&gt;n_value + imageVMAddrSlide);</span><br><span class="line">                if(bestMatch-&gt;n_desc &#x3D;&#x3D; 16)</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; This image has been stripped. The name is meaningless, and</span><br><span class="line">                    &#x2F;&#x2F; almost certainly resolves to &quot;_mh_execute_header&quot;</span><br><span class="line">                    info-&gt;dli_sname &#x3D; NULL;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 过掉符号修饰的前面的 &#96;_&#96;。</span><br><span class="line">                    info-&gt;dli_sname &#x3D; (char*)((intptr_t)stringTable + (intptr_t)bestMatch-&gt;n_un.n_strx);</span><br><span class="line">                    if(*info-&gt;dli_sname &#x3D;&#x3D;addressWithSlide - &#39;_&#39;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        info-&gt;dli_sname++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 继续匹配下一个符号</span><br><span class="line">        cmdPtr +&#x3D; loadCmd-&gt;cmdsize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码可知，跟 fishhook 查找符号表原理是类似的，就是用 lr 的地址值到符号表里一一匹配，找到比 lr 地址值小并离 lr 地址值最近的那个符号就是该函数的符号。</p>
<h3 id="获取线程信息"><a href="#获取线程信息" class="headerlink" title="获取线程信息"></a>获取线程信息</h3><p>因为 KSCrash 这块的代码比较多，现在还没捋顺，于是就找到了《<a href="https://time.geekbang.org/column/intro/100024501?tab=catalog">iOS 开发高手课</a>》作者的 <a href="https://github.com/ming1016/DecoupleDemo/blob/master/DecoupleDemo/SMCallStack.m#L103">SMCallStack.m</a></p>
<br/>

<p>大致逻辑(只针对 Arm64 架构)如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">typedef struct SMStackFrame &#123;</span><br><span class="line">    const struct SMStackFrame *const previous;</span><br><span class="line">    const uintptr_t return_address;</span><br><span class="line">&#125; SMStackFrame;</span><br><span class="line"></span><br><span class="line">NSString *smStackOfThread(thread_t thread) &#123;</span><br><span class="line">    uintptr_t buffer[100];</span><br><span class="line">    int i &#x3D; 0;</span><br><span class="line">    _STRUCT_MCONTEXT64 machineContext;</span><br><span class="line">    mach_msg_type_number_t state_count &#x3D; ARM_THREAD_STATE64_COUNT;</span><br><span class="line">    kern_return_t kr &#x3D; thread_get_state(thread, ARM_THREAD_STATE64, (thread_state_t)&amp;machineContext.__ss, &amp;state_count);</span><br><span class="line">    if (kr !&#x3D; KERN_SUCCESS) &#123;</span><br><span class="line">        return [NSString stringWithFormat:@&quot;Fail get thread: %u&quot;, thread];</span><br><span class="line">    &#125;</span><br><span class="line">    const uintptr_t instructionAddress &#x3D; machineContext.__ss.__pc;</span><br><span class="line">    buffer[i++] &#x3D; instructionAddress;</span><br><span class="line">    uintptr_t linkRegisterPointer &#x3D; machineContext.__ss.__lr;</span><br><span class="line">    if (linkRegisterPointer) &#123;</span><br><span class="line">        buffer[i++] &#x3D; linkRegisterPointer;</span><br><span class="line">    &#125;</span><br><span class="line">    SMStackFrame stackFrame &#x3D; &#123;0&#125;;</span><br><span class="line">    const uintptr_t framePointer &#x3D; machineContext.__ss.__fp;</span><br><span class="line">    </span><br><span class="line">    vm_size_t bytesCopied &#x3D; 0;</span><br><span class="line">    if (framePointer &#x3D;&#x3D; 0 || vm_read_overwrite(mach_task_self(), (vm_address_t)(void *)framePointer, (vm_size_t)sizeof(stackFrame), (vm_address_t)&amp;stackFrame, &amp;bytesCopied) !&#x3D; KERN_SUCCESS) &#123;</span><br><span class="line">        return @&quot;Fail frame pointer&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bytesCopied &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    for (; ; i++) &#123;</span><br><span class="line">        buffer[i] &#x3D; stackFrame.return_address;</span><br><span class="line">        if (buffer[i] &#x3D;&#x3D; 0 || stackFrame.previous &#x3D;&#x3D; 0 || vm_read_overwrite(mach_task_self(), (vm_address_t)(void *)stackFrame.previous, (vm_size_t)sizeof(stackFrame), (vm_address_t)&amp;stackFrame, &amp;bytesCopied) !&#x3D; KERN_SUCCESS) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; xxxxx</span><br><span class="line">    return @&quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码大致逻辑能看懂：根据系统函数获取 pc fp lr, 再循环获取 lr 加入数组。<br>但不知道为什么要这样写，只能找到根据大佬的代码去搜索相关资料，基本都是操作系统领域的相关知识。</p>
<h4 id="STRUCT-MCONTEXT64"><a href="#STRUCT-MCONTEXT64" class="headerlink" title="_STRUCT_MCONTEXT64"></a>_STRUCT_MCONTEXT64</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#define _STRUCT_MCONTEXT64      struct __darwin_mcontext64</span><br><span class="line">_STRUCT_MCONTEXT64</span><br><span class="line">&#123;</span><br><span class="line">	_STRUCT_ARM_EXCEPTION_STATE64   __es;</span><br><span class="line">	_STRUCT_ARM_THREAD_STATE64      __ss;</span><br><span class="line">	_STRUCT_ARM_NEON_STATE64        __ns;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">_STRUCT_ARM_THREAD_STATE64</span><br><span class="line">&#123;</span><br><span class="line">	__uint64_t __x[29]; &#x2F;* General purpose registers x0-x28 *&#x2F;</span><br><span class="line">	__uint64_t __fp;    &#x2F;* Frame pointer x29 *&#x2F;</span><br><span class="line">	__uint64_t __lr;    &#x2F;* Link register x30 *&#x2F;</span><br><span class="line">	__uint64_t __sp;    &#x2F;* Stack pointer x31 *&#x2F;</span><br><span class="line">	__uint64_t __pc;    &#x2F;* Program counter *&#x2F;</span><br><span class="line">	__uint32_t __cpsr;  &#x2F;* Current program status register *&#x2F;</span><br><span class="line">	__uint32_t __pad;   &#x2F;* Same size for 32-bit or 64-bit clients *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>获取线程寄存器相关信息。</p>
<h4 id="thread-get-state"><a href="#thread-get-state" class="headerlink" title="thread_get_state"></a>thread_get_state</h4><p>在 <a href="https://github.com/apple-oss-distributions/xnu/blob/main/libsyscall/wrappers/thread_register_state.c#L63">xnu</a> 源码中找到了搜索到了蛛丝马迹，获取到 state 内容后使用相关寄存器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#if defined(__i386__)</span><br><span class="line">	i386_thread_state_t state &#x3D; &#123;&#125;;</span><br><span class="line">	thread_state_flavor_t flavor &#x3D; x86_THREAD_STATE32;</span><br><span class="line">	mach_msg_type_number_t count &#x3D; i386_THREAD_STATE_COUNT;</span><br><span class="line">#elif defined(__x86_64__)</span><br><span class="line">	x86_thread_state64_t state &#x3D; &#123;&#125;;</span><br><span class="line">	thread_state_flavor_t flavor &#x3D; x86_THREAD_STATE64;</span><br><span class="line">	mach_msg_type_number_t count &#x3D; x86_THREAD_STATE64_COUNT;</span><br><span class="line">#elif defined(__arm__)</span><br><span class="line">	arm_thread_state_t state &#x3D; &#123;&#125;;</span><br><span class="line">	thread_state_flavor_t flavor &#x3D; ARM_THREAD_STATE;</span><br><span class="line">	mach_msg_type_number_t count &#x3D; ARM_THREAD_STATE_COUNT;</span><br><span class="line">#elif defined(__arm64__)</span><br><span class="line">	arm_thread_state64_t state &#x3D; &#123;&#125;;</span><br><span class="line">	thread_state_flavor_t flavor &#x3D; ARM_THREAD_STATE64;</span><br><span class="line">	mach_msg_type_number_t count &#x3D; ARM_THREAD_STATE64_COUNT;</span><br><span class="line">#else</span><br><span class="line">#error thread_get_register_pointer_values not defined for this architecture</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	kern_return_t ret &#x3D; thread_get_state(thread, flavor, (thread_state_t)&amp;state, &amp;count);</span><br><span class="line">	</span><br><span class="line">&#x2F;&#x2F;	xxxx</span><br><span class="line">if (sp) &#123;</span><br><span class="line">		uintptr_t __sp &#x3D; arm_thread_state64_get_sp(state);</span><br><span class="line">		if (__sp &gt; 128) &#123;</span><br><span class="line">			*sp &#x3D; __sp - 128 &#x2F;* redzone *&#x2F;;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			*sp &#x3D; 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	push_register_value(arm_thread_state64_get_lr(state));</span><br><span class="line"></span><br><span class="line">	for (int i &#x3D; 0; i &lt; 29; i++) &#123;</span><br><span class="line">		push_register_value(state.__x[i]);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="vm-read-overwrite"><a href="#vm-read-overwrite" class="headerlink" title="vm_read_overwrite"></a>vm_read_overwrite</h4><p><a href="http://web.mit.edu/darwin/src/modules/xnu/osfmk/man/vm_read.html">vm_read_overwrite</a></p>
<blockquote>
<p>The vm_read and vm_read_overwrite functions read a portion of a task’s virtual memory (they enable tasks to read other tasks’ memory). The vm_read function returns the data in a dynamically allocated array of bytes; the vm_read_overwrite function places the data into a caller-specified buffer (the data_in parameter).</p>
</blockquote>
<p>上面的代码就是调用系统函数 <code>vm_read_overwrite</code> 从 fp 的位置开始读取内存，给 <code>SMStackFrame</code> 结构体赋值，从而得到 lr, 再根据 lr 递归调用获取整个函数的调用链。 </p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="ksdl-dladdr"><a href="#ksdl-dladdr" class="headerlink" title="ksdl_dladdr"></a>ksdl_dladdr</h2><p>从上面的调试可知，<code>dladdr</code> 就是 <code>lldb</code> 命令 <code>image lookup -a 0x00xxx</code> 的代码实现，二者功能是类似的。<br><br/></p>
<blockquote>
<p>NAME<br>     dladdr – find the image containing a given address</p>
</blockquote>
<p>上面是在终端使用 <code>man dladdr</code> 得到的内容。</p>
<p>有一个问题：为什么不使用系统的 <code>dladdr</code> 函数？而要自己实现 <code>ksdl_dladdr</code> 呢？<br>找到了相关问题 <a href="https://github.com/bestswifter/BSBacktraceLogger/issues/8">BSBacktraceLogger - 请问为什么不用系统提供的dladdr方法，而需要自己写一个fl_dladdr呢？ #8</a>，但作者没有给出有用的答案。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** async-safe version of dladdr.</span><br><span class="line"> *</span><br><span class="line"> * This method searches the dynamic loader for information about any image</span><br><span class="line"> * containing the specified address. It may not be entirely successful in</span><br><span class="line"> * finding information, in which case any fields it could not find will be set</span><br><span class="line"> * to NULL.</span><br><span class="line"> *</span><br><span class="line"> * Unlike dladdr(), this method does not make use of locks, and does not call</span><br><span class="line"> * async-unsafe functions.</span><br><span class="line"> *</span><br><span class="line"> * @param address The address to search for.</span><br><span class="line"> * @param info Gets filled out by this function.</span><br><span class="line"> * @return true if at least some information was found.</span><br><span class="line"> *&#x2F;</span><br><span class="line">bool ksdl_dladdr(const uintptr_t address, Dl_info* const info);</span><br></pre></td></tr></table></figure>
<p>看 <code>ksdl_dladdr</code> 的声明可知，从侧面反应系统的 <code>dladdr</code> 是同步的，会使用锁，可能会导致耗时。</p>
<p>有兴趣的可以查看 <a href="https://github.com/apple-oss-distributions/dyld/blob/f73171cf0a177f453fdb124952908fe83864acab/dyld/DyldAPIs.cpp#L1016">dyld</a> 里面关于 <code>dladdr</code> 的实现。</p>
<h2 id="lldb-backtrace-thread"><a href="#lldb-backtrace-thread" class="headerlink" title="lldb backtrace thread"></a>lldb backtrace thread</h2><p>不管是 <a href="https://github.com/ming1016/DecoupleDemo/blob/master/DecoupleDemo/SMCallStack.m#L103">SMCallStack</a> 还是 <a href="https://github.com/bestswifter/BSBacktraceLogger/issues/8">BSBacktraceLogger</a> 输出结果跟 <code>lldb bt</code> 的结果还是有些差异的，可能跟着两个库代码很久没更新有关系，<a href="https://github.com/microsoft/plcrashreporter">plcrashreporter</a> 的输出结果最接近（因为不知道怎么根据 KSCrash 直接获取调用堆栈），代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PLCrashReporterConfig *config &#x3D; [[PLCrashReporterConfig alloc] initWithSignalHandlerType:PLCrashReporterSignalHandlerTypeBSD symbolicationStrategy:PLCrashReporterSymbolicationStrategyAll];</span><br><span class="line">    PLCrashReporter *crashReporter &#x3D; [[PLCrashReporter alloc] initWithConfiguration:config];</span><br><span class="line">    NSData *data &#x3D; [crashReporter generateLiveReport];</span><br><span class="line">    PLCrashReport *reporter &#x3D; [[PLCrashReport alloc] initWithData:data error:NULL];</span><br><span class="line">    NSString *report &#x3D; [PLCrashReportTextFormatter stringValueForCrashReport:reporter</span><br><span class="line">withTextFormat:PLCrashReportTextFormatiOS];</span><br></pre></td></tr></table></figure>
<br>

<p>所以，就想找到 <code>lldb backtrace thread</code> 的源码实现。<br>下载 <a href="https://github.com/apple-oss-distributions/lldb">lldb</a> 工程，然后搜索 <code>Backtrace thread</code> 找到如下相关代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lldb::ThreadSP</span><br><span class="line">    GetExtendedBacktraceThread (ConstString type);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ----</span><br><span class="line">uint32_t</span><br><span class="line">SBThread::GetExtendedBacktraceOriginatingIndexID ()</span><br><span class="line">&#123;</span><br><span class="line">    ThreadSP thread_sp(m_opaque_sp-&gt;GetThreadSP());</span><br><span class="line">    if (thread_sp)</span><br><span class="line">        return thread_sp-&gt;GetExtendedBacktraceOriginatingIndexID();</span><br><span class="line">    return LLDB_INVALID_INDEX32;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ----</span><br><span class="line">typedef std::shared_ptr&lt;lldb_private::Thread&gt; ThreadSP;</span><br></pre></td></tr></table></figure>
<p>坑爹，看到 <code>lldb_private</code> 就知道凉凉了，因为它是私有的，只在 llvm 官网找到了相关定义 <a href="https://lldb.llvm.org/cpp_reference/classlldb__private_1_1Thread.html">lldb_private::Thread Class Reference</a>。</p>
<p>后面又想过是否可以通过查看 GDB 的源码来查看 <code>backtrace thread</code> 的源码实现，嗯，是个好想法！！！</p>
<h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h2><p>我们知道，OC 的方法调用最终都会走 <code>objc_msgSend</code> 这个汇编实现的函数，那为什么它没有出现在调用堆栈里面呢？<br>可以猜测下答案：因为 <code>objc_msgSend</code> 不会使用栈空间。<br>下面来 debug 调试下，还是前面 <code>viewDidLoad</code> 调用 <code>test1</code> 的例子，分别对比在这两个函数汇编下寄存器的值。</p>
<hr>
<p>call test1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Demo_fishhook&#96;-[ViewController viewDidLoad]:</span><br><span class="line">    0x104e32f58 &lt;+0&gt;:   sub    sp, sp, #0x40</span><br><span class="line">    0x104e32f5c &lt;+4&gt;:   stp    x29, x30, [sp, #0x30]</span><br><span class="line">    0x104e32f60 &lt;+8&gt;:   add    x29, sp, #0x30</span><br><span class="line">    0x104e32f64 &lt;+12&gt;:  stur   x0, [x29, #-0x8]</span><br><span class="line">    0x104e32f68 &lt;+16&gt;:  stur   x1, [x29, #-0x10]</span><br><span class="line">    0x104e32f6c &lt;+20&gt;:  ldur   x8, [x29, #-0x8]</span><br><span class="line">    0x104e32f70 &lt;+24&gt;:  add    x0, sp, #0x10</span><br><span class="line">    0x104e32f74 &lt;+28&gt;:  str    x8, [sp, #0x10]</span><br><span class="line">    0x104e32f78 &lt;+32&gt;:  adrp   x8, 89</span><br><span class="line">    0x104e32f7c &lt;+36&gt;:  ldr    x8, [x8, #0x6c0]</span><br><span class="line">    0x104e32f80 &lt;+40&gt;:  str    x8, [sp, #0x18]</span><br><span class="line">    0x104e32f84 &lt;+44&gt;:  adrp   x8, 88</span><br><span class="line">    0x104e32f88 &lt;+48&gt;:  ldr    x1, [x8, #0xbe8]</span><br><span class="line">    0x104e32f8c &lt;+52&gt;:  bl     0x104e730a4               ; symbol stub for: objc_msgSendSuper2</span><br><span class="line">    0x104e32f90 &lt;+56&gt;:  ldur   x0, [x29, #-0x8]</span><br><span class="line">    0x104e32f94 &lt;+60&gt;:  adrp   x8, 88</span><br><span class="line">    0x104e32f98 &lt;+64&gt;:  ldr    x1, [x8, #0xbf0]</span><br><span class="line">    0x104e32f9c &lt;+68&gt;:  mov    w2, #0x1</span><br><span class="line">-&gt;  0x104e32fa0 &lt;+72&gt;:  bl     0x104e73098               ; symbol stub for: objc_msgSend</span><br><span class="line">    0x104e32fa4 &lt;+76&gt;:  str    w0, [sp, #0xc]</span><br><span class="line">    0x104e32fa8 &lt;+80&gt;:  ldr    w9, [sp, #0xc]</span><br><span class="line">    0x104e32fac &lt;+84&gt;:  mov    x8, x9</span><br><span class="line">    0x104e32fb0 &lt;+88&gt;:  adrp   x0, 81</span><br><span class="line">    0x104e32fb4 &lt;+92&gt;:  add    x0, x0, #0x440            ; @&quot;res: %d&quot;</span><br><span class="line">    0x104e32fb8 &lt;+96&gt;:  mov    x9, sp</span><br><span class="line">    0x104e32fbc &lt;+100&gt;: str    x8, [x9]</span><br><span class="line">    0x104e32fc0 &lt;+104&gt;: bl     0x104e72720               ; symbol stub for: NSLog</span><br><span class="line">    0x104e32fc4 &lt;+108&gt;: ldp    x29, x30, [sp, #0x30]</span><br><span class="line">    0x104e32fc8 &lt;+112&gt;: add    sp, sp, #0x40</span><br><span class="line">    0x104e32fcc &lt;+116&gt;: ret    </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br></pre></td></tr></table></figure>
<hr>
<p>objc_msgSend</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Demo_fishhook&#96;objc_msgSend:</span><br><span class="line">-&gt;  0x104e73098 &lt;+0&gt;: nop    </span><br><span class="line">    0x104e7309c &lt;+4&gt;: ldr    x16, #0xd6e4              ; (void *)0x0000000198569ce0: objc_msgSend</span><br><span class="line">    0x104e730a0 &lt;+8&gt;: br     x16</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) si</span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br></pre></td></tr></table></figure>
<p>对比发现两者变化的仅仅是 <code>lr</code> 和 <code>pc</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; test1</span><br><span class="line">lr &#x3D; 0x0000000104e32f90  Demo_fishhook&#96;-[ViewController viewDidLoad] + 56 at ViewController.m:84:16</span><br><span class="line">pc &#x3D; 0x0000000104e32fa0  Demo_fishhook&#96;-[ViewController viewDidLoad] + 72 at ViewController.m:84:15</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; objc_msgSend</span><br><span class="line">lr &#x3D; 0x0000000104e32fa4  Demo_fishhook&#96;-[ViewController viewDidLoad] + 76 at ViewController.m:84:9</span><br><span class="line">pc &#x3D; 0x0000000104e73098  Demo_fishhook&#96;symbol stub for: objc_msgSend</span><br></pre></td></tr></table></figure>
<p>经过上面的输出可知，<code>objc_msgSend</code> 共用当前函数的栈空间，没有产生新的栈空间，所以就不会出现在函数调用栈里面了，所以，这是 <code>objc_msgSend</code> 用汇编实现的原因之一吗？</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a></li>
<li><a href="https://github.com/ARM-software/abi-aa/blob/60a8eb8c55e999d74dac5e368fc9d7e36e38dda4/aapcs64/aapcs64.rst#the-stack">Procedure Call Standard for the Arm® 64-bit Architecture (AArch64)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Calling_convention#ARM_(A64)">Calling_convention#ARM_(A64)</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%AF%84%E5%AD%98%E5%99%A8">寄存器</a></li>
<li><a href="https://time.geekbang.org/column/intro/100024501?tab=catalog">iOS 开发高手课</a></li>
<li><a href="https://blackteachinese.github.io/2017/07/12/arm64/">10分钟入门arm64汇编</a></li>
<li><a href="https://github.com/bestswifter/BSBacktraceLogger/issues/8">BSBacktraceLogger - 请问为什么不用系统提供的dladdr方法，而需要自己写一个fl_dladdr呢？ #8</a></li>
<li><a href="https://github.com/apple-oss-distributions/dyld/blob/f73171cf0a177f453fdb124952908fe83864acab/dyld/DyldAPIs.cpp#L1016">dyld</a></li>
<li><a href="https://github.com/ming1016/DecoupleDemo/blob/master/DecoupleDemo/SMCallStack.m#L103">SMCallStack</a></li>
<li><a href="https://github.com/kstenerud/KSCrash/blob/498aa21d23541b0bb4990f8d3d20bea2c280a18b/Source/KSCrash/Recording/Tools/KSDynamicLinker.c#L232">KSCrash</a></li>
<li><a href="https://github.com/microsoft/plcrashreporter">plcrashreporter</a></li>
<li><a href="https://github.com/apple-oss-distributions/lldb">lldb</a></li>
<li><a href="http://djs66256.github.io/2018/01/21/2018-01-21-%E8%BF%90%E8%A1%8C%E6%97%B6%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88/">运行时获取函数调用栈</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/20/fishhook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/20/fishhook/" class="post-title-link" itemprop="url">从 Fishhook 学到了什么？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-20 10:10:39" itemprop="dateCreated datePublished" datetime="2022-09-20T10:10:39+08:00">2022-09-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近把《<a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a>》这本书又重新温习了下，加深了对可执行文件的理解，这篇文章就结合 <a href="https://github.com/facebook/fishhook">fishhook</a> 来实践一下。</p>
<h1 id="Demo-NSLog"><a href="#Demo-NSLog" class="headerlink" title="Demo - NSLog"></a>Demo - NSLog</h1><p>先从一个 NSLog 的 Demo 实践开始，讲解调用系统库函数 <code>NSLog</code> 的执行流程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    NSString * appDelegateClassName;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        &#x2F;&#x2F; Setup code that might create autoreleased objects goes here.</span><br><span class="line">        appDelegateClassName &#x3D; NSStringFromClass([AppDelegate class]);</span><br><span class="line">        NSLog(@&quot;%@&quot;, @&quot;hello world&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return UIApplicationMain(argc, argv, nil, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="lldb"><a href="#lldb" class="headerlink" title="lldb"></a>lldb</h2><p>在 NSLog 处下断点，并在 Xcode 设置 <code>debug -&gt; debug workflow -&gt; always show disassembly</code> 查看其汇编实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    0x10fcf0a79 &lt;+89&gt;:  leaq   0x26f20(%rip), %rdi       ; @&quot;%@&quot;</span><br><span class="line">    0x10fcf0a80 &lt;+96&gt;:  leaq   0x26f39(%rip), %rsi       ; @&quot;hello world&quot;</span><br><span class="line">-&gt;  0x10fcf0a87 &lt;+103&gt;: movb   $0x0, %al</span><br><span class="line">    0x10fcf0a89 &lt;+105&gt;: callq  0x10fd12000               ; symbol stub for: NSLog</span><br><span class="line">    0x10fcf0a8e &lt;+110&gt;: movq   -0x20(%rbp), %rdi</span><br><span class="line">    0x10fcf0a92 &lt;+114&gt;: callq  0x10fd122ac               ; symbol stub for: objc_autoreleasePoolPop</span><br></pre></td></tr></table></figure>
<p>在 <code>0x10fd12000</code> 处下断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b 0x10fd12000</span><br><span class="line">Breakpoint 3: where &#x3D; Demo_fishhook&#96;symbol stub for: NSLog, address &#x3D; 0x000000010fd12000</span><br></pre></td></tr></table></figure>
<p>单步执行过掉 <code>NSLog</code> 处的断点，到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Demo_fishhook&#96;NSLog:</span><br><span class="line">-&gt;  0x10fd12000 &lt;+0&gt;: jmpq   *0x50ea(%rip)             ; (void *)0x00007fff207ee762: NSLog</span><br></pre></td></tr></table></figure>
<p>这条指令的意思获取 <code>rip + 0x50ea</code> 地址(A)，然后跳转到该地址存储的值(B)（类比二级指针）。</p>
<p>那我们先找出 rip 的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax &#x3D; 0x0000600002f3e400</span><br><span class="line">       rbx &#x3D; 0x000000010fda3060</span><br><span class="line">       rcx &#x3D; 0x0000000114fbf600  dyld&#96;_main_thread</span><br><span class="line">       rdx &#x3D; 0x000000000000002c</span><br><span class="line">       rdi &#x3D; 0x000000010fd179a0  @&quot;%@&quot;</span><br><span class="line">       rsi &#x3D; 0x000000010fd179c0  @&quot;hello world&quot;</span><br><span class="line">       rbp &#x3D; 0x00007ff7b0212ca0</span><br><span class="line">       rsp &#x3D; 0x00007ff7b0212c78</span><br><span class="line">        r8 &#x3D; 0x00007fff862a40c0  libsystem_pthread.dylib&#96;_pthread_keys</span><br><span class="line">        r9 &#x3D; 0x0000000000000000</span><br><span class="line">       r10 &#x3D; 0x00007fff862da642  (void *)0xe6b800007fff862d</span><br><span class="line">       r11 &#x3D; 0x00007fff2019c15c  libobjc.A.dylib&#96;-[NSObject autorelease]</span><br><span class="line">       r12 &#x3D; 0x0000000114fbf3a0  dyld&#96;_NSConcreteStackBlock</span><br><span class="line">       r13 &#x3D; 0x00007ff7b0212d68</span><br><span class="line">       r14 &#x3D; 0x000000010ff98e14  dyld_sim&#96;start_sim</span><br><span class="line">       r15 &#x3D; 0x0000000114fb3010  dyld&#96;dyld4::sConfigBuffer</span><br><span class="line">       rip &#x3D; 0x000000010fd12000  Demo_fishhook&#96;symbol stub for: NSLog</span><br><span class="line">    rflags &#x3D; 0x0000000000000246</span><br><span class="line">        cs &#x3D; 0x000000000000002b</span><br><span class="line">        fs &#x3D; 0x0000000000000000</span><br><span class="line">        gs &#x3D; 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>当前指令还卡在 <code>0x000000010fd12000</code> 处，所以 rip 还是它。那怎么知道 <code>0x000000010fd12000</code> 下一条指令的地址呢？也就是 <code>0x000000010fd12000</code> 这条指令的长度（PS: 按道理应该有文档能找到 AT&amp;T X86-64 汇编 jmpq 指令的长度，但没搜到）。<br>后面用 <code>lldb dis</code> 乱猜一通，于是就有了下面的结果。<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923110933.png"></p>
<p><code>0x10fd12000</code> 下一条指令是 <code>0x10fd12006</code>，所以地址(A)就是 <code>0x000000010fd170f0</code>，而 <code>0x000000010fd170f0</code> 里面存储的值(B)就是 <code>0x00007fff207ee762</code>，在系统库 <code>Foundation</code> 里面，也就是找到 <code>NSLog</code> 的实现了。这跟 <a href="https://zhang759740844.github.io/2019/07/07/fishhook/">fishhook 源码解析</a> 里面提到的第一次会通过 <code>__stub_helper</code> 去查找不符合，这里 <code>__DATA,__la_symbol_ptr</code> 直接存储的就是实际地址值了。(PS: 我 Xcode 版本是 <code>Version 13.1 (13A1030d)</code>，通过下断点得知是 dyld4, 我以为是 dyld4 做了什么优化，把电脑重启后再次运行还是一样的结果。)</p>
<p><strong>Note</strong>: </p>
<ol>
<li>大小端，内存地址存储的值是小端模式，即 <code>0x10fd170f0: 62 e7 7e 20 ff 7f 00 00</code> </li>
<li>lldb image 指令的其他玩法，可以在 help 调试下输入 <code>image help</code> 查看</li>
</ol>
<h2 id="MachOView"><a href="#MachOView" class="headerlink" title="MachOView"></a>MachOView</h2><p>既然 lldb 调试推理不出 <code>__stub_helper</code>，那就看下是否能通过 macho 可执行文件里面存储的原始值能推理出来不？</p>
<p>还是前面的断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup -a 0x10fd12000</span><br><span class="line">      Address: Demo_fishhook[0x0000000100027000] (Demo_fishhook.__TEXT.__stubs + 18)</span><br><span class="line">      Summary: Demo_fishhook&#96;symbol stub for: NSLog</span><br></pre></td></tr></table></figure>
<p>在 <code>__TEXT.__stubs</code> section, 用 <a href="https://sourceforge.net/projects/machoview/">MachOView</a> 来查看该 Demo 的可执行文件。</p>
<p><strong>Note</strong>:</p>
<ol>
<li><code>0x10fd12000</code> 是虚拟内存地址</li>
<li><code>0x0000000100027000</code> 是加上虚拟基地址的文件偏移(offset), 而虚拟基地址一般都是 <code>0x0000000100000000</code>, 即 2^32.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list &#x2F;&#x2F; 得出该可执行文件 image 在虚拟内存中的起始地址：&#96;0x000000010fceb000&#96;</span><br><span class="line">[  0] 0D70A5F7-C54D-312D-B242-ADE1AB9BEF9D 0x000000010fceb000 &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app&#x2F;Demo_fishhook </span><br><span class="line">      &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app.dSYM&#x2F;Contents&#x2F;Resources&#x2F;DWARF&#x2F;Demo_fishhook</span><br><span class="line"></span><br><span class="line">(lldb) image list -o -f &#x2F;&#x2F; 得到可执行文件的 ASLR 值</span><br><span class="line">[  0] 0x000000000fceb000 &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app&#x2F;Demo_fishhook     </span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x 0x000000010fceb000 - 0x000000000fceb000</span><br><span class="line">(long) $0 &#x3D; 0x0000000100000000  &#x2F;&#x2F; 上面两个地址相减，就得到了虚拟基址</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x 0x0000000100027000 - 0x0000000100000000 &#x2F;&#x2F; 得到 &#96;Demo_fishhook.__TEXT.__stubs&#96; 在 macho 文件中的 offset</span><br><span class="line">(long) $1 &#x3D; 0x0000000000027000</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x 0x10fd12006 + 0x50ea - 0x000000000fceb000 &#x2F;&#x2F; 得到前面提到的地址 A, 还是通过前面 lldb 计算得来，发现跟下面 MachOView 所查看到的是一样的</span><br><span class="line">(int) $2 &#x3D; 0x000000010002c0f0</span><br></pre></td></tr></table></figure>
<p>在 <code>RVA</code> tab 找到 <code>0x000000010002c0f0</code> 地址<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923124046.png"><br>注意 <code>Data</code> 那一栏的值 <code>00000001000273D8</code>, 继续查找。</p>
<ul>
<li>RVA: Relative Virtual Address, 相对虚拟地址（没添加 ASLR 的值）</li>
<li>RAW: offset, 在 macho 文件中的偏移</li>
</ul>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923124324.png"><br><strong>push 0x59</strong><br><code>push 0x59</code>: 表示将 0x59 立即数入栈，而我们知道栈一般用做函数调用时的传参。<br>那 0x59 立即数又是什么意思呢？<br>根据 <a href="https://tannerjin.github.io/2019/09/25/AntiHook/">AntiHook</a> 的内容可知</p>
<blockquote>
<p>其实在dyld源码里，dyld_ stub_bind最后会调用fastBindLazySymbol函数，这个函数的第二个参数是lazyBindingInfoOffset, 即0x0120是Binding Info或者Lazy Binding Info区起始开始到符号信息的偏移，而符号信息如下图</p>
</blockquote>
<p>因为 <code>NSLog</code> 符号在 <code>__DATA,__la_symbol_ptr</code>(la: lazy), 所以就是相对于 <code>Lazy Binding Info</code> 偏移 0x59 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x1000370F8 + 0x59</span><br><span class="line">(long) $17 &#x3D; 0x0000000100037151</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923124908.png"><br>嗯，有趣的事情来了，这里竟然有符号名 <code>name(_NSLog)</code>。<br>那 <code>dylib(3)</code> 呢？表示该符号在所加载的第3个 dylib 里面（如下图）。<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923125118.png"><br><strong>Note:</strong> 从这里可以看出，进行链接的时候会把动态库里符号的相关信息存储起来（即：该符号属于哪个动态库）。</p>
<p><strong>jmp 0x10002733c</strong><br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923125508.png"></p>
<ul>
<li><code>lea r11, qword ptr [rip + 0x4cbd]</code><ul>
<li>将 <code>rip + 0x4cbd = 0x100027343 + 0x4cbd = 0x000000010002c000</code> 地址的值存入 r11 寄存器</li>
</ul>
</li>
<li><code>push r11</code><ul>
<li>所以此时栈中有两个参数：前面的 0x59; 这里的 <code>0x000000010002c000</code></li>
</ul>
</li>
<li><code>jmp qword ptr [rip + 0x4d85]</code><ul>
<li>跳转到 <code>rip + 0x4cbd = 0x10002734B + 0x4d85 = 0x000000010002c0d0</code> 执行函数</li>
</ul>
</li>
</ul>
<p>注意：这里分为两块</p>
<ol>
<li>前面这一块的就是 <code>__stub_helper</code> 的具体执行逻辑</li>
<li>后面这一块就是传参、然后调用 <code>__stub_helper</code> // 而这里的参数具体在前面讲解 0x59 的时候有提到</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923130136.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000000000fceb000 + 0x10002C000</span><br><span class="line">(long) $24 &#x3D; 0x000000010fd17000</span><br><span class="line">(lldb) x 0x000000010fd17000</span><br><span class="line">0x10fd17000: 00 00 00 00 00 00 00 00 00 94 4d 8a ff 7f 00 00  ..........M.....</span><br><span class="line">0x10fd17010: 08 28 2a 86 ff 7f 00 00 1a 33 25 20 ff 7f 00 00  .(*......3% ....</span><br></pre></td></tr></table></figure>
<p>诶，在程序启动后，它的值还是为 0, 这是为什么呢？</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923130225.png"><br>奈斯，终于看到 <code>dyld_stub_binder</code> 了，并且它已经有值了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000000000fceb000 + 0x10002C0D0</span><br><span class="line">(long) $25 &#x3D; 0x000000010fd170d0</span><br><span class="line">(lldb) x 0x000000010fd170d0</span><br><span class="line">0x10fd170d0: 80 a6 2c 86 ff 7f 00 00 b9 85 36 20 ff 7f 00 00  ..,.......6 ....</span><br><span class="line">0x10fd170e0: 10 ad 7d 20 ff 7f 00 00 84 c0 3f 20 ff 7f 00 00  ..&#125; ......? ....</span><br></pre></td></tr></table></figure>

<p><strong>Note</strong>：这里的 <code>__DATA,__nl_symbol_ptr</code> 和 <code>__DATA,__got</code> Section 都是属于非懒加载的，在程序启动时 dyld 就会修正这些符号值。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131201.png" alt="__DATA,__nl_symbol_ptr Section"></p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131234.png" alt="__DATA,__got Section"></p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131308.png" alt="__DATA,__la_symbol_ptr Section"><br><strong>Note</strong>: 注意这里的 Indirect Sym Index(Reserved1): 168, 后面讲解 fishhook 的时候会提到。</p>
<p>因为它们存在于有可读可写权限的 <code>DATA Segment</code>。<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131011.png" alt="TEXT Segment"><br>可读可执行。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131111.png" alt="DATA Segment"><br>可读可写。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>NSLog</code> 这块的逻辑大致分为</p>
<ol>
<li>lazy binding 的符号地址最开始指向 <code>__TEXT,__stubs</code> 里所指向的方法，调用该方法的时候，它会调用 <code>__DATA,__la_symbol_ptr</code> 所指向地址里面的方法</li>
<li>未绑定的时候，<code>__DATA,__la_symbol_ptr</code> 指向 <code>___TEXT,__stub_helper</code> ，而后者会执行系统函数(dyld_stub_binder)找到方法实现后，会修改 <code>__DATA,__la_symbol_ptr</code> 的值，从而指向实际的函数地址</li>
<li>已绑定的时候，<code>__DATA,__la_symbol_ptr</code> 则指向实际的函数地址。// 而 fishhook 就是这么干的，修改 <code>__DATA,__la_symbol_ptr</code> 里面相关符号的值</li>
</ol>
<h1 id="fishhook"><a href="#fishhook" class="headerlink" title="fishhook"></a>fishhook</h1><p>有了前面 <code>NSLog</code> lazy binding 的调试经验，现在调试 fishhook 就会轻松很多。这里的 Demo 参考自 <a href="https://zhang759740844.github.io/2019/07/07/fishhook/">fishhook 源码解析</a>。</p>
<h2 id="rebind-symbols"><a href="#rebind-symbols" class="headerlink" title="rebind_symbols"></a>rebind_symbols</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">struct rebindings_entry &#123;</span><br><span class="line">    struct rebinding *rebindings; &#x2F;&#x2F; rebinding 类型的数组</span><br><span class="line">    size_t rebindings_nel; &#x2F;&#x2F; 该数组的长度</span><br><span class="line">    struct rebindings_entry *next; &#x2F;&#x2F; 链表的下一个 entry</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 链表头</span><br><span class="line">static struct rebindings_entry *_rebindings_head;</span><br><span class="line"></span><br><span class="line">int rebind_symbols(struct rebinding rebindings[], size_t rebindings_nel) &#123;</span><br><span class="line">    &#x2F;&#x2F; 维护一个 rebindings_entry 的结构</span><br><span class="line">    &#x2F;&#x2F; 将 rebinding 的多个实例组织成一个链表</span><br><span class="line">    int retval &#x3D; prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">    &#x2F;&#x2F; 判断是否 malloc 失败，失败会返回 -1</span><br><span class="line">    if (retval &lt; 0) &#123;</span><br><span class="line">        return retval;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; _rebindings_head -&gt; next 是第一次调用的标志符，NULL 则代表第一次调用</span><br><span class="line">    if (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">        &#x2F;&#x2F; 第一次调用，将 _rebind_symbols_for_image 注册为回调</span><br><span class="line">        _dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 先获取 dyld 镜像数量</span><br><span class="line">        uint32_t c &#x3D; _dyld_image_count();</span><br><span class="line">        for (uint32_t i &#x3D; 0; i &lt; c; i++) &#123;</span><br><span class="line">            &#x2F;&#x2F; 根据下标依次进行重绑定过程</span><br><span class="line">            _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 返回状态值</span><br><span class="line">    return retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="prepend-rebindings"><a href="#prepend-rebindings" class="headerlink" title="prepend_rebindings"></a>prepend_rebindings</h2><p>该方法使用链表存储 <code>rebindings_entry</code> 结构，使用头插法将一个链表串起来，链表头用 <code>_rebindings_head</code> 保存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static struct rebindings_entry *_rebindings_head;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">rebindings_head: 静态的链表头</span><br><span class="line">rebindings: 方法符号数组</span><br><span class="line">nel: 数组长度</span><br><span class="line">*&#x2F;</span><br><span class="line">static int prepend_rebindings(struct rebindings_entry **rebindings_head,</span><br><span class="line">                              struct rebinding rebindings[],</span><br><span class="line">                              size_t nel) &#123;</span><br><span class="line">  &#x2F;&#x2F; 声明 rebindings_entry 一个指针，并为其分配空间</span><br><span class="line">  struct rebindings_entry *new_entry &#x3D; (struct rebindings_entry *) malloc(sizeof(struct rebindings_entry));</span><br><span class="line">  if (!new_entry) &#123;</span><br><span class="line">    return -1;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 为数组 rebindings 分配内存</span><br><span class="line">  new_entry-&gt;rebindings &#x3D; (struct rebinding *) malloc(sizeof(struct rebinding) * nel);</span><br><span class="line">  if (!new_entry-&gt;rebindings) &#123;</span><br><span class="line">    free(new_entry);</span><br><span class="line">    return -1;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 内存拷贝，将 rebindings 数组中 copy 到 new_entry -&gt; rebingdings 成员中</span><br><span class="line">  memcpy(new_entry-&gt;rebindings, rebindings, sizeof(struct rebinding) * nel);</span><br><span class="line">  new_entry-&gt;rebindings_nel &#x3D; nel;</span><br><span class="line">  &#x2F;&#x2F; 头插法</span><br><span class="line">  new_entry-&gt;next &#x3D; *rebindings_head;</span><br><span class="line">  *rebindings_head &#x3D; new_entry;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过多次操作后，结果如下图所示<br><img src="https://github.com/zhang759740844/MyImgs/blob/master/MyBlog/fishhook_11.png?raw=true" alt="rebindings_entry"></p>
<p><strong>Note</strong>: 这里 <code>*rebindings</code> 是一个数组。</p>
<h2 id="rebind-symbols-for-image"><a href="#rebind-symbols-for-image" class="headerlink" title="_rebind_symbols_for_image"></a>_rebind_symbols_for_image</h2><p><code>_dyld_register_func_for_add_image</code> 方法是 dyld 注册回调函数的方法，当镜像被加载的时候，就会主动触发注册的回调方法。</p>
<blockquote>
<p>一个可执行文件会加载非常多的动态库，每个动态库的成功加载都会触发注册的回调方法。每个动态库镜像都会根据设置重绑定符号</p>
</blockquote>
<p>这里多个 image 可以在程序运行的时候通过 <code>image list</code> 获取。</p>
<p>而这里，就注册了 <code>_rebind_symbols_for_image</code> 方法，但里面没做任何事情，直接调用另外一个方法。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923150819.png"></p>
<ul>
<li>header: 当前可执行文件的虚拟内存地址；也就是 image 的 header 头信息，结构体如下图所示<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/202209231503977.png" alt="Mach Header"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list</span><br><span class="line">[  0] 0D70A5F7-C54D-312D-B242-ADE1AB9BEF9D 0x000000010d574000 &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app&#x2F;Demo_fishhook </span><br><span class="line">      &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app.dSYM&#x2F;Contents&#x2F;Resources&#x2F;DWARF&#x2F;Demo_fishhook</span><br></pre></td></tr></table></figure></li>
<li>slide: ASLR 偏移值<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list -o -f</span><br><span class="line">[  0] 0x000000000d574000 &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app&#x2F;Demo_fishhook</span><br></pre></td></tr></table></figure></li>
<li>magic: 0x00000000feedfacf, 同 MachOView 那一栏的值，这里是大端模式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 4277009103</span><br><span class="line">(long) $2 &#x3D; 0x00000000feedfacf</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>Note:</strong> 该进程有多少个 image, 该方法就会回调多少次。</p>
<h2 id="rebind-symbols-for-image-1"><a href="#rebind-symbols-for-image-1" class="headerlink" title="rebind_symbols_for_image"></a>rebind_symbols_for_image</h2><p>核心方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">static void rebind_symbols_for_image(struct rebindings_entry *rebindings,</span><br><span class="line">                                     const struct mach_header *header,</span><br><span class="line">                                     intptr_t slide) &#123;</span><br><span class="line">  Dl_info info;</span><br><span class="line">    &#x2F;&#x2F; header 无效</span><br><span class="line">  if (dladdr(header, &amp;info) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    &#x2F;&#x2F; 1. 查找 linkedit_segment symtab_cmd dysymtab_cmd</span><br><span class="line">  segment_command_t *cur_seg_cmd;</span><br><span class="line">  segment_command_t *linkedit_segment &#x3D; NULL;</span><br><span class="line">  struct symtab_command* symtab_cmd &#x3D; NULL;</span><br><span class="line">  struct dysymtab_command* dysymtab_cmd &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 过掉 Mach-O Header, 到 Load Commands</span><br><span class="line">  uintptr_t cur &#x3D; (uintptr_t)header + sizeof(mach_header_t);</span><br><span class="line">    &#x2F;*</span><br><span class="line">     遍历每个 Load Command</span><br><span class="line">     header-&gt;ncmds: Load Commands 的数量</span><br><span class="line">     cur_seg_cmd-&gt;cmdsize: 当前 load command 的大小</span><br><span class="line">     *&#x2F;</span><br><span class="line">  for (uint i &#x3D; 0; i &lt; header-&gt;ncmds; i++, cur +&#x3D; cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd &#x3D; (segment_command_t *)cur;</span><br><span class="line">      &#x2F;&#x2F; 判断类型是否是 SEG_LINKEDIT LC_SYMTAB LC_DYSYMTAB</span><br><span class="line">    if (cur_seg_cmd-&gt;cmd &#x3D;&#x3D; LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      if (strcmp(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        linkedit_segment &#x3D; cur_seg_cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (cur_seg_cmd-&gt;cmd &#x3D;&#x3D; LC_SYMTAB) &#123;</span><br><span class="line">      symtab_cmd &#x3D; (struct symtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125; else if (cur_seg_cmd-&gt;cmd &#x3D;&#x3D; LC_DYSYMTAB) &#123;</span><br><span class="line">      dysymtab_cmd &#x3D; (struct dysymtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    &#x2F;&#x2F; 没找到，则 return</span><br><span class="line">  if (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">      !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Find base symbol&#x2F;string table addresses</span><br><span class="line">    &#x2F;*</span><br><span class="line">     2. 获取相关地址值</span><br><span class="line">     slide: ASLR 值</span><br><span class="line">     vmaddr: 虚拟地址值，fileoff: 文件偏移量，两者相减即可得 VM Size.</span><br><span class="line">     linkedit_base 就是在虚拟内存加载的基地址(image list 下 image 的值&#x2F;header)</span><br><span class="line">     *&#x2F;</span><br><span class="line">  uintptr_t linkedit_base &#x3D; (uintptr_t)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line">  nlist_t *symtab &#x3D; (nlist_t *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line">  char *strtab &#x3D; (char *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Get indirect symbol table (array of uint32_t indices into symbol table)</span><br><span class="line">  uint32_t *indirect_symtab &#x3D; (uint32_t *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 3. 查找 section</span><br><span class="line">    &#x2F;&#x2F; 游标重置</span><br><span class="line">  cur &#x3D; (uintptr_t)header + sizeof(mach_header_t);</span><br><span class="line">  for (uint i &#x3D; 0; i &lt; header-&gt;ncmds; i++, cur +&#x3D; cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd &#x3D; (segment_command_t *)cur;</span><br><span class="line">    if (cur_seg_cmd-&gt;cmd &#x3D;&#x3D; LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      if (strcmp(cur_seg_cmd-&gt;segname, SEG_DATA) !&#x3D; 0 &amp;&amp;</span><br><span class="line">          strcmp(cur_seg_cmd-&gt;segname, SEG_DATA_CONST) !&#x3D; 0) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">        &#x2F;&#x2F; __DATA segment load command 后面跟 n 个 sections</span><br><span class="line">      for (uint j &#x3D; 0; j &lt; cur_seg_cmd-&gt;nsects; j++) &#123;</span><br><span class="line">        section_t *sect &#x3D;</span><br><span class="line">          (section_t *)(cur + sizeof(segment_command_t)) + j;</span><br><span class="line">        if ((sect-&gt;flags &amp; SECTION_TYPE) &#x3D;&#x3D; S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">        if ((sect-&gt;flags &amp; SECTION_TYPE) &#x3D;&#x3D; S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查找-linkedit-segment-symtab-cmd-dysymtab-cmd"><a href="#查找-linkedit-segment-symtab-cmd-dysymtab-cmd" class="headerlink" title="查找 linkedit_segment symtab_cmd dysymtab_cmd"></a>查找 linkedit_segment symtab_cmd dysymtab_cmd</h3><p>这没什么说的，就是常规的查找操作。</p>
<h4 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h4><p>见下面 <code>__LINKEDIT</code> 截图左侧的三个箭头。</p>
<h4 id="LINKEDIT"><a href="#LINKEDIT" class="headerlink" title="__LINKEDIT"></a>__LINKEDIT</h4><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923151356.png" alt="__LINKEDIT"><br>这是一个有意思的地方，<code>__DATA Section</code> 后面的都是 <code>__LINKEDIT Segment</code>，如下图。<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923151704.png" alt="__LINKEDIT Segment Start"><br><strong>Note:</strong> 这里切换成 RAW 了。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923151925.png" alt="__LINKEDIT Segment End"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x34000 + 0x836B0 &#x2F;&#x2F; </span><br><span class="line">(int) $5 &#x3D; 0x000b76b0</span><br><span class="line">(lldb) p&#x2F;x 0xB76A0 + 0x10 &#x2F;&#x2F; 16: 0x10</span><br><span class="line">(int) $6 &#x3D; 0x000b76b0</span><br></pre></td></tr></table></figure>
<p>最后一个 Section 的 index 是 0xB76A0, 占 16Bytes, 也就是 0x000b76b0，没毛病。</p>
<h4 id="LC-SYSTAB"><a href="#LC-SYSTAB" class="headerlink" title="LC_SYSTAB"></a>LC_SYSTAB</h4><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923152549.png" alt="LC_SYSTAB"><br>注意两个 Table Offset, 分别对应 Symbol Table 和 String Table 的 file offset.</p>
<h4 id="LC-DYSYSTAB"><a href="#LC-DYSYSTAB" class="headerlink" title="LC_DYSYSTAB"></a>LC_DYSYSTAB</h4><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923152650.png" alt="LC_DYSYSTAB"><br>动态符号表。</p>
<h3 id="获取相关地址值"><a href="#获取相关地址值" class="headerlink" title="获取相关地址值"></a>获取相关地址值</h3><p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923174959.png"></p>
<p>从上可知</p>
<ol>
<li>linkedit_base = header, 就是虚拟内存中加载的基地址</li>
<li>symtab, 看上面的 LC_SYSTAB 截图，<strong>Symbol Table Offset</strong>(symtab_cmd-&gt;symoff): 00039f28<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923153345.png" alt="Symbol Table"></li>
<li>strtab, 看上面的 LC_SYSTAB 截图，<strong>String Table Offset</strong>(symtab_cmd-&gt;stroff): 0005C8B0<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923153636.png" alt="String Table"></li>
<li>indirect_symtab, 看上面的 LC_DYSYSTAB 截图，IndSym Table Offset: 0005C3D8<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923153807.png" alt="Dynamic Symbol Table"></li>
</ol>
<h3 id="查找-section"><a href="#查找-section" class="headerlink" title="查找 section"></a>查找 section</h3><p>在 <code>__DATA</code> Segment, 下找到 type 为 <code>S_LAZY_SYMBOL_POINTERS/S_NON_LAZY_SYMBOL_POINTER</code> 的 section。<br>详见前面的相关截图<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131201.png" alt="__DATA,__nl_symbol_ptr Section"></p>
<h2 id="perform-rebinding-with-section"><a href="#perform-rebinding-with-section" class="headerlink" title="perform_rebinding_with_section"></a>perform_rebinding_with_section</h2><p>重新绑定的逻辑，这里以 <code>__la_symbol_ptr</code> Section 为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">static void perform_rebinding_with_section(struct rebindings_entry *rebindings,</span><br><span class="line">                                           section_t *section,</span><br><span class="line">                                           intptr_t slide,</span><br><span class="line">                                           nlist_t *symtab,</span><br><span class="line">                                           char *strtab,</span><br><span class="line">                                           uint32_t *indirect_symtab) &#123;</span><br><span class="line">    &#x2F;&#x2F; 该 section(__la_symbol_ptr) 在 indirect_symtab 的起始下标, 指向 indirect_symtab</span><br><span class="line">  uint32_t *indirect_symbol_indices &#x3D; indirect_symtab + section-&gt;reserved1;</span><br><span class="line">    &#x2F;&#x2F; 指向具体地址，Section64(__DATA, __la_symbol_ptr)</span><br><span class="line">  void **indirect_symbol_bindings &#x3D; (void **)((uintptr_t)slide + section-&gt;addr);</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">	指针格式 sizeof(void *) &#x3D; 8, </span><br><span class="line">	section-&gt;size &#x3D; 1128, 在 MachOView Section64 Header(__la_symbol_ptr), size 也是 1128</span><br><span class="line">	所以共 1128&#x2F;8 &#x3D; 141 个符号，具体值在 Section64(__DATA, __la_symbol_ptr)</span><br><span class="line">	*&#x2F;</span><br><span class="line">  for (uint i &#x3D; 0; i &lt; section-&gt;size &#x2F; sizeof(void *); i++) &#123;</span><br><span class="line">    uint32_t symtab_index &#x3D; indirect_symbol_indices[i];</span><br><span class="line">      &#x2F;&#x2F; 无效的符号</span><br><span class="line">    if (symtab_index &#x3D;&#x3D; INDIRECT_SYMBOL_ABS || symtab_index &#x3D;&#x3D; INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">        symtab_index &#x3D;&#x3D; (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">      &#x2F;&#x2F; 在字符串表的下标</span><br><span class="line">    uint32_t strtab_offset &#x3D; symtab[symtab_index].n_un.n_strx;</span><br><span class="line">      &#x2F;&#x2F; 获取字符串名</span><br><span class="line">    char *symbol_name &#x3D; strtab + strtab_offset;</span><br><span class="line">    bool symbol_name_longer_than_1 &#x3D; symbol_name[0] &amp;&amp; symbol_name[1];</span><br><span class="line">    struct rebindings_entry *cur &#x3D; rebindings;</span><br><span class="line">    while (cur) &#123;</span><br><span class="line">      for (uint j &#x3D; 0; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">          &#x2F;&#x2F; &amp;symbol_name[1] 去掉函数修饰时前面的 &#96;_&#96;, eg: _NSLog</span><br><span class="line">        if (symbol_name_longer_than_1 &amp;&amp; strcmp(&amp;symbol_name[1], cur-&gt;rebindings[j].name) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">          kern_return_t err;</span><br><span class="line"></span><br><span class="line">          if (cur-&gt;rebindings[j].replaced !&#x3D; NULL &amp;&amp; indirect_symbol_bindings[i] !&#x3D; cur-&gt;rebindings[j].replacement)</span><br><span class="line">              &#x2F;&#x2F; 替换前的原函数地址</span><br><span class="line">            *(cur-&gt;rebindings[j].replaced) &#x3D; indirect_symbol_bindings[i];</span><br><span class="line"></span><br><span class="line">          &#x2F;**</span><br><span class="line">           * 1. Moved the vm protection modifying codes to here to reduce the</span><br><span class="line">           *    changing scope.</span><br><span class="line">           * 2. Adding VM_PROT_WRITE mode unconditionally because vm_region</span><br><span class="line">           *    API on some iOS&#x2F;Mac reports mismatch vm protection attributes.</span><br><span class="line">           * -- Lianfu Hao Jun 16th, 2021</span><br><span class="line">           **&#x2F;</span><br><span class="line">          err &#x3D; vm_protect (mach_task_self (), (uintptr_t)indirect_symbol_bindings, section-&gt;size, 0, VM_PROT_READ | VM_PROT_WRITE | VM_PROT_COPY);</span><br><span class="line">          if (err &#x3D;&#x3D; KERN_SUCCESS) &#123;</span><br><span class="line">            &#x2F;**</span><br><span class="line">             * Once we failed to change the vm protection, we</span><br><span class="line">             * MUST NOT continue the following write actions!</span><br><span class="line">             * iOS 15 has corrected the const segments prot.</span><br><span class="line">             * -- Lionfore Hao Jun 11th, 2021</span><br><span class="line">             **&#x2F;</span><br><span class="line">              &#x2F;&#x2F; 修改函数指向的地方</span><br><span class="line">            indirect_symbol_bindings[i] &#x3D; cur-&gt;rebindings[j].replacement;</span><br><span class="line">          &#125;</span><br><span class="line">          goto symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur &#x3D; cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  symbol_loop:;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SECTION-TYPE"><a href="#SECTION-TYPE" class="headerlink" title="SECTION_TYPE"></a>SECTION_TYPE</h3><p>该 header(0x000000010d574000) 会过掉三个 section </p>
<ul>
<li>0x000000010d5744b8: __nl_symbol_ptr</li>
<li>0x000000010d574508: __got</li>
<li>0x000000010d574558: __la_symbol_ptr</li>
</ul>
<p><strong>Note:</strong> 这里纠正了我之前的一个问题，以为只会处理 <code>__nl_symbol_ptr</code> 和 <code>__la_symbol_ptr</code> 这两个 section 的值，其实不是的，代码里面是判断的类型，而不是根据 Section 名字来的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ((sect-&gt;flags &amp; SECTION_TYPE) &#x3D;&#x3D; S_NON_LAZY_SYMBOL_POINTERS)</span><br></pre></td></tr></table></figure>
<h3 id="indirect-symtab"><a href="#indirect-symtab" class="headerlink" title="indirect_symtab"></a>indirect_symtab</h3><p>只处理 <code>__la_symbol_ptr</code> section.</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923154802.png"><br><code>0xa8=168</code>, 还记得前面的截图<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923131308.png" alt="__DATA,__la_symbol_ptr Section"><br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923153807.png" alt="Dynamic Symbol Table"><br>从 <code>Dynamic Symbol Table</code> 开始，第 168 个符号的 Offset 为 <code>0x000000000005c678</code>。<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923161044.png"><br>从这里开始遍历，共遍历 141 个符号。<br>PS: 这里 MachOView 的 Dynamic Symbol Table 已经把符号都显示出来了（见 Symbol 那一行）。</p>
<h3 id="symtab"><a href="#symtab" class="headerlink" title="symtab"></a>symtab</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po symtab_index</span><br><span class="line">8656</span><br></pre></td></tr></table></figure>
<p>在符号表里面找第 8656 个符号。<br>PS: 这里是以 <code>NSLog</code> 来跟踪的。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923161741.png"></p>
<h3 id="strtab"><a href="#strtab" class="headerlink" title="strtab"></a>strtab</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x0005C8B0 + 0x000031C5</span><br><span class="line">0x5FA75</span><br></pre></td></tr></table></figure>
<p><code>0005C8B0</code> 是前面 strtab 的起始地址。</p>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923162233.png"><br>如上图，即 0x5FA70: m, 开始数到 0x5FA75: _, 遇到 .(0x5FA7B) 就结束。这里的 Data 都是 ASCII 码来着，查看 <a href="https://www.asciitable.com/">asciitable</a>。</p>
<ul>
<li>6D: m</li>
<li>0(00): .</li>
<li>5F: _</li>
<li>4E: N</li>
</ul>
<h3 id="代码具体地址"><a href="#代码具体地址" class="headerlink" title="代码具体地址"></a>代码具体地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 指向具体地址，Section64(__DATA, __la_symbol_ptr)</span><br><span class="line">void **indirect_symbol_bindings &#x3D; (void **)((uintptr_t)slide + section-&gt;addr);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x slide</span><br><span class="line">(intptr_t) $52 &#x3D; 0x000000000d574000</span><br><span class="line">(lldb) p&#x2F;x section-&gt;addr</span><br><span class="line">(uint64_t) $53 &#x3D; 0x000000010002c0d8</span><br><span class="line">(lldb) p indirect_symbol_bindings</span><br><span class="line">(void **) $54 &#x3D; 0x000000010d5a00d8</span><br><span class="line">(lldb) p&#x2F;x 0x000000010d5a00d8 - 0x000000010d574000</span><br><span class="line">(long) $55 &#x3D; 0x000000000002c0d8</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923162922.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p 0x2c540 - 0x2c0d8</span><br><span class="line">(int) $60 &#x3D; 1128</span><br><span class="line">(lldb) p 1128&#x2F;8</span><br><span class="line">(int) $61 &#x3D; 141</span><br></pre></td></tr></table></figure>
<p><code>0x2c540</code> 是 <code>__DATA,__mod_init_func</code> 的地址。<br>这里共 141 个数据，所以通过 Load Command 下面每个 Section Header 的描述信息可知该 Section 下面的符号大小和个数。</p>
<h3 id="替换函数地址"><a href="#替换函数地址" class="headerlink" title="替换函数地址"></a>替换函数地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p &amp;indirect_symbol_bindings[i]</span><br><span class="line">(void **) $62 &#x3D; 0x000000010d5a00f0</span><br><span class="line">(lldb) p&#x2F;x 0x000000010d5a00f0 - 0x000000010d574000</span><br><span class="line">(long) $63 &#x3D; 0x000000000002c0f0</span><br></pre></td></tr></table></figure>
<p>就是上面截图 <code>NSLog</code> 符号在 <code>Section64(__DATA, __la_symbol_ptr)</code> 的值，因为 <code>indirect_symbol_bindings</code> 是二维指针数组，所以，这里需要进行取地址操作(&amp;)，所以这里替换 <code>Section64(__DATA, __la_symbol_ptr)</code>里面的具体地址值。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol>
<li>通过注册系统回调 <code>_dyld_register_func_for_add_image</code> 获取每个 image 的虚拟内存起始地址和 ASLR 偏移</li>
<li>根据 image 的起始地址，加上 Header 的大小(Header 固定大小为 0x20)，得出 <code>SEG_LINKEDIT/LC_SYMTAB/LC_DYSYMTAB</code> 这3个 Load Commands 的起始地址</li>
<li>遍历 Load Commands，拿到 __DATA segment 里面类型为 <code>S_LAZY_SYMBOL_POINTERS/S_NON_LAZY_SYMBOL_POINTERS</code> 的 section (包括  <code>__DATA,__nl_symbol_ptr/__got/__la_symbol_ptr</code> 三个) 的各项信息，包括段的位置，段的大小，段在 Dynamic Symbol Table 的起始索引 reserved1（也就是 MachOView 中的 Indirect Sym Index）</li>
<li>在 <code>Dynamic Symbol Table</code> 遍历相关 Section(eg: <code>Section64(__DATA, __la_symbol_ptr)</code>) 的每个符号，然后找到符号在 <code>LC_SYMTAB</code> 的地址，从而得知该符号的名字</li>
<li>拿到该名字跟需要替换的符号做对比，如果对得上的话，进行替换，修改该 Section 下对应符号的指针指向</li>
</ol>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="lldb-image"><a href="#lldb-image" class="headerlink" title="lldb - image"></a>lldb - image</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image help</span><br><span class="line">Commands for accessing information for one or more target modules.</span><br><span class="line"></span><br><span class="line">Syntax: target modules &lt;sub-command&gt; ...</span><br><span class="line"></span><br><span class="line">The following subcommands are supported:</span><br><span class="line"></span><br><span class="line">      add          -- Add a new module to the current target&#39;s modules.</span><br><span class="line">      dump         -- Commands for dumping information about one or more target</span><br><span class="line">                      modules.</span><br><span class="line">      list         -- List current executable and dependent shared library</span><br><span class="line">                      images.</span><br><span class="line">      load         -- Set the load addresses for one or more sections in a</span><br><span class="line">                      target module.</span><br><span class="line">      lookup       -- Look up information within executable and dependent</span><br><span class="line">                      shared library images.</span><br><span class="line">      search-paths -- Commands for managing module search paths for a target.</span><br><span class="line">      show-unwind  -- Show synthesized unwind instructions for a function.</span><br><span class="line"></span><br><span class="line">(lldb) help image lookup</span><br><span class="line">Look up information within executable and dependent shared library images.</span><br><span class="line"></span><br><span class="line">Syntax: target modules lookup &lt;cmd-options&gt; [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line"></span><br><span class="line">Command Options Usage:</span><br><span class="line">  target modules lookup [-Av] -a &lt;address-expression&gt; [-o &lt;offset&gt;] [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line">  target modules lookup [-Arv] -s &lt;symbol&gt; [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line">  target modules lookup [-Aiv] -f &lt;filename&gt; [-l &lt;linenum&gt;] [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line">  target modules lookup [-Airv] -F &lt;function-name&gt; [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line">  target modules lookup [-Airv] -n &lt;function-or-symbol&gt; [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line">  target modules lookup [-Av] -t &lt;name&gt; [&lt;filename&gt; [&lt;filename&gt; [...]]]</span><br><span class="line"></span><br><span class="line">       -A ( --all )</span><br><span class="line">            Print all matches, not just the best match, if a best match is</span><br><span class="line">            available.</span><br><span class="line"></span><br><span class="line">       -F &lt;function-name&gt; ( --function &lt;function-name&gt; )</span><br><span class="line">            Lookup a function by name in the debug symbols in one or more</span><br><span class="line">            target modules.</span><br><span class="line"></span><br><span class="line">       -a &lt;address-expression&gt; ( --address &lt;address-expression&gt; )</span><br><span class="line">            Lookup an address in one or more target modules.</span><br><span class="line"></span><br><span class="line">       -f &lt;filename&gt; ( --file &lt;filename&gt; )</span><br><span class="line">            Lookup a file by fullpath or basename in one or more target</span><br><span class="line">            modules.</span><br><span class="line"></span><br><span class="line">       -i ( --no-inlines )</span><br><span class="line">            Ignore inline entries (must be used in conjunction with --file or</span><br><span class="line">            --function).</span><br><span class="line"></span><br><span class="line">       -l &lt;linenum&gt; ( --line &lt;linenum&gt; )</span><br><span class="line">            Lookup a line number in a file (must be used in conjunction with</span><br><span class="line">            --file).</span><br><span class="line"></span><br><span class="line">       -n &lt;function-or-symbol&gt; ( --name &lt;function-or-symbol&gt; )</span><br><span class="line">            Lookup a function or symbol by name in one or more target modules.</span><br><span class="line"></span><br><span class="line">       -o &lt;offset&gt; ( --offset &lt;offset&gt; )</span><br><span class="line">            When looking up an address subtract &lt;offset&gt; from any addresses</span><br><span class="line">            before doing the lookup.</span><br><span class="line"></span><br><span class="line">       -r ( --regex )</span><br><span class="line">            The &lt;name&gt; argument for name lookups are regular expressions.</span><br><span class="line"></span><br><span class="line">       -s &lt;symbol&gt; ( --symbol &lt;symbol&gt; )</span><br><span class="line">            Lookup a symbol by name in the symbol tables in one or more target</span><br><span class="line">            modules.</span><br><span class="line"></span><br><span class="line">       -t &lt;name&gt; ( --type &lt;name&gt; )</span><br><span class="line">            Lookup a type by name in the debug symbols in one or more target</span><br><span class="line">            modules.</span><br><span class="line"></span><br><span class="line">       -v ( --verbose )</span><br><span class="line">            Enable verbose lookup information.</span><br><span class="line">     </span><br><span class="line">     This command takes options and free-form arguments.  If your arguments</span><br><span class="line">     resemble option specifiers (i.e., they start with a - or --), you must use</span><br><span class="line">     &#39; -- &#39; between the end of the command options and the beginning of the</span><br><span class="line">     arguments.</span><br><span class="line"></span><br><span class="line">&#39;image&#39; is an abbreviation for &#39;target modules&#39;</span><br></pre></td></tr></table></figure>
<p>比如</p>
<ol>
<li>image list: 输出当前进程所依赖的共享库</li>
<li>image list -o -f: 上个命令简洁版，输出相关库的 ASLR 地址(o: offset)</li>
<li>image lookup -n xxx: 输出 xxx 符号的相关信息</li>
<li>image lookup -t xxx: 输出 xxx 符号的类型</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup -n NSLog</span><br><span class="line">1 match found in &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;Library&#x2F;Developer&#x2F;CoreSimulator&#x2F;Profiles&#x2F;Runtimes&#x2F;iOS.simruntime&#x2F;Contents&#x2F;Resources&#x2F;RuntimeRoot&#x2F;System&#x2F;Library&#x2F;Frameworks&#x2F;Foundation.framework&#x2F;Foundation:</span><br><span class="line">        Address: Foundation[0x00000000000f7762] (Foundation.__TEXT.__text + 1006242)</span><br><span class="line">        Summary: Foundation&#96;NSLog</span><br><span class="line"></span><br><span class="line">(lldb) image lookup -t FBBlockStrongRelationDetector</span><br><span class="line">0 match found in &#x2F;Users&#x2F;joakim&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Demo_fishhook-ebwkhxbcogafxbclcdeifrppsgdu&#x2F;Build&#x2F;Products&#x2F;Debug-iphonesimulator&#x2F;Demo_fishhook.app&#x2F;Demo_fishhook:</span><br><span class="line">id &#x3D; &#123;0x00071c41&#125;, name &#x3D; &quot;FBBlockStrongRelationDetector&quot;, byte-size &#x3D; 176, decl &#x3D; FBBlockStrongRelationDetector.h:23, compiler_type &#x3D; &quot;@interface FBBlockStrongRelationDetector : NSObject&#123;</span><br><span class="line">    void * forwarding;</span><br><span class="line">    int flags;</span><br><span class="line">    int size;</span><br><span class="line">    void (*)(_block_byref_block *, _block_byref_block *) byref_keep;</span><br><span class="line">    void (*)(_block_byref_block *) byref_dispose;</span><br><span class="line">    void *[16] captured;</span><br><span class="line">    BOOL _strong;</span><br><span class="line">&#125;</span><br><span class="line">@property(nonatomic, assign, readwrite, getter &#x3D; isStrong, setter &#x3D; setStrong:) BOOL strong;</span><br><span class="line">@end&quot;</span><br></pre></td></tr></table></figure>
<h2 id="antifishhook"><a href="#antifishhook" class="headerlink" title="antifishhook"></a>antifishhook</h2><p>从前面可知 <a href="https://github.com/facebook/fishhook">fishhook</a> 的原理就是修改相关 Section <code>__DATA,__nl_symbol_ptr/__got/__la_symbol_ptr</code> 下对应符号的指向。<br>Q: 那怎么防止 fishhook 呢？<br>A: 那在改回去呗，找到最初始的符号指向，即<br><img src="https://raw.githubusercontent.com/JoakimLiu/pic/master/fishhook/20220923124046.png"><br>然后通过 fishhook 再替换一波，使得调用 <code>NSLog</code> 的时候走 <code>__stub_helper</code> 的逻辑。<br>具体实现可参考 <a href="https://tannerjin.github.io/2019/09/25/AntiHook/">AntiHook</a>，代码是用 Swift 实现的，值得一看。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="https://book.douban.com/subject/3652388/">程序员的自我修养–链接、装载与库</a></li>
<li><a href="https://github.com/facebook/fishhook">fishhook</a></li>
<li><a href="https://sourceforge.net/projects/machoview/">MachOView</a></li>
<li><a href="https://zhang759740844.github.io/2019/07/07/fishhook/">fishhook 源码解析</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/lldb-command-examples.html#//apple_ref/doc/uid/TP40012917-CH3-SW5">LLDB Quick Start Guide</a></li>
<li><a href="https://tannerjin.github.io/2019/09/25/AntiHook/">AntiHook</a></li>
<li><a href="https://www.asciitable.com/">asciitable</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/09/flutter-main-runApp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/09/flutter-main-runApp/" class="post-title-link" itemprop="url">iOS Flutter Main runApp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-09 18:15:05" itemprop="dateCreated datePublished" datetime="2021-04-09T18:15:05+08:00">2021-04-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">flutter</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>使用下面 demo 来探究 main 函数干了啥。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">// 见 [2.1]</span></span><br><span class="line">  runApp(</span><br><span class="line">    materialApp(),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _MyAppState createState() =&gt; _MyAppState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyAppState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyApp</span>&gt; </span>&#123;</span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> Container();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        // 因为 MaterialApp 里面的逻辑比较多，所以直接上 Container.</span></span><br><span class="line"><span class="comment">        return MaterialApp(home: Container(),);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-启动流程"><a href="#2-启动流程" class="headerlink" title="2. 启动流程"></a>2. 启动流程</h1><p>调试堆栈如下</p>
<p><img src="https://sat02pap001files.storage.live.com/y4m87hRH1uo3ATjkTReKsStkU1r_iq_9l6gH1KZllL1didR5PF6jQ2eCN87_h45A2rWRMwC4zeigiNRm-_ey3jiSNCtHkHiMb-7jlhM_q6UXec8l1uVyvSEbHKzvLLtUaxFVM8Q_5Ti9paHc40DDrHDfrdRh0w23Cpj0uaMaNhoCgiEWZyvpJ5cVP8UMlw1SzKX?width=2494&height=818&cropmode=none" alt="-w1247"></p>
<h2 id="2-1-runApp"><a href="#2-1-runApp" class="headerlink" title="2.1 runApp"></a>2.1 runApp</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/widgets/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> runApp(Widget app) &#123;</span><br><span class="line">  WidgetsFlutterBinding.ensureInitialized() <span class="comment">// 见 [2.2]</span></span><br><span class="line">    ..scheduleAttachRootWidget(app) <span class="comment">// 见 [2.4]</span></span><br><span class="line">    ..scheduleWarmUpFrame(); <span class="comment">// 见 [2.10]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-ensureInitialized"><a href="#2-2-ensureInitialized" class="headerlink" title="2.2 ensureInitialized"></a>2.2 ensureInitialized</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/widgets/binding.dart</span></span><br><span class="line"><span class="comment">/// <span class="markdown">A concrete binding for applications based on the Widgets framework.</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="markdown">This is the glue that binds the framework to the Flutter engine.</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetsFlutterBinding</span> <span class="keyword">extends</span> <span class="title">BindingBase</span> <span class="title">with</span> <span class="title">GestureBinding</span>, <span class="title">SchedulerBinding</span>, <span class="title">ServicesBinding</span>, <span class="title">PaintingBinding</span>, <span class="title">SemanticsBinding</span>, <span class="title">RendererBinding</span>, <span class="title">WidgetsBinding</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> WidgetsBinding ensureInitialized() &#123;</span><br><span class="line">    <span class="keyword">if</span> (WidgetsBinding.instance == <span class="keyword">null</span>)</span><br><span class="line">      WidgetsFlutterBinding(); <span class="comment">// 见 [2.2.1]</span></span><br><span class="line">    <span class="keyword">return</span> WidgetsBinding.instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-BindingBase-初始化"><a href="#2-2-1-BindingBase-初始化" class="headerlink" title="2.2.1 BindingBase 初始化"></a>2.2.1 BindingBase 初始化</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BindingBase() &#123;</span><br><span class="line">    <span class="comment">// 见 [2.3]</span></span><br><span class="line">    initInstances();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    initServiceExtensions();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-initInstances"><a href="#2-3-initInstances" class="headerlink" title="2.3 initInstances"></a>2.3 initInstances</h2><p><code>initInstances</code> 方法的调用顺序是从右到左的，即 </p>
<ol>
<li>WidgetsBinding: The glue between the widgets layer and the Flutter engine.</li>
<li>RendererBinding: The glue between the render tree and the Flutter engine.</li>
<li>SemanticsBinding: The glue between the semantics layer and the Flutter engine.</li>
<li>PaintingBinding: Binding for the painting library.</li>
<li>ServicesBinding: Listens for platform messages and directs them to the [defaultBinaryMessenger].</li>
<li>SchedulerBinding: Scheduler for running the following: xxx.</li>
<li>GestureBinding: A binding for the gesture subsystem.</li>
</ol>
<p>按照上面的顺序执行完 <code>initInstances</code> 中的 <code>super.initInstances()</code>, 再按照上面的逆序执行各个 <code>Binding</code> 类 <code>initInstances</code> 中剩余逻辑，然后执行 <code>initServiceExtensions</code>。</p>
<h3 id="2-3-1-GestureBinding"><a href="#2-3-1-GestureBinding" class="headerlink" title="2.3.1 GestureBinding"></a>2.3.1 GestureBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/gestures/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 设置 window 的 `onPointerDataPacket` 回调方法，在该回调方法中处理手势等交互逻辑。</span></span><br><span class="line">    <span class="built_in">window</span>.onPointerDataPacket = _handlePointerDataPacket;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-SchedulerBinding"><a href="#2-3-2-SchedulerBinding" class="headerlink" title="2.3.2 SchedulerBinding"></a>2.3.2 SchedulerBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/scheduler/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 非 `kReleaseMode` 模式下，添加 `addTimingsCallback` 回调，用来记录 frame 等相关信息。</span></span><br><span class="line">    <span class="keyword">if</span> (!kReleaseMode) &#123;</span><br><span class="line">      <span class="built_in">int</span> frameNumber = <span class="number">0</span>;</span><br><span class="line">      addTimingsCallback((<span class="built_in">List</span>&lt;FrameTiming&gt; timings) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FrameTiming frameTiming <span class="keyword">in</span> timings) &#123;</span><br><span class="line">          frameNumber += <span class="number">1</span>;</span><br><span class="line">          _profileFramePostEvent(frameNumber, frameTiming);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-ServicesBinding"><a href="#2-3-3-ServicesBinding" class="headerlink" title="2.3.3 ServicesBinding"></a>2.3.3 ServicesBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/services/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    _defaultBinaryMessenger = createBinaryMessenger();</span><br><span class="line">    _restorationManager = createRestorationManager();</span><br><span class="line">    <span class="built_in">window</span>.onPlatformMessage = defaultBinaryMessenger.handlePlatformMessage;</span><br><span class="line">    initLicenses();</span><br><span class="line">    SystemChannels.system.setMessageHandler((<span class="built_in">dynamic</span> message) =&gt; handleSystemMessage(message <span class="keyword">as</span> <span class="built_in">Object</span>));</span><br><span class="line">    SystemChannels.lifecycle.setMessageHandler(_handleLifecycleMessage);</span><br><span class="line">    readInitialLifecycleStateFromNativeWindow();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>创建 <code>_defaultBinaryMessenger</code>，用来处理 platform channel 消息，<a href="http://joakimliu.github.io/2021/04/07/flutter-source-code-ios-platform-channels/">iOS Flutter Platform Channel</a> 有讲到。</p>
<h3 id="2-3-4-PaintingBinding"><a href="#2-3-4-PaintingBinding" class="headerlink" title="2.3.4 PaintingBinding"></a>2.3.4 PaintingBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/painting/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 创建 image chache.</span></span><br><span class="line">    _imageCache = createImageCache();</span><br><span class="line">    shaderWarmUp?.execute();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-5-SemanticsBinding"><a href="#2-3-5-SemanticsBinding" class="headerlink" title="2.3.5 SemanticsBinding"></a>2.3.5 SemanticsBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/semantics/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 给 _accessibilityFeatures 赋值</span></span><br><span class="line">    _accessibilityFeatures = <span class="built_in">window</span>.accessibilityFeatures;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-6-RendererBinding"><a href="#2-3-6-RendererBinding" class="headerlink" title="2.3.6 RendererBinding"></a>2.3.6 RendererBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/rendering/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 见 [2.3.6.1]</span></span><br><span class="line">    _pipelineOwner = PipelineOwner(</span><br><span class="line">      onNeedVisualUpdate: ensureVisualUpdate,</span><br><span class="line">      onSemanticsOwnerCreated: _handleSemanticsOwnerCreated,</span><br><span class="line">      onSemanticsOwnerDisposed: _handleSemanticsOwnerDisposed,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 设置 window 的相关回调</span></span><br><span class="line">    <span class="built_in">window</span></span><br><span class="line">      ..onMetricsChanged = handleMetricsChanged</span><br><span class="line">      ..onTextScaleFactorChanged = handleTextScaleFactorChanged</span><br><span class="line">      ..onPlatformBrightnessChanged = handlePlatformBrightnessChanged</span><br><span class="line">      ..onSemanticsEnabledChanged = _handleSemanticsEnabledChanged</span><br><span class="line">      ..onSemanticsAction = _handleSemanticsAction;</span><br><span class="line">    <span class="comment">// 见 [2.3.6.2] </span></span><br><span class="line">    initRenderView();</span><br><span class="line">    _handleSemanticsEnabledChanged();</span><br><span class="line">    <span class="keyword">assert</span>(renderView != <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 添加 addPersistentFrameCallback 回调</span></span><br><span class="line">    addPersistentFrameCallback(_handlePersistentFrameCallback);</span><br><span class="line">    initMouseTracker();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-6-1-PipelineOwner-初始化"><a href="#2-3-6-1-PipelineOwner-初始化" class="headerlink" title="2.3.6.1 PipelineOwner 初始化"></a>2.3.6.1 PipelineOwner 初始化</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The pipeline owner manages the rendering pipeline.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PipelineOwner</span> </span>&#123;</span><br><span class="line">    PipelineOwner(&#123;</span><br><span class="line">        <span class="keyword">this</span>.onNeedVisualUpdate,</span><br><span class="line">        <span class="keyword">this</span>.onSemanticsOwnerCreated,</span><br><span class="line">        <span class="keyword">this</span>.onSemanticsOwnerDisposed,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用来管理 rendering pipeline 的类，在 rendering pipeline 过程中，会按序执行以下方法(这几个阶段的操作对象都是 <code>render objects</code>)</p>
<ol>
<li>flushLayout</li>
<li>flushCompositingBits</li>
<li>flushPaint</li>
<li>flushSemantics</li>
</ol>
<h4 id="2-3-6-2-initRenderView"><a href="#2-3-6-2-initRenderView" class="headerlink" title="2.3.6.2 initRenderView"></a>2.3.6.2 initRenderView</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> initRenderView() &#123;</span><br><span class="line">    <span class="keyword">assert</span>(!_debugIsRenderViewInitialized);</span><br><span class="line">    <span class="keyword">assert</span>(() &#123;</span><br><span class="line">      _debugIsRenderViewInitialized = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;());</span><br><span class="line">    <span class="comment">// 创建 RenderView 对象，并赋值给 renderView, 见 [2.3.6.3]</span></span><br><span class="line">    renderView = RenderView(configuration: createViewConfiguration(), <span class="built_in">window</span>: <span class="built_in">window</span>);</span><br><span class="line">    <span class="comment">// 准备首帧</span></span><br><span class="line">    renderView.prepareInitialFrame();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-6-3-set-renderView"><a href="#2-3-6-3-set-renderView" class="headerlink" title="2.3.6.3 set renderView"></a>2.3.6.3 set renderView</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The root of the render tree.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderView</span> <span class="keyword">extends</span> <span class="title">RenderObject</span> <span class="title">with</span> <span class="title">RenderObjectWithChildMixin</span>&lt;<span class="title">RenderBox</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">set</span> renderView(RenderView value) &#123;</span><br><span class="line">        <span class="keyword">assert</span>(value != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 见 [2.3.6.4]</span></span><br><span class="line">        _pipelineOwner.rootNode = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-6-4-set-rootNode"><a href="#2-3-6-4-set-rootNode" class="headerlink" title="2.3.6.4 set rootNode"></a>2.3.6.4 set rootNode</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PipelineOwner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">set</span> rootNode(AbstractNode? value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_rootNode == value)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        _rootNode?.detach();</span><br><span class="line">        _rootNode = value;</span><br><span class="line">        _rootNode?.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractNode</span> </span>&#123;</span><br><span class="line">    <span class="meta">@mustCallSuper</span></span><br><span class="line">    <span class="keyword">void</span> detach() &#123;</span><br><span class="line">        <span class="keyword">assert</span>(_owner != <span class="keyword">null</span>);</span><br><span class="line">        _owner = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">assert</span>(parent == <span class="keyword">null</span> || attached == parent!.attached);</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@mustCallSuper</span></span><br><span class="line">    <span class="keyword">void</span> attach(<span class="keyword">covariant</span> <span class="built_in">Object</span> owner) &#123;</span><br><span class="line">        <span class="keyword">assert</span>(owner != <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">assert</span>(_owner == <span class="keyword">null</span>);</span><br><span class="line">        _owner = owner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_owner 和 _rootNode 的赋值。</p>
<ul>
<li>将 RenderView 对象赋值给 _pipelineOwner 的 rootNode 成员变量</li>
<li>将 _pipelineOwner 赋值给 RenderView 对象的 _owner 成员变量</li>
</ul>
<h3 id="2-3-7-WidgetsBinding"><a href="#2-3-7-WidgetsBinding" class="headerlink" title="2.3.7 WidgetsBinding"></a>2.3.7 WidgetsBinding</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/widgets/binding.dart</span></span><br><span class="line"><span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// Initialization of [_buildOwner] has to be done after</span></span><br><span class="line">    <span class="comment">// [super.initInstances] is called, as it requires [ServicesBinding] to</span></span><br><span class="line">    <span class="comment">// properly setup the [defaultBinaryMessenger] instance.</span></span><br><span class="line">    _buildOwner = BuildOwner(); <span class="comment">// 见 [2.3.7.1]</span></span><br><span class="line">    buildOwner.onBuildScheduled = _handleBuildScheduled;</span><br><span class="line">    <span class="built_in">window</span>.onLocaleChanged = handleLocaleChanged;</span><br><span class="line">    <span class="built_in">window</span>.onAccessibilityFeaturesChanged = handleAccessibilityFeaturesChanged;</span><br><span class="line">    SystemChannels.navigation.setMethodCallHandler(_handleNavigationInvocation);</span><br><span class="line">    FlutterErrorDetails.propertiesTransformers.add(transformDebugCreator);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-7-1-BuildOwner-初始化"><a href="#2-3-7-1-BuildOwner-初始化" class="headerlink" title="2.3.7.1 BuildOwner 初始化"></a>2.3.7.1 BuildOwner 初始化</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scr/widgets/framework.dart</span></span><br><span class="line"><span class="comment">/// <span class="markdown">Manager class for the widgets framework.</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuildOwner</span> </span>&#123;</span><br><span class="line">    BuildOwner(&#123; <span class="keyword">this</span>.onBuildScheduled &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-scheduleAttachRootWidget"><a href="#2-4-scheduleAttachRootWidget" class="headerlink" title="2.4 scheduleAttachRootWidget"></a>2.4 scheduleAttachRootWidget</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> scheduleAttachRootWidget(Widget rootWidget) &#123;</span><br><span class="line">    <span class="comment">// 异步执行</span></span><br><span class="line">    Timer.run(() &#123;</span><br><span class="line">      <span class="comment">// 见 [2.4.1]</span></span><br><span class="line">      attachRootWidget(rootWidget);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-1-attachRootWidget"><a href="#2-4-1-attachRootWidget" class="headerlink" title="2.4.1 attachRootWidget"></a>2.4.1 attachRootWidget</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attachRootWidget(Widget rootWidget) &#123;</span><br><span class="line">    _readyToProduceFrames = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 见 [2.4.2]</span></span><br><span class="line">    _renderViewElement = RenderObjectToWidgetAdapter&lt;RenderBox&gt;(</span><br><span class="line">      container: renderView, </span><br><span class="line">      debugShortDescription: <span class="string">&#x27;[root]&#x27;</span>, <span class="comment">// debug 描述信息</span></span><br><span class="line">      child: rootWidget,  </span><br><span class="line">    ).attachToRenderTree(buildOwner, renderViewElement <span class="keyword">as</span> RenderObjectToWidgetElement&lt;RenderBox&gt;); <span class="comment">// 见 [2.5]</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>该方法的主要参数</p>
<ul>
<li>renderView: 见 [2.3.6.2]</li>
<li>rootWidget: 见 [1] 中的 demo, materialApp widget, 就是我们的 root widget</li>
<li>buildOwner: 见 [2.3.7.1]</li>
<li>_renderViewElement: 执行 attachToRenderTree 方法后，返回的 Element 类型的对象，可通过 <code>WidgetsBinding.renderViewElement</code> 获取，是 Element tree 的根节点(通过注释 <code>The [Element] that is at the root of the hierarchy (and which wraps the [RenderView] object at the root of the rendering hierarchy).</code>)。</li>
</ul>
<h3 id="2-4-2-RenderObjectToWidgetAdapter-初始化"><a href="#2-4-2-RenderObjectToWidgetAdapter-初始化" class="headerlink" title="2.4.2 RenderObjectToWidgetAdapter 初始化"></a>2.4.2 RenderObjectToWidgetAdapter 初始化</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A bridge from a [RenderObject] to an [Element] tree.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderObjectToWidgetAdapter</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">RenderObject</span>&gt; <span class="keyword">extends</span> <span class="title">RenderObjectWidget</span> </span>&#123;</span><br><span class="line">    RenderObjectToWidgetAdapter(&#123;</span><br><span class="line">    <span class="keyword">this</span>.child, <span class="comment">// widget tree 中的对象</span></span><br><span class="line">    <span class="keyword">this</span>.container, <span class="comment">// The [RenderObject] that is the parent of the [Element] created by this widget.</span></span><br><span class="line">    <span class="keyword">this</span>.debugShortDescription,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: GlobalObjectKey(container));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RenderObjectToWidgetAdapter 是一个从 <code>[RenderObject]</code>(root of render tree) 到 <code>[Element]</code>(root of element tree) 的桥接类，该类的主要方法有</p>
<ul>
<li>createElement: 返回 RenderObjectToWidgetElement 对象, 见 [2.5.1]</li>
<li>createRenderObject: 返回 [2.3.6.2] 的 renderView, 见 [2.7]</li>
<li>attachToRenderTree: 创建 element, 见 [2.5]</li>
</ul>
<h2 id="2-5-attachToRenderTree"><a href="#2-5-attachToRenderTree" class="headerlink" title="2.5 attachToRenderTree"></a>2.5 attachToRenderTree</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">RenderObjectToWidgetElement&lt;T&gt; attachToRenderTree(BuildOwner owner, [ RenderObjectToWidgetElement&lt;T&gt; element ]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</span><br><span class="line">      owner.lockState(() &#123;</span><br><span class="line">        <span class="comment">// 见 [2.5.1]</span></span><br><span class="line">        element = createElement();</span><br><span class="line">        <span class="keyword">assert</span>(element != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 见 [2.5.2]</span></span><br><span class="line">        element.assignOwner(owner);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 见 [2.5.3]</span></span><br><span class="line">      owner.buildScope(element, () &#123;</span><br><span class="line">        <span class="comment">// 见 [2.5.4]</span></span><br><span class="line">        element.mount(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">      SchedulerBinding.instance.ensureVisualUpdate();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      element._newWidget = <span class="keyword">this</span>;</span><br><span class="line">      element.markNeedsBuild();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>首次调用 attachToRenderTree 方法时，入参 element 为空，会创建 element 对象(RenderObjectToWidgetElement 类型)，然后赋值给 [2.4.1] 的 <code>_renderViewElement</code> 成员变量。 </p>
<h3 id="2-5-1-createElement"><a href="#2-5-1-createElement" class="headerlink" title="2.5.1 createElement"></a>2.5.1 createElement</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RenderObjectToWidgetAdapter(&#123;</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">    <span class="keyword">this</span>.container,</span><br><span class="line">    <span class="keyword">this</span>.debugShortDescription,</span><br><span class="line">&#125;) : <span class="keyword">super</span>(key: GlobalObjectKey(container));</span><br><span class="line">  </span><br><span class="line">RenderObjectToWidgetElement&lt;T&gt; createElement() =&gt; RenderObjectToWidgetElement&lt;T&gt;(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>返回 RenderObjectToWidgetElement 类型的对象。</p>
<h3 id="2-5-2-assignOwner"><a href="#2-5-2-assignOwner" class="headerlink" title="2.5.2 assignOwner"></a>2.5.2 assignOwner</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The element at the root of the tree.</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RootRenderObjectElement</span> <span class="keyword">extends</span> <span class="title">RenderObjectElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> assignOwner(BuildOwner owner) &#123;</span><br><span class="line">        _owner = owner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟 [2.3.6.4] 类似，都是将 <code>_pipelineOwner</code> 赋值给 <code>_owner</code> 成员变量，<code>_pipelineOwner</code> 不亏是一个管理类。</p>
<h3 id="2-5-3-buildScope"><a href="#2-5-3-buildScope" class="headerlink" title="2.5.3 buildScope"></a>2.5.3 buildScope</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> buildScope(<span class="built_in">Element</span> context, [ VoidCallback callback ]) &#123;</span><br><span class="line">  <span class="keyword">if</span> (callback == <span class="keyword">null</span> &amp;&amp; _dirtyElements.isEmpty)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// ...  </span></span><br><span class="line">  Timeline.startSync(<span class="string">&#x27;Build&#x27;</span>, arguments: timelineArgumentsIndicatingLandmarkEvent);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    _scheduledFlushDirtyElements = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        callback(); <span class="comment">// 见 [2.5.4]</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对脏 elements 进行排序</span></span><br><span class="line">    _dirtyElements.sort(<span class="built_in">Element</span>._sort);</span><br><span class="line">    _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</span><br><span class="line">    <span class="built_in">int</span> dirtyCount = _dirtyElements.length;</span><br><span class="line">    <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; dirtyCount) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行脏 element 的 rebuild 方法</span></span><br><span class="line">        _dirtyElements[index].rebuild();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e, stack) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      index += <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (dirtyCount &lt; _dirtyElements.length || _dirtyElementsNeedsResorting) &#123;</span><br><span class="line">        _dirtyElements.sort(<span class="built_in">Element</span>._sort);</span><br><span class="line">        _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</span><br><span class="line">        dirtyCount = _dirtyElements.length;</span><br><span class="line">        <span class="keyword">while</span> (index &gt; <span class="number">0</span> &amp;&amp; _dirtyElements[index - <span class="number">1</span>].dirty) &#123;</span><br><span class="line">          index -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-4-RenderObjectToWidgetElement-mount"><a href="#2-5-4-RenderObjectToWidgetElement-mount" class="headerlink" title="2.5.4 RenderObjectToWidgetElement.mount"></a>2.5.4 RenderObjectToWidgetElement.mount</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(parent == <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 见 [2.5.4.1]</span></span><br><span class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">    <span class="comment">// 见 [2.9]</span></span><br><span class="line">    _rebuild();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>因为 RenderObjectToWidgetElement 对象是 element tree 的根节点，所以这里 parent 为 null.</p>
<h4 id="2-5-4-1-RootRenderObjectElement-mount"><a href="#2-5-4-1-RootRenderObjectElement-mount" class="headerlink" title="2.5.4.1 RootRenderObjectElement.mount"></a>2.5.4.1 RootRenderObjectElement.mount</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">    <span class="comment">// Root elements should never have parents.</span></span><br><span class="line">    <span class="keyword">assert</span>(parent == <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">assert</span>(newSlot == <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 见 [2.5.4.2]</span></span><br><span class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-4-2-RenderObjectElement-mount"><a href="#2-5-4-2-RenderObjectElement-mount" class="headerlink" title="2.5.4.2 RenderObjectElement.mount"></a>2.5.4.2 RenderObjectElement.mount</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">  <span class="comment">// 见 [2.5.4.3]</span></span><br><span class="line">  <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 见 [2.7]</span></span><br><span class="line">  _renderObject = widget.createRenderObject(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 见 [2.8]</span></span><br><span class="line">  attachRenderObject(newSlot);</span><br><span class="line">  _dirty = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-4-3-Element-mount"><a href="#2-5-4-3-Element-mount" class="headerlink" title="2.5.4.3 Element.mount"></a>2.5.4.3 Element.mount</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Element</span>(Widget widget)</span><br><span class="line">    : <span class="keyword">assert</span>(widget != <span class="keyword">null</span>),</span><br><span class="line">      _widget = widget;</span><br><span class="line">      </span><br><span class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 父 element</span></span><br><span class="line">  _parent = parent;</span><br><span class="line">  <span class="comment">// 当前 element 的 slot</span></span><br><span class="line">  _slot = newSlot;</span><br><span class="line">  <span class="comment">// root element 的 _depth 为 1，子 element 依次 +1</span></span><br><span class="line">  _depth = _parent != <span class="keyword">null</span> ? _parent.depth + <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 处于激活状态</span></span><br><span class="line">  _active = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// 只用 parent 的 _owner, 也就是说所有 element tree 的上节点公用一个 _owner</span></span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) <span class="comment">// Only assign ownership if the parent is non-null</span></span><br><span class="line">    _owner = parent.owner;</span><br><span class="line">  <span class="comment">// widget 是构造方法中赋值的，也就是 [2.5.1] 中的 RenderObjectToWidgetAdapter, 所以 key 就是 [2.5.1] 中的 GlobalObjectKey(container), 见 [2.6]</span></span><br><span class="line">  <span class="keyword">final</span> Key key = widget.key;</span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">is</span> GlobalKey) &#123;</span><br><span class="line">    <span class="comment">// 见 [2.6]</span></span><br><span class="line">    key._register(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  _updateInheritance();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-GlobalKey-register"><a href="#2-6-GlobalKey-register" class="headerlink" title="2.6 GlobalKey._register"></a>2.6 GlobalKey._register</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/widgets/framework.dart</span></span><br><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalKey</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StatefulWidget</span>&gt;&gt; <span class="keyword">extends</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> GlobalKey.constructor() : <span class="keyword">super</span>.empty();</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">Map</span>&lt;GlobalKey, <span class="built_in">Element</span>&gt; _registry = &lt;GlobalKey, <span class="built_in">Element</span>&gt;&#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将当前 Key 对象和 Element 对象关联起来，this 就是当前 key 对象</span></span><br><span class="line">  <span class="keyword">void</span> _register(<span class="built_in">Element</span> element) &#123;</span><br><span class="line">    _registry[<span class="keyword">this</span>] = element;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _unregister(<span class="built_in">Element</span> element) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_registry[<span class="keyword">this</span>] == element)</span><br><span class="line">      _registry.remove(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 [2.5.4.3] 可知，这里是 GlobalObjectKey 类型的对象。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/widgets/framework.dart</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalObjectKey</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StatefulWidget</span>&gt;&gt; <span class="keyword">extends</span> <span class="title">GlobalKey</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">Creates a global key that uses [identical] on [value] for its [operator==].</span></span></span><br><span class="line">  <span class="keyword">const</span> GlobalObjectKey(<span class="keyword">this</span>.value) : <span class="keyword">super</span>.constructor();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">The object whose identity is used by this key&#x27;s [operator==].</span></span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Object</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">operator</span> ==(<span class="built_in">Object</span> other) &#123;</span><br><span class="line">    <span class="keyword">if</span> (other.runtimeType != runtimeType)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> other <span class="keyword">is</span> GlobalObjectKey&lt;T&gt;</span><br><span class="line">        &amp;&amp; identical(other.value, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> hashCode =&gt; identityHashCode(value);</span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 [2.5.1] 可知，value 就是 [2.3.3.2] 的 renderView 对象，说明 GlobalObjectKey 是用来处理 render tree 和 element tree 之间的节点关系。</p>
<h2 id="2-7-createRenderObject"><a href="#2-7-createRenderObject" class="headerlink" title="2.7 createRenderObject"></a>2.7 createRenderObject</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RenderObjectWithChildMixin&lt;T&gt; createRenderObject(BuildContext context) =&gt; container;</span><br></pre></td></tr></table></figure>
<p>将 [2.3.6.2] 的 renderView 对象赋值给 <code>_renderObject</code> 。</p>
<h2 id="2-8-attachRenderObject"><a href="#2-8-attachRenderObject" class="headerlink" title="2.8 attachRenderObject"></a>2.8 attachRenderObject</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attachRenderObject(<span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(_ancestorRenderObjectElement == <span class="keyword">null</span>);</span><br><span class="line">    _slot = newSlot;</span><br><span class="line">    <span class="comment">// 选择此 element tree 的祖先节点，此时为 null.</span></span><br><span class="line">    _ancestorRenderObjectElement = _findAncestorRenderObjectElement();</span><br><span class="line">    <span class="comment">// 向 element 树中插入刚刚创建的 renderObject</span></span><br><span class="line">    _ancestorRenderObjectElement?.insertRenderObjectChild(renderObject, newSlot);</span><br><span class="line">    <span class="keyword">final</span> ParentDataElement&lt;ParentData&gt; parentDataElement = _findAncestorParentDataElement();</span><br><span class="line">    <span class="keyword">if</span> (parentDataElement != <span class="keyword">null</span>)</span><br><span class="line">      _updateParentData(parentDataElement.widget);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>此时 newSlot _ancestorRenderObjectElement _slot 均为 null, 同上，后面的 _ancestorRenderObjectElement parentDataElement 也为 null.</p>
<h2 id="2-9-rebuild"><a href="#2-9-rebuild" class="headerlink" title="2.9 _rebuild"></a>2.9 _rebuild</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _rebuild() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 见 [2.9.1]</span></span><br><span class="line">    _child = updateChild(_child, widget.child, _rootChildSlot);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法的相关入参</p>
<ul>
<li>_child: 第一次执行，_child 为 null</li>
<li>widget.child: widget: RenderObjectToWidgetAdapter 对象，所以 widget.child 就是 [2.4.1] 中我们在 main.dart 中自定义的 root widget</li>
<li>_rootChildSlot: <code>static const Object _rootChildSlot = Object();</code> 是一个常量，表示一个 element 只有一个 child</li>
</ul>
<h3 id="2-9-1-Element-updateChild"><a href="#2-9-1-Element-updateChild" class="headerlink" title="2.9.1 Element.updateChild"></a>2.9.1 Element.updateChild</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Element</span> updateChild(<span class="built_in">Element</span> child, Widget newWidget, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">  <span class="keyword">if</span> (newWidget == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</span><br><span class="line">      <span class="comment">// 移除旧的 element</span></span><br><span class="line">      deactivateChild(child);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Element</span> newChild;</span><br><span class="line">  <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">bool</span> hasSameSuperclass = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; child.widget == newWidget) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.slot != newSlot)</span><br><span class="line">        <span class="comment">// 更新 element</span></span><br><span class="line">        updateSlotForChild(child, newSlot);</span><br><span class="line">      newChild = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.slot != newSlot)</span><br><span class="line">        <span class="comment">// 更新 element</span></span><br><span class="line">        updateSlotForChild(child, newSlot);</span><br><span class="line">      <span class="comment">// 更新 widget  </span></span><br><span class="line">      child.update(newWidget);</span><br><span class="line">      newChild = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newChild = inflateWidget(newWidget, newSlot);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 见 [2.9.2]</span></span><br><span class="line">    newChild = inflateWidget(newWidget, newSlot);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-9-2-Element-inflateWidget"><a href="#2-9-2-Element-inflateWidget" class="headerlink" title="2.9.2 Element.inflateWidget"></a>2.9.2 Element.inflateWidget</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Element</span> inflateWidget(Widget newWidget, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">  <span class="keyword">final</span> Key key = newWidget.key;</span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">is</span> GlobalKey) &#123;</span><br><span class="line">    <span class="comment">// 从 _inactiveElements 中找可复用的 element</span></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Element</span> newChild = _retakeInactiveElement(key, newWidget);</span><br><span class="line">    <span class="keyword">if</span> (newChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 激活</span></span><br><span class="line">      newChild._activateWithParent(<span class="keyword">this</span>, newSlot);</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">Element</span> updatedChild = updateChild(newChild, newWidget, newSlot);</span><br><span class="line">      <span class="keyword">return</span> updatedChild;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建 element, 见 [2.9.3], 这里是 StatefulElement</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Element</span> newChild = newWidget.createElement();</span><br><span class="line">  <span class="comment">// 见 [2.9.4]</span></span><br><span class="line">  newChild.mount(<span class="keyword">this</span>, newSlot);</span><br><span class="line">  <span class="keyword">return</span> newChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 key 为 null.</p>
<h3 id="2-9-3-createElement"><a href="#2-9-3-createElement" class="headerlink" title="2.9.3 createElement"></a>2.9.3 createElement</h3><p>这个的 root widget 是 StatefulWidget 类型，所以会走</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatefulElement</span> <span class="keyword">extends</span> <span class="title">ComponentElement</span> </span>&#123;</span><br><span class="line">    StatefulElement(StatefulWidget widget) : _state = widget.createState(), <span class="keyword">super</span>(widget) &#123;</span><br><span class="line">        _state._element = <span class="keyword">this</span>;</span><br><span class="line">        _state._widget = widget;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的方法主要功能</p>
<ul>
<li>对 _state 赋值</li>
<li>对 element 的 widget 赋值，见前面的 <code>2.5.4.3 Element.mount</code></li>
<li>对 _state._element 赋值</li>
<li>对 _state._widget 赋值</li>
</ul>
<p>由此看见， state 是一个桥接类，关联 element 和 widget.</p>
<h3 id="2-9-4-ComponentElement-mount"><a href="#2-9-4-ComponentElement-mount" class="headerlink" title="2.9.4 ComponentElement.mount"></a>2.9.4 ComponentElement.mount</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">    <span class="comment">// 见 [2.5.4.3], 不过这里 parent 有值，是 [2.5.4] 新建的 RenderObjectToWidgetElement(root element)</span></span><br><span class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">    <span class="keyword">assert</span>(_child == <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">assert</span>(_active);</span><br><span class="line">    <span class="comment">// 见 [2.9.5]</span></span><br><span class="line">    _firstBuild();</span><br><span class="line">    <span class="keyword">assert</span>(_child != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StatefulElement extends ComponentElement extends Element,  ComponentElement 是跟 <code>2.5.4.2 RenderObjectElement</code> 是同级别的子类。</p>
<h3 id="2-9-5-ComponentElement-firstBuild"><a href="#2-9-5-ComponentElement-firstBuild" class="headerlink" title="2.9.5 ComponentElement._firstBuild"></a>2.9.5 ComponentElement._firstBuild</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _firstBuild() &#123;</span><br><span class="line">    <span class="comment">// 见 [2.9.5.1]</span></span><br><span class="line">    rebuild();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-9-5-1-Element-rebuild"><a href="#2-9-5-1-Element-rebuild" class="headerlink" title="2.9.5.1 Element.rebuild"></a>2.9.5.1 Element.rebuild</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> rebuild() &#123;</span><br><span class="line">    <span class="comment">// 未被激活(没调用 mount 方法) 或者 没被标脏(没调用相关 update 方法或者 markNeedsBuild 方法)，则不会走下面的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (!_active || !_dirty)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 见 [2.9.5.2]  </span></span><br><span class="line">    performRebuild();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-9-5-2-StatefulElement-performRebuild"><a href="#2-9-5-2-StatefulElement-performRebuild" class="headerlink" title="2.9.5.2 StatefulElement.performRebuild"></a>2.9.5.2 StatefulElement.performRebuild</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> performRebuild() &#123;</span><br><span class="line">    <span class="comment">// 只有调用当前类的 didChangeDependencies 方法，才会将 _didChangeDependencies 置为 true</span></span><br><span class="line">    <span class="keyword">if</span> (_didChangeDependencies) &#123;</span><br><span class="line">      <span class="comment">// 调用 state didChangeDependencies 方法</span></span><br><span class="line">      _state.didChangeDependencies();</span><br><span class="line">      _didChangeDependencies = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 [2.9.5.3]</span></span><br><span class="line">    <span class="keyword">super</span>.performRebuild();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-9-5-3-ComponentElement-performRebuild"><a href="#2-9-5-3-ComponentElement-performRebuild" class="headerlink" title="2.9.5.3 ComponentElement.performRebuild"></a>2.9.5.3 ComponentElement.performRebuild</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> performRebuild() &#123;</span><br><span class="line">    Widget built;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 见 [2.9.5.4]</span></span><br><span class="line">        built = build();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 已 build, 后续不要再构建</span></span><br><span class="line">        _dirty = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 同 [2.9.1], 第一次 _child 为 null</span></span><br><span class="line">        _child = updateChild(_child, built, slot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-9-5-4-build"><a href="#2-9-5-4-build" class="headerlink" title="2.9.5.4 build"></a>2.9.5.4 build</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Widget build() =&gt; _state.build(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>自此，最终会调用 rootwidget, 即 _MyAppState 的 build 方法。</p>
<h2 id="2-10-scheduleWarmUpFrame"><a href="#2-10-scheduleWarmUpFrame" class="headerlink" title="2.10 scheduleWarmUpFrame"></a>2.10 scheduleWarmUpFrame</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> scheduleWarmUpFrame() &#123;</span><br><span class="line">  <span class="keyword">if</span> (_warmUpFrame || schedulerPhase != SchedulerPhase.idle)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  _warmUpFrame = <span class="keyword">true</span>;</span><br><span class="line">  Timeline.startSync(<span class="string">&#x27;Warm-up frame&#x27;</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> hadScheduledFrame = _hasScheduledFrame;</span><br><span class="line">  <span class="comment">// 异步执行, 执行完上面的代码才会执行 `2.4.1 attachRootWidget`</span></span><br><span class="line">  <span class="comment">// We use timers here to ensure that microtasks flush in between.</span></span><br><span class="line">  Timer.run(() &#123;</span><br><span class="line">    <span class="keyword">assert</span>(_warmUpFrame);</span><br><span class="line">    handleBeginFrame(<span class="keyword">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  Timer.run(() &#123;</span><br><span class="line">    <span class="keyword">assert</span>(_warmUpFrame);</span><br><span class="line">    handleDrawFrame();</span><br><span class="line">    <span class="comment">// We call resetEpoch after this frame so that, in the hot reload case,</span></span><br><span class="line">    <span class="comment">// the very next frame pretends to have occurred immediately after this</span></span><br><span class="line">    <span class="comment">// warm-up frame. The warm-up frame&#x27;s timestamp will typically be far in</span></span><br><span class="line">    <span class="comment">// the past (the time of the last real frame), so if we didn&#x27;t reset the</span></span><br><span class="line">    <span class="comment">// epoch we would see a sudden jump from the old time in the warm-up frame</span></span><br><span class="line">    <span class="comment">// to the new time in the &quot;real&quot; frame. The biggest problem with this is</span></span><br><span class="line">    <span class="comment">// that implicit animations end up being triggered at the old time and</span></span><br><span class="line">    <span class="comment">// then skipping every frame and finishing in the new time.</span></span><br><span class="line">    resetEpoch();</span><br><span class="line">    _warmUpFrame = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (hadScheduledFrame)</span><br><span class="line">      scheduleFrame();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lock events so touch events etc don&#x27;t insert themselves until the</span></span><br><span class="line">  <span class="comment">// scheduled frame has finished.</span></span><br><span class="line">  lockEvents(() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> endOfFrame;</span><br><span class="line">    Timeline.finishSync();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行绘制操作。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h1><p>从 2.1 的 runApp 入口可知，</p>
<ol>
<li>WidgetsFlutterBinding 初始化，这是一个单例，负责创建各种绑定对象，有的时候我们需要将这段代码前置，使得各种绑定操作在 runApp 之前完成；</li>
<li>attachRootWidget, 自底向上遍历整个视图树，创建 element、renderObject 对象，建立 widget、element、renderObject 三者之间的关系；</li>
<li>scheduleWarmUpFrame, 执行绘制操作</li>
</ol>
<p>Q: 自底向上遍历整个视图树的时候，感觉 mount 无线递归执行，什么时候完成呢？<br>A: 当遍历到最顶层的 widget 时，在调用 updateChild 的时候回返回 null, 也就是<code>递</code>的结束，从而<code>归</code>回来，然后回到 <code>2.5 attachToRenderTree</code>，返回 RenderObjectToWidgetElement 类型的 root element. 我把前面 demo 的 debug 流程贴出来，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">RenderObjectToWidgetElement </span><br><span class="line">- mount  // parent: null, newSlot: null</span><br><span class="line">	- _rebuild</span><br><span class="line">		- updateChild  // child: null, newWidget: MyApp</span><br><span class="line">			- inflateWidget // newWidget: MyApp</span><br><span class="line">				- createElement // StatefulElement: ComponentElement</span><br><span class="line">					- mount  </span><br><span class="line"></span><br><span class="line">StatefulElement: ComponentElement </span><br><span class="line">- mount // parent: [root](renderObject: RenderView#5a380 NEEDS-LAYOUT NEEDS-PAINT)</span><br><span class="line">	- _firstBuild</span><br><span class="line">		- rebuild</span><br><span class="line">			- performRebuild</span><br><span class="line">				- updateChild // child: null, newWidget: Container</span><br><span class="line">					- inflateWidget // newWidget: Container</span><br><span class="line">						- createElement // StatelessElement: ComponentElement</span><br><span class="line">							- mount // </span><br><span class="line"></span><br><span class="line">StatelessElement: ComponentElement</span><br><span class="line">- mount // parent: MyApp(state: _MyAppState#9e4bc)</span><br><span class="line">	- _firstBuild</span><br><span class="line">		- rebuild</span><br><span class="line">			- performRebuild // StatelessElement.build</span><br><span class="line">				- updateChild // child: null, newWidget: LimitedBox</span><br><span class="line">					- inflateWidget // newWidget: LimitedBox(maxWidth: 0.0, maxHeight: 0.0)</span><br><span class="line">						- createElement // SingleChildRenderObjectElement: RenderObjectElement</span><br><span class="line">							- mount</span><br><span class="line"></span><br><span class="line">SingleChildRenderObjectElement</span><br><span class="line">- mount // parent: Container</span><br><span class="line">	- updateChild // child: null, newWidget: ConstrainedBox(BoxConstraints(biggest))</span><br><span class="line">		- inflateWidget // newWidget: ConstrainedBox(BoxConstraints(biggest))</span><br><span class="line">			- createElement // SingleChildRenderObjectElement: RenderObjectElement</span><br><span class="line">				- mount</span><br><span class="line"></span><br><span class="line">SingleChildRenderObjectElement</span><br><span class="line">- mount // parent: LimitedBox(maxWidth: 0.0, maxHeight: 0.0, renderObject: RenderLimitedBox#3d07c NEEDS-LAYOUT NEEDS-PAINT NEEDS-COMPOSITING-BITS-U</span><br><span class="line">	- updateChild // child: null, newWidget: null</span><br></pre></td></tr></table></figure>
<h2 id="3-1-问题"><a href="#3-1-问题" class="headerlink" title="3.1 问题"></a>3.1 问题</h2><ol>
<li>三棵树的关系，element 的具体功能</li>
<li>不同 element 执行 build 方法的时机</li>
<li>key slot 等联系</li>
<li>整个执行一帧的流程</li>
<li>页面刷新的具体流程，setState vs provider 局部刷新</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/flutter-source-code-ios-platform-channels/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/flutter-source-code-ios-platform-channels/" class="post-title-link" itemprop="url">iOS Flutter Platform Channel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-07 18:37:37" itemprop="dateCreated datePublished" datetime="2021-04-07T18:37:37+08:00">2021-04-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">flutter</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文基于 flutter 1.22.2 源码，在 ios_debug_unopt 产物下调试。</p>
</blockquote>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文下面的 demo(来自 <a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a>) 和 flutter 源码来分析 ios platform channels 的实现。</p>
<h2 id="1-1-demo"><a href="#1-1-demo" class="headerlink" title="1.1 demo"></a>1.1 demo</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:async&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/services.dart&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> platform = <span class="keyword">const</span> MethodChannel(<span class="string">&#x27;samples.flutter.dev/battery&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get battery level.</span></span><br><span class="line">  <span class="built_in">String</span> _batteryLevel = <span class="string">&#x27;Unknown battery level.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; _getBatteryLevel() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">String</span> batteryLevel;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">int</span> result = <span class="keyword">await</span> platform.invokeMethod(<span class="string">&#x27;getBatteryLevel&#x27;</span>);</span><br><span class="line">      batteryLevel = <span class="string">&#x27;Battery level at <span class="subst">$result</span> % .&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">on</span> PlatformException <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      batteryLevel = <span class="string">&quot;Failed to get battery level: &#x27;<span class="subst">$&#123;e.message&#125;</span>&#x27;.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _batteryLevel = batteryLevel;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Flutter&#x2F;Flutter.h&gt;</span><br><span class="line">#import &quot;GeneratedPluginRegistrant.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation AppDelegate</span><br><span class="line">- (BOOL)application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions &#123;</span><br><span class="line">  FlutterViewController* controller &#x3D; (FlutterViewController*)self.window.rootViewController;</span><br><span class="line"></span><br><span class="line">  FlutterMethodChannel* batteryChannel &#x3D; [FlutterMethodChannel</span><br><span class="line">                                          methodChannelWithName:@&quot;samples.flutter.dev&#x2F;battery&quot;</span><br><span class="line">                                          binaryMessenger:controller.binaryMessenger];</span><br><span class="line"></span><br><span class="line">  __weak typeof(self) weakSelf &#x3D; self;</span><br><span class="line">  [batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) &#123;</span><br><span class="line">      &#x2F;&#x2F; Note: this method is invoked on the UI thread.</span><br><span class="line">      if ([@&quot;getBatteryLevel&quot; isEqualToString:call.method]) &#123;</span><br><span class="line">        int batteryLevel &#x3D; [weakSelf getBatteryLevel];</span><br><span class="line">        </span><br><span class="line">        if (batteryLevel &#x3D;&#x3D; -1) &#123;</span><br><span class="line">          result([FlutterError errorWithCode:@&quot;UNAVAILABLE&quot;</span><br><span class="line">                                     message:@&quot;Battery info unavailable&quot;</span><br><span class="line">                                     details:nil]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          result(@(batteryLevel));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        result(FlutterMethodNotImplemented);</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line">  [GeneratedPluginRegistrant registerWithRegistry:self];</span><br><span class="line">  return [super application:application didFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)getBatteryLevel &#123;</span><br><span class="line">  UIDevice* device &#x3D; UIDevice.currentDevice;</span><br><span class="line">  device.batteryMonitoringEnabled &#x3D; YES;</span><br><span class="line">  if (device.batteryState &#x3D;&#x3D; UIDeviceBatteryStateUnknown) &#123;</span><br><span class="line">    return -1;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return (int)(device.batteryLevel * 100);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-Dart-层"><a href="#2-Dart-层" class="headerlink" title="2. Dart 层"></a>2. Dart 层</h1><h2 id="2-1-MethodChannel-初始化"><a href="#2-1-MethodChannel-初始化" class="headerlink" title="2.1 MethodChannel 初始化"></a>2.1 MethodChannel 初始化</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A named channel for communicating with platform plugins using asynchronous method calls.</span></span></span><br><span class="line"><span class="keyword">const</span> MethodChannel(<span class="keyword">this</span>.name, [<span class="keyword">this</span>.codec = <span class="keyword">const</span> StandardMethodCodec(), BinaryMessenger? binaryMessenger ])</span><br><span class="line">      : <span class="keyword">assert</span>(name != <span class="keyword">null</span>),</span><br><span class="line">        <span class="keyword">assert</span>(codec != <span class="keyword">null</span>),</span><br><span class="line">        _binaryMessenger = binaryMessenger;</span><br></pre></td></tr></table></figure>
<p>初始化，默认是使用标准编解码器 <code>StandardMethodCodec</code>，在发送到 <code>platform plugin</code> 要使用 <code>codec</code> 进行编码，同样 <code>platform plugin</code> 发送过来的消息要解码成 Dart 层的数据。所以，<code>platform plugin</code> 那边需要兼容 Dart 层的 <code>codec</code>。</p>
<h2 id="2-2-MessageCodec-抽象类"><a href="#2-2-MessageCodec-抽象类" class="headerlink" title="2.2 MessageCodec 抽象类"></a>2.2 MessageCodec 抽象类</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A message encoding/decoding mechanism.</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCodec</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  ByteData? encodeMessage(T message);</span><br><span class="line">  T decodeMessage(ByteData? message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StandardMethodCodec</code> 实现了抽象类 <code>MessageCodec</code> 的编解码方法。</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mzy8_dvuO_7jpkfRcL_zpKQPzaxo5SWf7xWupP1dN-lR4kd9U5Z-UG7VVpscyQGF7iMkN6ijMHGd6VS5xe-Oc8cJ5pn3-MDVTgn-7Ofeu5LUNkq8JbdlrhzjHkx7vSWZNXT7llmx5wNwpQdHXKPDJi8Gd0zjwISaK4eUHUZSn7WPjvJM2v-JpSKbwzi91ISeq?width=1510&height=298&cropmode=none" alt="-w755"></p>
<p>从上图可知，目标有四个类实现了 <code>MessageCodec</code> 。</p>
<ul>
<li>BinaryCodec: [MessageCodec] with unencoded binary messages represented using [ByteData]. // 没编码的原始二进制数据类型 </li>
<li>JSONMessageCodec: [MessageCodec] with UTF-8 encoded JSON messages. // utf-8 编码的 json 消息</li>
<li>StandardMessageCodec: [MessageCodec] using the Flutter standard binary encoding. // flutter 标准的二进制编码，可以参考 <a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a> 的 <code>Platform channel data types support and codecs</code> 小节，当然 <code>class StandardMessageCodec implements MessageCodec&lt;dynamic&gt; &#123;</code> 定义上面的注释也有解释。</li>
<li>StringCodec: [MessageCodec] with UTF-8 encoded String messages. // utf-8 编码的字符串消息 </li>
</ul>
<h2 id="2-3-invokeMethod"><a href="#2-3-invokeMethod" class="headerlink" title="2.3 invokeMethod"></a>2.3 invokeMethod</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T?&gt; invokeMethod&lt;T&gt;(<span class="built_in">String</span> method, [ <span class="built_in">dynamic</span> arguments ]) &#123;</span><br><span class="line">    <span class="keyword">return</span> _invokeMethod&lt;T&gt;(method, missingOk: <span class="keyword">false</span>, arguments: arguments);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T?&gt; _invokeMethod&lt;T&gt;(<span class="built_in">String</span> method, &#123; <span class="keyword">required</span> <span class="built_in">bool</span> missingOk, <span class="built_in">dynamic</span> arguments &#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span>(method != <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 见 2.6</span></span><br><span class="line">    <span class="keyword">final</span> ByteData? result = <span class="keyword">await</span> binaryMessenger.send(</span><br><span class="line">      name,</span><br><span class="line">      codec.encodeMethodCall(MethodCall(method, arguments)),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (missingOk) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> MissingPluginException(<span class="string">&#x27;No implementation found for method <span class="subst">$method</span> on channel <span class="subst">$name</span>&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 [6.6]</span></span><br><span class="line">    <span class="keyword">return</span> codec.decodeEnvelope(result) <span class="keyword">as</span> T;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
<ol>
<li>创建 MethodCall 对象[见 2.3.1]</li>
<li>调用 StandardMessageCodec 的 encodeMethodCall, 将 MethodCall 对象编码成 ByteData 数据[见 2.3.2]</li>
<li>调用 BinaryMessenger 来发送 ByteData 数据 [见 2.4]</li>
<li>调用 StandardMessageCodec 的 decodeEnvelope, 将发送返回后的结果进行解码</li>
</ol>
<h3 id="2-3-1-MethodCall初始化"><a href="#2-3-1-MethodCall初始化" class="headerlink" title="2.3.1 MethodCall初始化"></a>2.3.1 MethodCall初始化</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MethodCall(<span class="keyword">this</span>.method, [<span class="keyword">this</span>.arguments])</span><br><span class="line">    : <span class="keyword">assert</span>(method != <span class="keyword">null</span>); <span class="comment">// 方法名，非空</span></span><br></pre></td></tr></table></figure>
<p>这里的参数就是 <code>invokeMethod</code> 方法的入参 <code>method</code> 和 <code>arguments</code> 。</p>
<h3 id="2-3-2-encodeMethodCall"><a href="#2-3-2-encodeMethodCall" class="headerlink" title="2.3.2 encodeMethodCall"></a>2.3.2 encodeMethodCall</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codec.dart</p>
</blockquote>
<p>来自抽象类 <code>MethodCodec</code>, 对方法调用和结果进行编解码。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">A codec for method calls and enveloped results.</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCodec</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes the specified [methodCall] into binary.</span></span></span><br><span class="line">  ByteData encodeMethodCall(MethodCall methodCall);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Decodes the specified [methodCall] from binary.</span></span></span><br><span class="line">  MethodCall decodeMethodCall(ByteData? methodCall);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Decodes the specified result [envelope] from binary.</span></span></span><br><span class="line">  <span class="built_in">dynamic</span> decodeEnvelope(ByteData envelope);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes a successful [result] into a binary envelope.</span></span></span><br><span class="line">  ByteData encodeSuccessEnvelope(<span class="built_in">dynamic</span> result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Encodes an error result into a binary envelope.</span></span></span><br><span class="line">  ByteData encodeErrorEnvelope(&#123; <span class="keyword">required</span> <span class="built_in">String</span> code, <span class="built_in">String?</span> message, <span class="built_in">dynamic</span> details&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>flutter/packages/flutter/lib/src/services/message_codecs.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">ByteData encodeMethodCall(MethodCall call) &#123;</span><br><span class="line">    <span class="comment">// 创建一个写buffer, 见 [2.3.3]</span></span><br><span class="line">    <span class="keyword">final</span> WriteBuffer buffer = WriteBuffer();</span><br><span class="line">    <span class="comment">// 调用 StandardMessageCodec 的 writeValue 方法，将数据写入 buffer</span></span><br><span class="line">    messageCodec.writeValue(buffer, call.method);</span><br><span class="line">    messageCodec.writeValue(buffer, call.arguments);</span><br><span class="line">    <span class="keyword">return</span> buffer.done();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-WriteBuffer"><a href="#2-3-3-WriteBuffer" class="headerlink" title="2.3.3 WriteBuffer"></a>2.3.3 WriteBuffer</h3><blockquote>
<p>flutter/packages/flutter/lib/src/foundation/serialization.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WriteBuffer()</span><br><span class="line">    : _buffer = Uint8Buffer(),</span><br><span class="line">      _eightBytes = ByteData(<span class="number">8</span>) &#123;</span><br><span class="line">    _eightBytesAsList = _eightBytes.buffer.asUint8List();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> ByteData done() &#123;</span><br><span class="line">    <span class="keyword">final</span> ByteData result = _buffer!.buffer.asByteData(<span class="number">0</span>, _buffer!.lengthInBytes);</span><br><span class="line">    _buffer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 返回最后的写入结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<h2 id="2-4-binaryMessenger-send"><a href="#2-4-binaryMessenger-send" class="headerlink" title="2.4 binaryMessenger.send"></a>2.4 binaryMessenger.send</h2><blockquote>
<p>flutter/packages/flutter/lib/src/services/platform_channel.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BinaryMessenger <span class="keyword">get</span> binaryMessenger =&gt; _binaryMessenger ?? defaultBinaryMessenger;</span><br><span class="line"></span><br><span class="line">BinaryMessenger <span class="keyword">get</span> defaultBinaryMessenger &#123;</span><br><span class="line">  <span class="keyword">assert</span>(() &#123;</span><br><span class="line">    <span class="keyword">if</span> (ServicesBinding.instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> FlutterError(</span><br><span class="line">        <span class="string">&#x27;ServicesBinding.defaultBinaryMessenger was accessed before the &#x27;</span></span><br><span class="line">        <span class="string">&#x27;binding was initialized.\n&#x27;</span></span><br><span class="line">        <span class="string">&quot;If you&#x27;re running an application and need to access the binary &quot;</span></span><br><span class="line">        <span class="string">&#x27;messenger before `runApp()` has been called (for example, during &#x27;</span></span><br><span class="line">        <span class="string">&#x27;plugin initialization), then you need to explicitly call the &#x27;</span></span><br><span class="line">        <span class="string">&#x27;`WidgetsFlutterBinding.ensureInitialized()` first.\n&#x27;</span></span><br><span class="line">        <span class="string">&quot;If you&#x27;re running a test, you can call the &quot;</span></span><br><span class="line">        <span class="string">&#x27;`TestWidgetsFlutterBinding.ensureInitialized()` as the first line in &#x27;</span></span><br><span class="line">        <span class="string">&quot;your test&#x27;s `main()` method to initialize the binding.&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;());</span><br><span class="line">  <span class="comment">// 见 [2.4.1]</span></span><br><span class="line">  <span class="keyword">return</span> ServicesBinding.instance!.defaultBinaryMessenger;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>MethodChannel</code> 初始化的时候没有传 <code>BinaryMessenger</code> 对象，所以这里是用的默认值：<code>ServicesBinding.instance!.defaultBinaryMessenger</code>.</p>
<h3 id="2-4-1-sendPlatformMessage"><a href="#2-4-1-sendPlatformMessage" class="headerlink" title="2.4.1 _sendPlatformMessage"></a>2.4.1 _sendPlatformMessage</h3><blockquote>
<p>flutter/packages/flutter/lib/src/services/binding.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DefaultBinaryMessenger</span> <span class="keyword">extends</span> <span class="title">BinaryMessenger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _DefaultBinaryMessenger._();</span><br><span class="line">  Future&lt;ByteData?&gt; _sendPlatformMessage(<span class="built_in">String</span> channel, ByteData? message) &#123;</span><br><span class="line">    <span class="comment">// 见 [2.4.2]</span></span><br><span class="line">    <span class="keyword">final</span> Completer&lt;ByteData?&gt; completer = Completer&lt;ByteData?&gt;();</span><br><span class="line">    <span class="comment">// ui.window is accessed directly instead of using ServicesBinding.instance.window</span></span><br><span class="line">    <span class="comment">// because this method might be invoked before any binding is initialized.</span></span><br><span class="line">    <span class="comment">// This issue was reported in #27541. It is not ideal to statically access</span></span><br><span class="line">    <span class="comment">// ui.window because the Window may be dependency injected elsewhere with</span></span><br><span class="line">    <span class="comment">// a different instance. However, static access at this location seems to be</span></span><br><span class="line">    <span class="comment">// the least bad option.</span></span><br><span class="line">    <span class="comment">// 见 [2.5]</span></span><br><span class="line">    ui.<span class="built_in">window</span>.sendPlatformMessage(channel, message, (ByteData? reply) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 见 [3.1.1], 会在 engine 层保存起来</span></span><br><span class="line">        completer.complete(reply);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-2-Completer-初始化"><a href="#2-4-2-Completer-初始化" class="headerlink" title="2.4.2 Completer 初始化"></a>2.4.2 Completer 初始化</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/async/future.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 见 [2.4.3]</span></span><br><span class="line"><span class="keyword">factory</span> Completer() =&gt; <span class="keyword">new</span> _AsyncCompleter&lt;T&gt;();</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-AsyncCompleter-初始化"><a href="#2-4-3-AsyncCompleter-初始化" class="headerlink" title="2.4.3 _AsyncCompleter 初始化"></a>2.4.3 _AsyncCompleter 初始化</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/async/future_impl.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">_Completer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Completer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _Future&lt;T&gt; future = <span class="keyword">new</span> _Future&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> complete([FutureOr&lt;T&gt;? value]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _completeError(<span class="built_in">Object</span> error, StackTrace stackTrace);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The future&#x27;s _isComplete doesn&#x27;t take into account pending completions.</span></span><br><span class="line">  <span class="comment">// We therefore use _mayComplete.</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isCompleted =&gt; !future._mayComplete;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AsyncCompleter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">_Completer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> complete([FutureOr&lt;T&gt;? value]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!future._mayComplete) <span class="keyword">throw</span> <span class="keyword">new</span> StateError(<span class="string">&quot;Future already completed&quot;</span>);</span><br><span class="line">    <span class="comment">// 见 [6.5]</span></span><br><span class="line">    future._asyncComplete(value == <span class="keyword">null</span> ? value <span class="keyword">as</span> <span class="built_in">dynamic</span> : value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-window-sendPlatformMessage"><a href="#2-5-window-sendPlatformMessage" class="headerlink" title="2.5 window.sendPlatformMessage"></a>2.5 window.sendPlatformMessage</h2><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/ui/window.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                         ByteData? data,</span><br><span class="line">                         PlatformMessageResponseCallback? callback) &#123;</span><br><span class="line">  <span class="comment">// 见[2.5.1]</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> error =</span><br><span class="line">      _sendPlatformMessage(name, _zonedPlatformMessageResponseCallback(callback), data); </span><br><span class="line">  <span class="keyword">if</span> (error != <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> Exception(error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 见 [3.1]</span></span><br><span class="line"><span class="built_in">String?</span> _sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                            PlatformMessageResponseCallback? callback,</span><br><span class="line">                            ByteData? data) native <span class="string">&#x27;PlatformConfiguration_sendPlatformMessage&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><code>_sendPlatformMessage</code> 是一个 Native 代码，会调用到引擎层。</p>
<h3 id="2-5-1-zonedPlatformMessageResponseCallback"><a href="#2-5-1-zonedPlatformMessageResponseCallback" class="headerlink" title="2.5.1 _zonedPlatformMessageResponseCallback"></a>2.5.1 _zonedPlatformMessageResponseCallback</h3><blockquote>
<p>flutter/bin/cache/pkg/sky_engine/lib/ui/window.dart</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">Wraps the given [callback] in another callback that ensures that the</span></span></span><br><span class="line">  <span class="comment">/// <span class="markdown">original callback is called in the zone it was registered in.</span></span></span><br><span class="line">  <span class="keyword">static</span> PlatformMessageResponseCallback? _zonedPlatformMessageResponseCallback(PlatformMessageResponseCallback? callback) &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the zone in which the callback is being registered.</span></span><br><span class="line">    <span class="keyword">final</span> Zone registrationZone = Zone.current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (ByteData? data) &#123;</span><br><span class="line">      registrationZone.runUnaryGuarded(callback, data);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>将当前注册回调的 <code>Zone.current</code> 存起来。</p>
<h1 id="3-engine-层"><a href="#3-engine-层" class="headerlink" title="3. engine 层"></a>3. engine 层</h1><h2 id="3-1-SendPlatformMessage"><a href="#3-1-SendPlatformMessage" class="headerlink" title="3.1 _SendPlatformMessage"></a>3.1 _SendPlatformMessage</h2><blockquote>
<p>engine/src/flutter/lib/ui/window/platform_configuration.cc</p>
</blockquote>
<p>在 flutter 源码中搜索 <code>_sendPlatformMessage</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_configuration.cc -L137</span></span><br><span class="line"><span class="keyword">void</span> _SendPlatformMessage(Dart_NativeArguments args) &#123;</span><br><span class="line">  tonic::DartCallStatic(&amp;SendPlatformMessage, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// platform_configuration.cc -L105</span></span><br><span class="line"><span class="function">Dart_Handle <span class="title">SendPlatformMessage</span><span class="params">(Dart_Handle window,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle data_handle)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取当前 dart_state                               </span></span><br><span class="line">  UIDartState* dart_state = UIDartState::Current();</span><br><span class="line">  <span class="comment">// 没有 platform_configuration, 抛出异常</span></span><br><span class="line">  <span class="keyword">if</span> (!dart_state-&gt;platform_configuration()) &#123;</span><br><span class="line">    <span class="keyword">return</span> tonic::ToDart(</span><br><span class="line">        <span class="string">&quot;Platform messages can only be sent from the main isolate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fml::RefPtr&lt;PlatformMessageResponse&gt; response;</span><br><span class="line">  <span class="keyword">if</span> (!Dart_IsNull(callback)) &#123;</span><br><span class="line">    <span class="comment">// 见 [3.1.1] 和 [3.1.2]</span></span><br><span class="line">    response = fml::MakeRefCounted&lt;PlatformMessageResponseDart&gt;(</span><br><span class="line">        tonic::DartPersistentValue(dart_state, callback),</span><br><span class="line">        dart_state-&gt;GetTaskRunners().GetUITaskRunner());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsNull(data_handle)) &#123;</span><br><span class="line">    dart_state-&gt;platform_configuration()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(name, response));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tonic::DartByteData data(data_handle);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* buffer = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(data.data());</span><br><span class="line">    <span class="comment">// 见 [3.2]</span></span><br><span class="line">    dart_state-&gt;platform_configuration()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(</span><br><span class="line">            name, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;(buffer, buffer + data.length_in_bytes()),</span><br><span class="line">            response));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Dart_Null();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
<ol>
<li>发送平台消息，只允许在主 isolate 中发出，否则会抛出异常</li>
<li>相关参数<ol>
<li>window: Dart 层的 window</li>
<li>name: channel 名</li>
<li>callback: 见 [3.1.1] 的描述</li>
<li>data_handle: 编码后的 <code>MethodCall</code> 对象，也就是待执行的方法和参数，后续赋值给 PlatformMessage 对象的 data 成员变量</li>
</ol>
</li>
<li>创建 PlatformMessageResponseDart 对象，保存 callback 和 GetUITaskRunner</li>
<li>调用 RuntimeController 的 HandlePlatformMessage 方法，入参为 PlatformMessage, 见 [3.1.3]</li>
</ol>
<h3 id="3-1-1-DartPersistentValue"><a href="#3-1-1-DartPersistentValue" class="headerlink" title="3.1.1 DartPersistentValue"></a>3.1.1 DartPersistentValue</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dart_persistent_value.cc -L20</span></span><br><span class="line">DartPersistentValue::DartPersistentValue(DartState* dart_state,</span><br><span class="line">                                         Dart_Handle value)</span><br><span class="line">    : value_(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">  Set(dart_state, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dart_persistent_value.cc -L30</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DartPersistentValue::Set</span><span class="params">(DartState* dart_state, Dart_Handle value)</span> </span>&#123;</span><br><span class="line">  TONIC_DCHECK(is_empty());</span><br><span class="line">  dart_state_ = dart_state-&gt;GetWeakPtr();</span><br><span class="line">  value_ = Dart_NewPersistentHandle(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>dart_state</code> 和 <code>callback</code> 封装成 <code>DartPersistentValue</code> 对象，这里的 <code>callback</code> 就是 [2.4] 中的 <code>completer.complete(reply);</code>，处理发送返回的数据。</p>
<h3 id="3-1-2-PlatformMessageResponseDart-初始化"><a href="#3-1-2-PlatformMessageResponseDart-初始化" class="headerlink" title="3.1.2 PlatformMessageResponseDart 初始化"></a>3.1.2 PlatformMessageResponseDart 初始化</h3><blockquote>
<p>engine/src/flutter/lib/ui/window/platform_message_response_dart.cc</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PlatformMessageResponseDart::PlatformMessageResponseDart(</span><br><span class="line">    tonic::DartPersistentValue callback,</span><br><span class="line">    fml::RefPtr&lt;fml::TaskRunner&gt; ui_task_runner)</span><br><span class="line">    : callback_(<span class="built_in">std</span>::move(callback)),</span><br><span class="line">      ui_task_runner_(<span class="built_in">std</span>::move(ui_task_runner)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>简单的赋初始值。</p>
<h3 id="3-1-3-PlatformMessage-初始化"><a href="#3-1-3-PlatformMessage-初始化" class="headerlink" title="3.1.3 PlatformMessage 初始化"></a>3.1.3 PlatformMessage 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message.cc -L11</span></span><br><span class="line">PlatformMessage::PlatformMessage(<span class="built_in">std</span>::<span class="built_in">string</span> channel,</span><br><span class="line">                                 <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; data,</span><br><span class="line">                                 fml::RefPtr&lt;PlatformMessageResponse&gt; response)</span><br><span class="line">    : channel_(<span class="built_in">std</span>::move(channel)),</span><br><span class="line">      data_(<span class="built_in">std</span>::move(data)),</span><br><span class="line">      hasData_(<span class="literal">true</span>),</span><br><span class="line">      response_(<span class="built_in">std</span>::move(response)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>该方法相关入参</p>
<ul>
<li>channel: channel 名</li>
<li>data: data_handle(见 [3.1] 的描述) 转换后的值</li>
<li>response: 见 [3.1.1], 对 <code>3.1.1</code> 和 <code>callback</code> 的封装</li>
</ul>
<p>至此， Dart 层传过来的数据以及在 engine 层转换后的数据，都封装在了 <code>PlatformMessage</code> 对象中，后续在 engine 层都是操作该 <code>PlatformMessage</code> 对象。</p>
<h2 id="3-2-RuntimeController-HandlePlatformMessage"><a href="#3-2-RuntimeController-HandlePlatformMessage" class="headerlink" title="3.2 RuntimeController::HandlePlatformMessage"></a>3.2 RuntimeController::HandlePlatformMessage</h2><blockquote>
<p>engine/src/flutter/runtime/runtime_controller.cc </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |PlatformConfigurationClient|</span></span><br><span class="line"><span class="comment">// runtime_controller.cc -L328</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RuntimeController::HandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 3.3 </span></span><br><span class="line">  client_.HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>note: 这块的逻辑代码需要了解 flutter 的引擎启动。</p>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime_controller.cc -L64</span></span><br><span class="line">RuntimeController::RuntimeController(</span><br><span class="line">    RuntimeDelegate&amp; p_client,</span><br><span class="line">    DartVM* p_vm,</span><br><span class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; p_isolate_snapshot,</span><br><span class="line">    TaskRunners p_task_runners,</span><br><span class="line">    fml::WeakPtr&lt;SnapshotDelegate&gt; p_snapshot_delegate,</span><br><span class="line">    fml::WeakPtr&lt;HintFreedDelegate&gt; p_hint_freed_delegate,</span><br><span class="line">    fml::WeakPtr&lt;IOManager&gt; p_io_manager,</span><br><span class="line">    fml::RefPtr&lt;SkiaUnrefQueue&gt; p_unref_queue,</span><br><span class="line">    fml::WeakPtr&lt;ImageDecoder&gt; p_image_decoder,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_uri,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_entrypoint,</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">int64_t</span>)&gt;&amp; idle_notification_callback,</span><br><span class="line">    <span class="keyword">const</span> PlatformData&amp; p_platform_data,</span><br><span class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_create_callback,</span><br><span class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_shutdown_callback,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="keyword">const</span> fml::Mapping&gt; p_persistent_isolate_data)</span><br><span class="line">    : client_(p_client),</span><br><span class="line">      vm_(p_vm),</span><br><span class="line">      isolate_snapshot_(<span class="built_in">std</span>::move(p_isolate_snapshot)),</span><br><span class="line">      task_runners_(p_task_runners),</span><br><span class="line">      snapshot_delegate_(p_snapshot_delegate),</span><br><span class="line">      hint_freed_delegate_(p_hint_freed_delegate),</span><br><span class="line">      io_manager_(p_io_manager),</span><br><span class="line">      unref_queue_(p_unref_queue),</span><br><span class="line">      image_decoder_(p_image_decoder),</span><br><span class="line">      advisory_script_uri_(p_advisory_script_uri),</span><br><span class="line">      advisory_script_entrypoint_(p_advisory_script_entrypoint),</span><br><span class="line">      idle_notification_callback_(idle_notification_callback),</span><br><span class="line">      platform_data_(<span class="built_in">std</span>::move(p_platform_data)),</span><br><span class="line">      isolate_create_callback_(p_isolate_create_callback),</span><br><span class="line">      isolate_shutdown_callback_(p_isolate_shutdown_callback),</span><br><span class="line">      persistent_isolate_data_(<span class="built_in">std</span>::move(p_persistent_isolate_data)) &#123;</span><br><span class="line">  <span class="comment">// Create the root isolate as soon as the runtime controller is initialized.</span></span><br><span class="line">  <span class="comment">// It will be run at a later point when the engine provides a run</span></span><br><span class="line">  <span class="comment">// configuration and then runs the isolate.</span></span><br><span class="line">  <span class="keyword">auto</span> strong_root_isolate =</span><br><span class="line">      DartIsolate::CreateRootIsolate(</span><br><span class="line">          vm_-&gt;GetVMData()-&gt;GetSettings(),                <span class="comment">//</span></span><br><span class="line">          isolate_snapshot_,                              <span class="comment">//</span></span><br><span class="line">          task_runners_,                                  <span class="comment">//</span></span><br><span class="line">          <span class="built_in">std</span>::make_unique&lt;PlatformConfiguration&gt;(<span class="keyword">this</span>),  <span class="comment">//</span></span><br><span class="line">          snapshot_delegate_,                             <span class="comment">//</span></span><br><span class="line">          hint_freed_delegate_,                           <span class="comment">//</span></span><br><span class="line">          io_manager_,                                    <span class="comment">//</span></span><br><span class="line">          unref_queue_,                                   <span class="comment">//</span></span><br><span class="line">          image_decoder_,                                 <span class="comment">//</span></span><br><span class="line">          p_advisory_script_uri,                          <span class="comment">//</span></span><br><span class="line">          p_advisory_script_entrypoint,                   <span class="comment">//</span></span><br><span class="line">          <span class="literal">nullptr</span>,                                        <span class="comment">//</span></span><br><span class="line">          isolate_create_callback_,                       <span class="comment">//</span></span><br><span class="line">          isolate_shutdown_callback_                      <span class="comment">//</span></span><br><span class="line">          )</span><br><span class="line">          .lock();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;PlatformConfiguration&gt;(this)</code>: 将当前 <code>RuntimeController</code> 对象作为入参初始化 <code>PlatformConfiguration</code> 对象(赋值给 <code>client_</code> 成员变量)。</p>
<h2 id="3-3-Engine-HandlePlatformMessage"><a href="#3-3-Engine-HandlePlatformMessage" class="headerlink" title="3.3 Engine::HandlePlatformMessage"></a>3.3 Engine::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L496</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Engine::HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kAssetChannel) &#123;</span><br><span class="line">    HandleAssetPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 见 [3.4]</span></span><br><span class="line">    delegate_.OnEngineHandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L59</span></span><br><span class="line">Engine::Engine(Delegate&amp; delegate,</span><br><span class="line">               <span class="keyword">const</span> PointerDataDispatcherMaker&amp; dispatcher_maker,</span><br><span class="line">               DartVM&amp; vm,</span><br><span class="line">               fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</span><br><span class="line">               TaskRunners task_runners,</span><br><span class="line">               <span class="keyword">const</span> PlatformData platform_data,</span><br><span class="line">               Settings settings,</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Animator&gt; animator,</span><br><span class="line">               fml::WeakPtr&lt;IOManager&gt; io_manager,</span><br><span class="line">               fml::RefPtr&lt;SkiaUnrefQueue&gt; unref_queue,</span><br><span class="line">               fml::WeakPtr&lt;SnapshotDelegate&gt; snapshot_delegate)</span><br><span class="line">    : Engine(delegate,</span><br><span class="line">             dispatcher_maker,</span><br><span class="line">             vm.GetConcurrentWorkerTaskRunner(),</span><br><span class="line">             task_runners,</span><br><span class="line">             settings,</span><br><span class="line">             <span class="built_in">std</span>::move(animator),</span><br><span class="line">             io_manager,</span><br><span class="line">             <span class="literal">nullptr</span>) &#123;</span><br><span class="line">  runtime_controller_ = <span class="built_in">std</span>::make_unique&lt;RuntimeController&gt;(</span><br><span class="line">      *<span class="keyword">this</span>,                                 <span class="comment">// runtime delegate</span></span><br><span class="line">      &amp;vm,                                   <span class="comment">// VM</span></span><br><span class="line">      <span class="built_in">std</span>::move(isolate_snapshot),           <span class="comment">// isolate snapshot</span></span><br><span class="line">      task_runners_,                         <span class="comment">// task runners</span></span><br><span class="line">      <span class="built_in">std</span>::move(snapshot_delegate),          <span class="comment">// snapshot delegate</span></span><br><span class="line">      GetWeakPtr(),                          <span class="comment">// hint freed delegate</span></span><br><span class="line">      <span class="built_in">std</span>::move(io_manager),                 <span class="comment">// io manager</span></span><br><span class="line">      <span class="built_in">std</span>::move(unref_queue),                <span class="comment">// Skia unref queue</span></span><br><span class="line">      image_decoder_.GetWeakPtr(),           <span class="comment">// image decoder</span></span><br><span class="line">      settings_.advisory_script_uri,         <span class="comment">// advisory script uri</span></span><br><span class="line">      settings_.advisory_script_entrypoint,  <span class="comment">// advisory script entrypoint</span></span><br><span class="line">      settings_.idle_notification_callback,  <span class="comment">// idle notification callback</span></span><br><span class="line">      platform_data,                         <span class="comment">// platform data</span></span><br><span class="line">      settings_.isolate_create_callback,     <span class="comment">// isolate create callback</span></span><br><span class="line">      settings_.isolate_shutdown_callback,   <span class="comment">// isolate shutdown callback</span></span><br><span class="line">      settings_.persistent_isolate_data      <span class="comment">// persistent isolate data</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;RuntimeController&gt;(</code>: 将当前 <code>engine</code> 对象作为入参初始化 <code>RuntimeController</code> 对象(赋值给 <code>client_</code> 成员变量)。</p>
<h2 id="3-4-Shell-OnEngineHandlePlatformMessage"><a href="#3-4-Shell-OnEngineHandlePlatformMessage" class="headerlink" title="3.4 Shell::OnEngineHandlePlatformMessage"></a>3.4 Shell::OnEngineHandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |Engine::Delegate|</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Shell::OnEngineHandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  FML_DCHECK(is_setup_);</span><br><span class="line">  FML_DCHECK(task_runners_.GetUITaskRunner()-&gt;RunsTasksOnCurrentThread());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kSkiaChannel) &#123;</span><br><span class="line">    HandleEngineSkiaMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在 Platform 线程中执行任务  </span></span><br><span class="line">  task_runners_.GetPlatformTaskRunner()-&gt;PostTask(</span><br><span class="line">      [view = platform_view_-&gt;GetWeakPtr(), message = <span class="built_in">std</span>::move(message)]() &#123;</span><br><span class="line">        <span class="keyword">if</span> (view) &#123;</span><br><span class="line">          <span class="comment">// 见 [3.5]</span></span><br><span class="line">          view-&gt;HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关调用链在 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L152</span></span><br><span class="line">  fml::TaskRunner::RunNowOrPostTask(</span><br><span class="line">      shell-&gt;GetTaskRunners().GetUITaskRunner(),</span><br><span class="line">      fml::MakeCopyable([&amp;engine_promise,                                 <span class="comment">//</span></span><br><span class="line">                         shell = shell.get(),                             <span class="comment">//</span></span><br><span class="line">                         &amp;dispatcher_maker,                               <span class="comment">//</span></span><br><span class="line">                         &amp;platform_data,                                  <span class="comment">//</span></span><br><span class="line">                         isolate_snapshot = <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">//</span></span><br><span class="line">                         vsync_waiter = <span class="built_in">std</span>::move(vsync_waiter),          <span class="comment">//</span></span><br><span class="line">                         &amp;weak_io_manager_future,                         <span class="comment">//</span></span><br><span class="line">                         &amp;snapshot_delegate_future,                       <span class="comment">//</span></span><br><span class="line">                         &amp;unref_queue_future                              <span class="comment">//</span></span><br><span class="line">  ]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">        TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;ShellSetupUISubsystem&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; task_runners = shell-&gt;GetTaskRunners();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The animator is owned by the UI thread but it gets its vsync pulses</span></span><br><span class="line">        <span class="comment">// from the platform.</span></span><br><span class="line">        <span class="keyword">auto</span> animator = <span class="built_in">std</span>::make_unique&lt;Animator&gt;(*shell, task_runners,</span><br><span class="line">                                                   <span class="built_in">std</span>::move(vsync_waiter));</span><br><span class="line"></span><br><span class="line">        engine_promise.set_value(<span class="built_in">std</span>::make_unique&lt;Engine&gt;(</span><br><span class="line">            *shell,                         <span class="comment">//</span></span><br><span class="line">            dispatcher_maker,               <span class="comment">//</span></span><br><span class="line">            *shell-&gt;GetDartVM(),            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">std</span>::move(isolate_snapshot),    <span class="comment">//</span></span><br><span class="line">            task_runners,                   <span class="comment">//</span></span><br><span class="line">            platform_data,                  <span class="comment">//</span></span><br><span class="line">            shell-&gt;GetSettings(),           <span class="comment">//</span></span><br><span class="line">            <span class="built_in">std</span>::move(animator),            <span class="comment">//</span></span><br><span class="line">            weak_io_manager_future.get(),   <span class="comment">//</span></span><br><span class="line">            unref_queue_future.get(),       <span class="comment">//</span></span><br><span class="line">            snapshot_delegate_future.get()  <span class="comment">//</span></span><br><span class="line">            ));</span><br><span class="line">      &#125;));</span><br></pre></td></tr></table></figure>
<p><code>std::make_unique&lt;Engine&gt;(</code>: 将 <code>*shell</code> 指针作为入参初始化 <code>Engine</code> 对象(赋值给 <code>delegate_</code> 成员变量)。</p>
<h2 id="3-5-PlatformViewIOS-HandlePlatformMessage"><a href="#3-5-PlatformViewIOS-HandlePlatformMessage" class="headerlink" title="3.5 PlatformViewIOS::HandlePlatformMessage"></a>3.5 PlatformViewIOS::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |PlatformView|</span></span><br><span class="line"><span class="comment">// platform_view_ios.mm -L61</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformViewIOS::HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;flutter::PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 [3.6]</span></span><br><span class="line">  platform_message_router_.HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>platform_view_</p>
<p>相关调用链如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L544, 给 platform_view_ 赋值</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Shell::Setup</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PlatformView&gt; platform_view,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Engine&gt; engine,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Rasterizer&gt; rasterizer,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ShellIOManager&gt; io_manager)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  platform_view_ = <span class="built_in">std</span>::move(platform_view);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shell.cc -L167</span></span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; <span class="title">Shell::CreateShellOnPlatformThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    DartVMRef vm,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskRunners task_runners,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> PlatformData platform_data,</span></span></span><br><span class="line"><span class="function"><span class="params">    Settings settings,</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Shell::CreateCallback&lt;PlatformView&gt;&amp; on_create_platform_view,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Shell::CreateCallback&lt;Rasterizer&gt;&amp; on_create_rasterizer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取 platform_view</span></span><br><span class="line">    <span class="keyword">auto</span> platform_view = on_create_platform_view(*shell.get());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!shell-&gt;Setup(<span class="built_in">std</span>::move(platform_view),  <span class="comment">//</span></span><br><span class="line">                    engine_future.get(),       <span class="comment">//</span></span><br><span class="line">                    rasterizer_future.get(),   <span class="comment">//</span></span><br><span class="line">                    io_manager_future.get())   <span class="comment">//</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FlutterEngine.mm -L513</span></span><br><span class="line">- (BOOL)createShell:(NSString*)entrypoint</span><br><span class="line">         libraryURI:(NSString*)libraryURI</span><br><span class="line">       initialRoute:(NSString*)initialRoute &#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   <span class="comment">// on_create_platform_view 回调</span></span><br><span class="line">   flutter::Shell::CreateCallback&lt;flutter::PlatformView&gt; on_create_platform_view =</span><br><span class="line">      [](flutter::Shell&amp; shell) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;flutter::PlatformViewIOS&gt;(</span><br><span class="line">            shell, flutter::GetRenderingAPIForProcess(), shell.GetTaskRunners());</span><br><span class="line">      &#125;;      </span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-6-PlatformMessageRouter-HandlePlatformMessage"><a href="#3-6-PlatformMessageRouter-HandlePlatformMessage" class="headerlink" title="3.6 PlatformMessageRouter::HandlePlatformMessage"></a>3.6 PlatformMessageRouter::HandlePlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_router.mm -L17</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageRouter::HandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;flutter::PlatformMessage&gt; message)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// [3.1.2] 中的 PlatformMessageResponseDart 对象  </span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessageResponse&gt; completer = message-&gt;response();</span><br><span class="line">  <span class="comment">// message-&gt;channel(): [3.1] 中的 channel 名</span></span><br><span class="line">  <span class="keyword">auto</span> it = message_handlers_.find(message-&gt;channel());</span><br><span class="line">  <span class="keyword">if</span> (it != message_handlers_.end()) &#123;</span><br><span class="line">    FlutterBinaryMessageHandler handler = it-&gt;second;</span><br><span class="line">    NSData* data = nil;</span><br><span class="line">    <span class="keyword">if</span> (message-&gt;hasData()) &#123;</span><br><span class="line">      <span class="comment">// 由 [3.1.3] 可知， message-&gt;data() 就是编码后的 `MethodCall` 对象</span></span><br><span class="line">      data = GetNSDataFromVector(message-&gt;data());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 [5.4]</span></span><br><span class="line">    handler(data, ^(NSData* reply) &#123;</span><br><span class="line">      <span class="keyword">if</span> (completer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">          <span class="comment">// 见 [6.1]</span></span><br><span class="line">          completer-&gt;Complete(GetMappingFromNSData(reply));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          completer-&gt;CompleteEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (completer) &#123;</span><br><span class="line">      completer-&gt;CompleteEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法注意功能：</p>
<ol>
<li>根据 channel 名在 message_handlers_ unordered_map 中找到对应的 FlutterBinaryMessageHandler 类型的 handler</li>
<li>调用 handler 回调方法获取 reply 数据</li>
<li>将 reply 数据作为入参，调用 PlatformMessageResponseDart 对象的 Complete 方法</li>
</ol>
<p>现在的问题是， FlutterBinaryMessageHandler 类型的 handler 是在哪里赋值的，也就是什么时候调用 [4.4] 的方法，详见下一小节：[4]。</p>
<h1 id="4-shell-层"><a href="#4-shell-层" class="headerlink" title="4. shell 层"></a>4. shell 层</h1><p>note: 这块的逻辑代码需要了解 flutter 的引擎启动。<br>在创建 engine 的时候，会设置 engine 层相关的 channel. </p>
<blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterEngine.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm  -L541</span></span><br><span class="line">- (BOOL)createShell:(NSString*)entrypoint</span><br><span class="line">         libraryURI:(NSString*)libraryURI</span><br><span class="line">       initialRoute:(NSString*)initialRoute &#123;</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">   <span class="comment">// 见 [4.1]</span></span><br><span class="line">   [self setupChannels];</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">   [self maybeSetupPlatformViewChannels];</span><br><span class="line">   <span class="comment">// ...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-1-setupChannels"><a href="#4-1-setupChannels" class="headerlink" title="4.1 setupChannels"></a>4.1 setupChannels</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterEngine.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L367</span></span><br><span class="line">- (<span class="keyword">void</span>)setupChannels &#123;</span><br><span class="line">  <span class="comment">// This will be invoked once the shell is done setting up and the isolate ID</span></span><br><span class="line">  <span class="comment">// for the UI isolate is available.</span></span><br><span class="line">  fml::WeakPtr&lt;FlutterEngine&gt; weakSelf = [self getWeakPtr];</span><br><span class="line">  <span class="comment">// 见 [4.2]</span></span><br><span class="line">  [_binaryMessenger setMessageHandlerOnChannel:@<span class="string">&quot;flutter/isolate&quot;</span></span><br><span class="line">                          binaryMessageHandler:^(NSData* message, FlutterBinaryReply reply) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (weakSelf) &#123;</span><br><span class="line">                              weakSelf.get().isolateId =</span><br><span class="line">                                  [[FlutterStringCodec sharedInstance] decode:message];</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;];</span><br><span class="line">  <span class="comment">// ...                          </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置 <code>flutter/isolate</code> channel。</p>
<h3 id="4-1-1-FlutterBinaryMessengerRelay-初始化"><a href="#4-1-1-FlutterBinaryMessengerRelay-初始化" class="headerlink" title="4.1.1 FlutterBinaryMessengerRelay 初始化"></a>4.1.1 FlutterBinaryMessengerRelay 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L132</span></span><br><span class="line">- (instancetype)initWithName:(NSString*)labelPrefix</span><br><span class="line">                     project:(FlutterDartProject*)project</span><br><span class="line">      allowHeadlessExecution:(BOOL)allowHeadlessExecution &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// 将当前 FlutterEngine 对象赋值给 FlutterBinaryMessengerRelay 对象 _binaryMessenger 的 parent 成员变量。</span></span><br><span class="line">      _binaryMessenger = [[FlutterBinaryMessengerRelay alloc] initWithParent:self];</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-setMessageHandlerOnChannel"><a href="#4-2-setMessageHandlerOnChannel" class="headerlink" title="4.2 setMessageHandlerOnChannel"></a>4.2 setMessageHandlerOnChannel</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/ios/framework/Source/FlutterBinaryMessengerRelay.mm</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterBinaryMessengerRelay.mm -L42</span></span><br><span class="line">- (FlutterBinaryMessengerConnection)setMessageHandlerOnChannel:(NSString*)channel</span><br><span class="line">                                          binaryMessageHandler:</span><br><span class="line">                                              (FlutterBinaryMessageHandler)handler &#123;</span><br><span class="line">  <span class="keyword">if</span> (self.parent) &#123;</span><br><span class="line">    <span class="comment">// 见 [4.3]</span></span><br><span class="line">    <span class="keyword">return</span> [self.parent setMessageHandlerOnChannel:channel binaryMessageHandler:handler];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FML_LOG(WARNING) &lt;&lt; <span class="string">&quot;Communicating on a dead channel.&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-setMessageHandlerOnChannel"><a href="#4-3-setMessageHandlerOnChannel" class="headerlink" title="4.3 setMessageHandlerOnChannel"></a>4.3 setMessageHandlerOnChannel</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L730</span></span><br><span class="line">- (FlutterBinaryMessengerConnection)setMessageHandlerOnChannel:(NSString*)channel</span><br><span class="line">                                          binaryMessageHandler:</span><br><span class="line">                                              (FlutterBinaryMessageHandler)handler &#123;</span><br><span class="line">  NSParameterAssert(channel);</span><br><span class="line">  <span class="keyword">if</span> (_shell &amp;&amp; _shell-&gt;IsSetup()) &#123;</span><br><span class="line">    <span class="comment">// 见 [4.4]</span></span><br><span class="line">    self.iosPlatformView-&gt;GetPlatformMessageRouter().SetMessageHandler(channel.UTF8String, handler);</span><br><span class="line">    <span class="keyword">return</span> _connections-&gt;AquireConnection(channel.UTF8String);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    NSAssert(!handler, @<span class="string">&quot;Setting a message handler before the FlutterEngine has been run.&quot;</span>);</span><br><span class="line">    <span class="comment">// Setting a handler to nil for a not setup channel is a noop.</span></span><br><span class="line">    <span class="keyword">return</span> flutter::ConnectionCollection::MakeErrorConnection(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-PlatformMessageRouter-SetMessageHandler"><a href="#4-4-PlatformMessageRouter-SetMessageHandler" class="headerlink" title="4.4 PlatformMessageRouter::SetMessageHandler"></a>4.4 PlatformMessageRouter::SetMessageHandler</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_router.mm -L43</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageRouter::SetMessageHandler</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; channel,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              FlutterBinaryMessageHandler handler)</span> </span>&#123;</span><br><span class="line">  message_handlers_.erase(channel);</span><br><span class="line">  <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">    message_handlers_[channel] =</span><br><span class="line">        fml::ScopedBlock&lt;FlutterBinaryMessageHandler&gt;&#123;handler, fml::OwnershipPolicy::Retain&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-native-层"><a href="#5-native-层" class="headerlink" title="5. native 层"></a>5. native 层</h1><p>现在来看下 native 层的 Objective-C 的代码，来自 [1.1] 节。</p>
<h2 id="5-1-FlutterMethodChannel-初始化"><a href="#5-1-FlutterMethodChannel-初始化" class="headerlink" title="5.1 FlutterMethodChannel 初始化"></a>5.1 FlutterMethodChannel 初始化</h2><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Source/FlutterChannels.mm</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L181</span></span><br><span class="line">+ (instancetype)methodChannelWithName:(NSString*)name</span><br><span class="line">                      binaryMessenger:(NSObject&lt;FlutterBinaryMessenger&gt;*)messenger &#123;</span><br><span class="line">  <span class="comment">// 见 [5.1.1]                    </span></span><br><span class="line">  NSObject&lt;FlutterMethodCodec&gt;* codec = [FlutterStandardMethodCodec sharedInstance];</span><br><span class="line">  <span class="comment">// 创建 FlutterMethodChannel 对象</span></span><br><span class="line">  <span class="keyword">return</span> [FlutterMethodChannel methodChannelWithName:name binaryMessenger:messenger codec:codec];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法注意功能</p>
<ol>
<li>入参<ol>
<li>name: channel 名</li>
<li>messenger: (FlutterViewController *)controller.binaryMessenger // 也就是 [4.1.1] 里面的对象</li>
</ol>
</li>
<li>创建 FlutterMethodChannel 对象，后面调用它的 <code>setMethodCallHandler</code> 来处理 Dart 层的调用方法 // 见 [5.2]</li>
</ol>
<h3 id="5-1-1-FlutterStandardMethodCodec"><a href="#5-1-1-FlutterStandardMethodCodec" class="headerlink" title="5.1.1 FlutterStandardMethodCodec"></a>5.1.1 FlutterStandardMethodCodec</h3><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Source/FlutterStandardCodec.mm </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L60</span></span><br><span class="line">@implementation FlutterStandardMethodCodec &#123;</span><br><span class="line">  FlutterStandardReaderWriter* _readerWriter;</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)sharedInstance &#123;</span><br><span class="line">  <span class="keyword">static</span> id _sharedInstance = nil;</span><br><span class="line">  <span class="keyword">if</span> (!_sharedInstance) &#123;</span><br><span class="line">    <span class="comment">// 见 [5.1.2]</span></span><br><span class="line">    FlutterStandardReaderWriter* readerWriter =</span><br><span class="line">        [[[FlutterStandardReaderWriter alloc] init] autorelease];</span><br><span class="line">    _sharedInstance = [[FlutterStandardMethodCodec alloc] initWithReaderWriter:readerWriter];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _sharedInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2-FlutterMessageCodec"><a href="#5-1-2-FlutterMessageCodec" class="headerlink" title="5.1.2 FlutterMessageCodec"></a>5.1.2 FlutterMessageCodec</h3><blockquote>
<p>engine/src/flutter/shell/platform/darwin/common/framework/Headers/FlutterCodecs.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A factory of compatible reader/writer instances using the Flutter standard</span></span><br><span class="line"><span class="comment"> * binary encoding or extensions thereof.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FLUTTER_EXPORT</span><br><span class="line">@interface FlutterStandardReaderWriter : NSObject</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A message encoding/decoding mechanism.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FLUTTER_EXPORT</span><br><span class="line">@protocol FlutterMessageCodec</span><br></pre></td></tr></table></figure>
<p>上面的注释 <code>A message encoding/decoding mechanism.</code> 跟 [2.2] 是一样的，所以 <code>FlutterCodecs</code> 文件中的相关编解码类是跟 Dart 层是相对应的(Dart 层中 ByteData8 对应 iOS 中的 NSData)。</p>
<h2 id="5-2-setMethodCallHandler-方法"><a href="#5-2-setMethodCallHandler-方法" class="headerlink" title="5.2 setMethodCallHandler 方法"></a>5.2 setMethodCallHandler 方法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L231</span></span><br><span class="line">- (<span class="keyword">void</span>)setMethodCallHandler:(FlutterMethodCallHandler)handler &#123;</span><br><span class="line">  <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_connection &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      [_messenger cleanupConnection:_connection];</span><br><span class="line">      _connection = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [_messenger setMessageHandlerOnChannel:_name binaryMessageHandler:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Make sure the block captures the codec, not self.</span></span><br><span class="line">  NSObject&lt;FlutterMethodCodec&gt;* codec = _codec;</span><br><span class="line">  <span class="comment">// 见 [5.3], 这里 messageHandler 就是 [3.6] 中的 handler 。</span></span><br><span class="line">  FlutterBinaryMessageHandler messageHandler = ^(NSData* message, FlutterBinaryReply callback) &#123;</span><br><span class="line">    <span class="comment">// 见 [5.3.1]</span></span><br><span class="line">    FlutterMethodCall* call = [codec decodeMethodCall:message];</span><br><span class="line">    <span class="comment">// 见 [5.4]</span></span><br><span class="line">    handler(call, ^(id result) &#123;</span><br><span class="line">      <span class="keyword">if</span> (result == FlutterMethodNotImplemented)</span><br><span class="line">        callback(nil);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ([result isKindOfClass:[FlutterError class]])</span><br><span class="line">        <span class="comment">// 见 [5.3.2]</span></span><br><span class="line">        callback([codec encodeErrorEnvelope:(FlutterError*)result]);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 见 [5.3.3]</span></span><br><span class="line">        callback([codec encodeSuccessEnvelope:result]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 见 [4.2]</span></span><br><span class="line">  _connection = [_messenger setMessageHandlerOnChannel:_name binaryMessageHandler:messageHandler];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-messageHandler"><a href="#5-3-messageHandler" class="headerlink" title="5.3 messageHandler"></a>5.3 messageHandler</h2><p>由前面 [3.6] 可知，根据 channel 名(<code>samples.flutter.dev/battery</code>) 找到 FlutterBinaryMessageHandler 回调后，就会调用它，里面就是 NSData 和 FlutterMethodCall 的相互转换，见 [5.3.1 ~ 5.3.3] 小节。</p>
<h3 id="5-3-1-decodeMethodCall"><a href="#5-3-1-decodeMethodCall" class="headerlink" title="5.3.1 decodeMethodCall"></a>5.3.1 decodeMethodCall</h3><p>由 [5.1.1] 可知，在 <code>FlutterStandardMethodCodec</code> 中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L115</span></span><br><span class="line">- (FlutterMethodCall*)decodeMethodCall:(NSData*)message &#123;</span><br><span class="line">  FlutterStandardReader* reader = [_readerWriter readerWithData:message];</span><br><span class="line">  id value1 = [reader readValue];</span><br><span class="line">  id value2 = [reader readValue];</span><br><span class="line">  NSAssert(![reader hasMore], @<span class="string">&quot;Corrupted standard method call&quot;</span>);</span><br><span class="line">  NSAssert([value1 isKindOfClass:[NSString class]], @<span class="string">&quot;Corrupted standard method call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> [FlutterMethodCall methodCallWithMethodName:value1 arguments:value2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将消息读出来，然后封装成 <code>FlutterMethodCall</code> 对象。</p>
<h3 id="5-3-2-encodeErrorEnvelope"><a href="#5-3-2-encodeErrorEnvelope" class="headerlink" title="5.3.2 encodeErrorEnvelope"></a>5.3.2 encodeErrorEnvelope</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L105</span></span><br><span class="line">- (NSData*)encodeErrorEnvelope:(FlutterError*)error &#123;</span><br><span class="line">  NSMutableData* data = [NSMutableData dataWithCapacity:<span class="number">32</span>];</span><br><span class="line">  FlutterStandardWriter* writer = [_readerWriter writerWithData:data];</span><br><span class="line">  [writer writeByte:<span class="number">1</span>];</span><br><span class="line">  [writer writeValue:error.code];</span><br><span class="line">  [writer writeValue:error.message];</span><br><span class="line">  [writer writeValue:error.details];</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 Error 组装成二进制数据。</p>
<h3 id="5-3-3-encodeSuccessEnvelope"><a href="#5-3-3-encodeSuccessEnvelope" class="headerlink" title="5.3.3 encodeSuccessEnvelope"></a>5.3.3 encodeSuccessEnvelope</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterStandardCodec.mm -L97</span></span><br><span class="line">- (NSData*)encodeSuccessEnvelope:(id)result &#123;</span><br><span class="line">  NSMutableData* data = [NSMutableData dataWithCapacity:<span class="number">32</span>];</span><br><span class="line">  FlutterStandardWriter* writer = [_readerWriter writerWithData:data];</span><br><span class="line">  [writer writeByte:<span class="number">0</span>];</span><br><span class="line">  [writer writeValue:result];</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将成功数据组装成二进制数据。</p>
<h3 id="5-4-setMethodCallHandler-回调"><a href="#5-4-setMethodCallHandler-回调" class="headerlink" title="5.4 setMethodCallHandler 回调"></a>5.4 setMethodCallHandler 回调</h3><p>这里以 [1.1] 为例，就是获取当前电量值，然后回调 result，在通过 [5.3.3] 或 [5.3.4] 转成 NSData 后，作为入参给 Complete 调用（见[6.1]）。</p>
<h1 id="6-回传结果"><a href="#6-回传结果" class="headerlink" title="6. 回传结果"></a>6. 回传结果</h1><h2 id="6-1-PlatformMessageResponseDart-Complete"><a href="#6-1-PlatformMessageResponseDart-Complete" class="headerlink" title="6.1 PlatformMessageResponseDart::Complete"></a>6.1 PlatformMessageResponseDart::Complete</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_dart.cc -L30</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageResponseDart::Complete</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;fml::Mapping&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (callback_.is_empty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  FML_DCHECK(!is_complete_);</span><br><span class="line">  is_complete_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 在 UI 线程中执行任务</span></span><br><span class="line">  ui_task_runner_-&gt;PostTask(fml::MakeCopyable(</span><br><span class="line">      [callback = <span class="built_in">std</span>::move(callback_), data = <span class="built_in">std</span>::move(data)]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">        <span class="comment">// callback_ 见 [3.1.1] 的赋初始值</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;tonic::DartState&gt; dart_state =</span><br><span class="line">            callback.dart_state().lock();</span><br><span class="line">        <span class="keyword">if</span> (!dart_state) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tonic::DartState::Scope scope(dart_state);</span><br><span class="line">        <span class="comment">// 见 [6.2]</span></span><br><span class="line">        Dart_Handle byte_buffer =</span><br><span class="line">            tonic::DartByteData::Create(data-&gt;GetMapping(), data-&gt;GetSize());</span><br><span class="line">        <span class="comment">// 见 [6.3]    </span></span><br><span class="line">        tonic::DartInvoke(callback.Release(), &#123;byte_buffer&#125;);</span><br><span class="line">      &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-DartByteData-Create"><a href="#6-2-DartByteData-Create" class="headerlink" title="6.2 DartByteData::Create"></a>6.2 DartByteData::Create</h2><blockquote>
<p>engine/src/flutter/third_party/tonic/typed_data/dart_byte_data.cc </p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dart_Handle <span class="title">DartByteData::Create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">size_t</span> length)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (length &lt; kExternalSizeThreshold) &#123;</span><br><span class="line">    <span class="keyword">auto</span> handle = DartByteData&#123;data, length&#125;.dart_handle();</span><br><span class="line">    <span class="comment">// The destructor should release the typed data.</span></span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">void</span>* buf = ::<span class="built_in">malloc</span>(length);</span><br><span class="line">    TONIC_DCHECK(buf);</span><br><span class="line">    ::<span class="built_in">memcpy</span>(buf, data, length);</span><br><span class="line">    <span class="keyword">return</span> Dart_NewExternalTypedDataWithFinalizer(</span><br><span class="line">        Dart_TypedData_kByteData, buf, length, buf, length, FreeFinalizer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 [5.4.3] 或 [5.4.4] 返回的 NSData 转成 Dart 层的 Data 类型。</p>
<h2 id="6-3-DartInvoke"><a href="#6-3-DartInvoke" class="headerlink" title="6.3 DartInvoke"></a>6.3 DartInvoke</h2><blockquote>
<p>engine/src/flutter/third_party/tonic/logging/dart_invoke.cc </p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dart_Handle <span class="title">DartInvoke</span><span class="params">(Dart_Handle closure,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;Dart_Handle&gt; args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> argc = args.size();</span><br><span class="line">  Dart_Handle* argv = <span class="keyword">const_cast</span>&lt;Dart_Handle*&gt;(args.begin());</span><br><span class="line">  <span class="comment">// 见 [6.4]</span></span><br><span class="line">  Dart_Handle handle = Dart_InvokeClosure(closure, argc, argv);</span><br><span class="line">  LogIfError(handle);</span><br><span class="line">  <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-4-Dart-InvokeClosure"><a href="#6-4-Dart-InvokeClosure" class="headerlink" title="6.4 Dart_InvokeClosure"></a>6.4 Dart_InvokeClosure</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DART_EXPORT Dart_Handle <span class="title">Dart_InvokeClosure</span><span class="params">(Dart_Handle closure,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">int</span> number_of_arguments,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           Dart_Handle* arguments)</span> </span>&#123;</span><br><span class="line">  DARTSCOPE(Thread::Current());</span><br><span class="line">  API_TIMELINE_DURATION(T);</span><br><span class="line">  CHECK_CALLBACK_STATE(T);</span><br><span class="line">  <span class="keyword">const</span> Instance&amp; closure_obj = Api::UnwrapInstanceHandle(Z, closure);</span><br><span class="line">  <span class="keyword">if</span> (closure_obj.IsNull() || !closure_obj.IsCallable(<span class="literal">NULL</span>)) &#123;</span><br><span class="line">    RETURN_TYPE_ERROR(Z, closure, Instance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number_of_arguments &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Api::NewError(</span><br><span class="line">        <span class="string">&quot;%s expects argument &#x27;number_of_arguments&#x27; to be non-negative.&quot;</span>,</span><br><span class="line">        CURRENT_FUNC);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up arguments to include the closure as the first argument.</span></span><br><span class="line">  <span class="keyword">const</span> Array&amp; args = Array::Handle(Z, Array::New(number_of_arguments + <span class="number">1</span>));</span><br><span class="line">  Object&amp; obj = Object::Handle(Z);</span><br><span class="line">  args.SetAt(<span class="number">0</span>, closure_obj);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; number_of_arguments; i++) &#123;</span><br><span class="line">    obj = Api::UnwrapHandle(arguments[i]);</span><br><span class="line">    <span class="keyword">if</span> (!obj.IsNull() &amp;&amp; !obj.IsInstance()) &#123;</span><br><span class="line">      RETURN_TYPE_ERROR(Z, arguments[i], Instance);</span><br><span class="line">    &#125;</span><br><span class="line">    args.SetAt(i + <span class="number">1</span>, obj);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Now try to invoke the closure.</span></span><br><span class="line">  <span class="keyword">return</span> Api::NewHandle(T, DartEntry::InvokeClosure(args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 Closure 的回调，也就是前面 [3.1] 的 <code>callback</code>, 详见 [3.1.1] 的描述，最终会调用到 [2.4.1] 的回调，也就是 [2.4.3] 中的方法。</p>
<h2 id="6-5-asyncComplete"><a href="#6-5-asyncComplete" class="headerlink" title="6.5 _asyncComplete"></a>6.5 _asyncComplete</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// future_impl.dart -L540</span></span><br><span class="line"><span class="keyword">void</span> _asyncComplete(FutureOr&lt;T&gt; value) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(!_isComplete);</span><br><span class="line">    <span class="comment">// Two corner cases if the value is a future:</span></span><br><span class="line">    <span class="comment">//   1. the future is already completed and an error.</span></span><br><span class="line">    <span class="comment">//   2. the future is not yet completed but might become an error.</span></span><br><span class="line">    <span class="comment">// The first case means that we must not immediately complete the Future,</span></span><br><span class="line">    <span class="comment">// as our code would immediately start propagating the error without</span></span><br><span class="line">    <span class="comment">// giving the time to install error-handlers.</span></span><br><span class="line">    <span class="comment">// However the second case requires us to deal with the value immediately.</span></span><br><span class="line">    <span class="comment">// Otherwise the value could complete with an error and report an</span></span><br><span class="line">    <span class="comment">// unhandled error, even though we know we are already going to listen to</span></span><br><span class="line">    <span class="comment">// it.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">is</span> Future&lt;T&gt;) &#123;</span><br><span class="line">      _chainFuture(value);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(40014): Remove cast when type promotion works.</span></span><br><span class="line">    <span class="comment">// This would normally be `as T` but we use `as dynamic` to make the</span></span><br><span class="line">    <span class="comment">// unneeded check be implict to match dart2js unsound optimizations in the</span></span><br><span class="line">    <span class="comment">// user code.</span></span><br><span class="line">    _asyncCompleteWithValue(value <span class="keyword">as</span> <span class="built_in">dynamic</span>); <span class="comment">// Value promoted to T.</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里的 value 就是 [6.1] 的入参 data, 就是 [1.1] <code>setMethodCallHandler</code> 后回调的值，通过 Complete 异步调用后，最终会调用到 [6.6].</p>
<h2 id="6-6-decodeEnvelope"><a href="#6-6-decodeEnvelope" class="headerlink" title="6.6 decodeEnvelope"></a>6.6 decodeEnvelope</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// message_codecs.dart -L570</span></span><br><span class="line"><span class="built_in">dynamic</span> decodeEnvelope(ByteData envelope) &#123;</span><br><span class="line">    <span class="comment">// First byte is zero in success case, and non-zero otherwise.</span></span><br><span class="line">    <span class="keyword">if</span> (envelope.lengthInBytes == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Expected envelope, got nothing&#x27;</span>);</span><br><span class="line">    <span class="comment">// 创建 ReadBuffer 对象</span></span><br><span class="line">    <span class="keyword">final</span> ReadBuffer buffer = ReadBuffer(envelope);</span><br><span class="line">    <span class="keyword">if</span> (buffer.getUint8() == <span class="number">0</span>)</span><br><span class="line">      <span class="comment">// 见 [6.6.1]</span></span><br><span class="line">      <span class="keyword">return</span> messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorCode = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorMessage = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> errorDetails = messageCodec.readValue(buffer);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String?</span> errorStacktrace = (buffer.hasRemaining) ? messageCodec.readValue(buffer) <span class="keyword">as</span> <span class="built_in">String</span> : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (errorCode <span class="keyword">is</span> <span class="built_in">String</span> &amp;&amp; (errorMessage == <span class="keyword">null</span> || errorMessage <span class="keyword">is</span> <span class="built_in">String</span>) &amp;&amp; !buffer.hasRemaining)</span><br><span class="line">      <span class="keyword">throw</span> PlatformException(code: errorCode, message: errorMessage <span class="keyword">as</span> <span class="built_in">String</span>, details: errorDetails, stacktrace: errorStacktrace);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Invalid envelope&#x27;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-6-1-readValue"><a href="#6-6-1-readValue" class="headerlink" title="6.6.1 readValue"></a>6.6.1 readValue</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dynamic</span> readValue(ReadBuffer buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!buffer.hasRemaining)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">const</span> FormatException(<span class="string">&#x27;Message corrupted&#x27;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> type = buffer.getUint8();</span><br><span class="line">    <span class="comment">// 转成 await 调用处需要的数据类型</span></span><br><span class="line">    <span class="keyword">return</span> readValueOfType(type, buffer);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-native-gt-dart"><a href="#7-native-gt-dart" class="headerlink" title="7. native -&gt; dart"></a>7. native -&gt; dart</h1><p>前面讲的是 dart 层异步调用 native 层，现在来讲下 native -&gt; dart 的大致逻辑，代码来自我们项目中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">    &#x2F;&#x2F; 见 [7.1]</span><br><span class="line">    [_channel invokeMethod:@&quot;didBeforeLoadRequest&quot; arguments:urlStr result:^(id  _Nullable result) &#123;</span><br><span class="line">        if ([result isKindOfClass:[NSNumber class]]) &#123;</span><br><span class="line">            if ([result boolValue]) &#123;</span><br><span class="line">                decisionHandler(WKNavigationActionPolicyAllow);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                decisionHandler(WKNavigationActionPolicyCancel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            decisionHandler(WKNavigationActionPolicyAllow);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-1-invokeMethod-arguments-result"><a href="#7-1-invokeMethod-arguments-result" class="headerlink" title="7.1 invokeMethod:arguments:result:"></a>7.1 invokeMethod:arguments:result:</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterChannels.mm -L219</span></span><br><span class="line">- (<span class="keyword">void</span>)invokeMethod:(NSString*)method arguments:(id)arguments result:(FlutterResult)callback &#123;</span><br><span class="line">  <span class="comment">// 初始化 FlutterMethodCall</span></span><br><span class="line">  FlutterMethodCall* methodCall = [FlutterMethodCall methodCallWithMethodName:method</span><br><span class="line">                                                                    arguments:arguments];</span><br><span class="line">  <span class="comment">// 将 FlutterMethodCall 编码成 NSData </span></span><br><span class="line">  NSData* message = [_codec encodeMethodCall:methodCall];</span><br><span class="line">  <span class="comment">// 回调操作</span></span><br><span class="line">  FlutterBinaryReply reply = ^(NSData* data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      callback((data == nil) ? FlutterMethodNotImplemented : [_codec decodeEnvelope:data]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 见 [7.2.1]</span></span><br><span class="line">  [_messenger sendOnChannel:_name message:message binaryReply:reply];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法主要功能：</p>
<ol>
<li>创建 <code>FlutterMethodCall</code> 对象，跟 [2.3] 是类似的</li>
<li>对 <code>FlutterMethodCall</code> 对象进行编码操作</li>
<li>reply: 对 dart 层返回的数据进行解码操作，并执行 callback 回调</li>
</ol>
<h3 id="7-2-1-sendOnChannel-message"><a href="#7-2-1-sendOnChannel-message" class="headerlink" title="7.2.1 sendOnChannel:message:"></a>7.2.1 sendOnChannel:message:</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterBinaryMessengerRelay.mm -L28</span></span><br><span class="line">- (<span class="keyword">void</span>)sendOnChannel:(NSString*)channel</span><br><span class="line">              message:(NSData*)message</span><br><span class="line">          binaryReply:(FlutterBinaryReply)callback &#123;</span><br><span class="line">  <span class="keyword">if</span> (self.parent) &#123;</span><br><span class="line">    <span class="comment">// 见 [7.2.2]</span></span><br><span class="line">    [self.parent sendOnChannel:channel message:message binaryReply:callback];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FML_LOG(WARNING) &lt;&lt; <span class="string">&quot;Communicating on a dead channel.&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-2-sendOnChannel-message-binaryReply"><a href="#7-2-2-sendOnChannel-message-binaryReply" class="headerlink" title="7.2.2 sendOnChannel:message:binaryReply:"></a>7.2.2 sendOnChannel:message:binaryReply:</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlutterEngine.mm -L704</span></span><br><span class="line">- (<span class="keyword">void</span>)sendOnChannel:(NSString*)channel</span><br><span class="line">              message:(NSData*)message</span><br><span class="line">          binaryReply:(FlutterBinaryReply)callback &#123;</span><br><span class="line">  NSParameterAssert(channel);</span><br><span class="line">  NSAssert(_shell &amp;&amp; _shell-&gt;IsSetup(),</span><br><span class="line">           @<span class="string">&quot;Sending a message before the FlutterEngine has been run.&quot;</span>);</span><br><span class="line">  <span class="comment">// 创建 PlatformMessageResponseDarwin 对象，后续在 Platform 线程中执行任务，见 [7.2.3]</span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessageResponseDarwin&gt; response =</span><br><span class="line">      (callback == nil) ? <span class="literal">nullptr</span></span><br><span class="line">                        : fml::MakeRefCounted&lt;flutter::PlatformMessageResponseDarwin&gt;(</span><br><span class="line">                              ^(NSData* reply) &#123;</span><br><span class="line">                                callback(reply);</span><br><span class="line">                              &#125;,</span><br><span class="line">                              _shell-&gt;GetTaskRunners().GetPlatformTaskRunner());</span><br><span class="line">  <span class="comment">// 创建 PlatformMessage 对象，跟 [3.1.3] 是类似的                           </span></span><br><span class="line">  fml::RefPtr&lt;flutter::PlatformMessage&gt; platformMessage =</span><br><span class="line">      (message == nil) ? fml::MakeRefCounted&lt;flutter::PlatformMessage&gt;(channel.UTF8String, response)</span><br><span class="line">                       : fml::MakeRefCounted&lt;flutter::PlatformMessage&gt;(</span><br><span class="line">                             channel.UTF8String, flutter::GetVectorFromNSData(message), response);</span><br><span class="line">  <span class="comment">// 见 [7.3]</span></span><br><span class="line">  _shell-&gt;GetPlatformView()-&gt;DispatchPlatformMessage(platformMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-3-PlatformMessageResponseDarwin"><a href="#7-2-3-PlatformMessageResponseDarwin" class="headerlink" title="7.2.3 PlatformMessageResponseDarwin"></a>7.2.3 PlatformMessageResponseDarwin</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_darwin.mm -L9</span></span><br><span class="line">PlatformMessageResponseDarwin::PlatformMessageResponseDarwin(</span><br><span class="line">    PlatformMessageResponseCallback callback,</span><br><span class="line">    fml::RefPtr&lt;fml::TaskRunner&gt; platform_task_runner)</span><br><span class="line">    : callback_(callback, fml::OwnershipPolicy::Retain),</span><br><span class="line">      platform_task_runner_(<span class="built_in">std</span>::move(platform_task_runner)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-3-4-PlatformMessageResponseDarwin-Complete"><a href="#7-3-4-PlatformMessageResponseDarwin-Complete" class="headerlink" title="7.3.4 PlatformMessageResponseDarwin::Complete"></a>7.3.4 PlatformMessageResponseDarwin::Complete</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_message_response_darwin.mm -L17</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformMessageResponseDarwin::Complete</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;fml::Mapping&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="function">fml::RefPtr&lt;PlatformMessageResponseDarwin&gt; <span class="title">self</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">  <span class="comment">// 在 platform 线程中执行任务</span></span><br><span class="line">  platform_task_runner_-&gt;PostTask(fml::MakeCopyable([self, data = <span class="built_in">std</span>::move(data)]() <span class="keyword">mutable</span> &#123;</span><br><span class="line">    self-&gt;callback_.get()(GetNSDataFromMapping(<span class="built_in">std</span>::move(data)));</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>callback_</code> 就是 [7.2.2] 里面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^(NSData* reply) &#123;</span><br><span class="line">    callback(reply);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>从而 <code>callback</code> 回调到 [7.1] 的 <code>reply</code>，最终会将调用到 [7] 的 <code>result</code> 回调，自此，整个链路就完成了。</p>
<h2 id="7-3-PlatformView-DispatchPlatformMessage"><a href="#7-3-PlatformView-DispatchPlatformMessage" class="headerlink" title="7.3 PlatformView::DispatchPlatformMessage"></a>7.3 PlatformView::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_view.cc -L35</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformView::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 见 [7.4]  </span></span><br><span class="line">  delegate_.OnPlatformViewDispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 <code>PlatformView</code> 是前面 <code>PlatformViewIOS</code> 的父类，所以看下 <code>PlatformViewIOS</code> 的初始化方法，看 <code>delegate_</code>.</p>
<h3 id="7-3-1-PlatformViewIOS-初始化"><a href="#7-3-1-PlatformViewIOS-初始化" class="headerlink" title="7.3.1 PlatformViewIOS 初始化"></a>7.3.1 PlatformViewIOS 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_view_ios.mm -47</span></span><br><span class="line">PlatformViewIOS::PlatformViewIOS(PlatformView::Delegate&amp; delegate,</span><br><span class="line">                                 IOSRenderingAPI rendering_api,</span><br><span class="line">                                 flutter::TaskRunners task_runners)</span><br><span class="line">    : PlatformView(delegate, <span class="built_in">std</span>::move(task_runners)),</span><br><span class="line">      ios_context_(IOSContext::Create(rendering_api)),</span><br><span class="line">      accessibility_bridge_([<span class="keyword">this</span>](<span class="keyword">bool</span> enabled) &#123; PlatformView::SetSemanticsEnabled(enabled); &#125;) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>由前面 [3.5] 可知，这里的 <code>delegate_</code> 就是 Shell 对象。</p>
<h2 id="7-4-Shell-OnPlatformViewDispatchPlatformMessage"><a href="#7-4-Shell-OnPlatformViewDispatchPlatformMessage" class="headerlink" title="7.4 Shell::OnPlatformViewDispatchPlatformMessage"></a>7.4 Shell::OnPlatformViewDispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shell.cc -L838</span></span><br><span class="line"><span class="comment">// |PlatformView::Delegate|</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Shell::OnPlatformViewDispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  FML_DCHECK(is_setup_);</span><br><span class="line">  FML_DCHECK(task_runners_.GetPlatformTaskRunner()-&gt;RunsTasksOnCurrentThread());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在 UI 线程中执行任务  </span></span><br><span class="line">  task_runners_.GetUITaskRunner()-&gt;PostTask(</span><br><span class="line">      [engine = engine_-&gt;GetWeakPtr(), message = <span class="built_in">std</span>::move(message)] &#123;</span><br><span class="line">        <span class="keyword">if</span> (engine) &#123;</span><br><span class="line">          <span class="comment">// 见 [7.5]  </span></span><br><span class="line">          engine-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-5-Engine-DispatchPlatformMessage"><a href="#7-5-Engine-DispatchPlatformMessage" class="headerlink" title="7.5 Engine::DispatchPlatformMessage"></a>7.5 Engine::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// engine.cc -L333</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Engine::DispatchPlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 判断相关 channel 名，在调用前面 [4.1] setupChannels 方法的时候，会设置这些 channel</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> channel = message-&gt;channel();</span><br><span class="line">  <span class="keyword">if</span> (channel == kLifecycleChannel) &#123;</span><br><span class="line">    <span class="keyword">if</span> (HandleLifecyclePlatformMessage(message.get())) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (channel == kLocalizationChannel) &#123;</span><br><span class="line">    <span class="keyword">if</span> (HandleLocalizationPlatformMessage(message.get())) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (channel == kSettingsChannel) &#123;</span><br><span class="line">    HandleSettingsPlatformMessage(message.get());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!runtime_controller_-&gt;IsRootIsolateRunning() &amp;&amp;</span><br><span class="line">             channel == kNavigationChannel) &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no runtime_, we may still need to set the initial route.</span></span><br><span class="line">    HandleNavigationPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在主 isolate 中执行任务</span></span><br><span class="line">  <span class="keyword">if</span> (runtime_controller_-&gt;IsRootIsolateRunning() &amp;&amp;</span><br><span class="line">      <span class="comment">// 见 [7.6]</span></span><br><span class="line">      runtime_controller_-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message))) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FML_DLOG(WARNING) &lt;&lt; <span class="string">&quot;Dropping platform message on channel: &quot;</span> &lt;&lt; channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-6-RuntimeController-DispatchPlatformMessage"><a href="#7-6-RuntimeController-DispatchPlatformMessage" class="headerlink" title="7.6 RuntimeController::DispatchPlatformMessage"></a>7.6 RuntimeController::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RuntimeController::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span>* platform_configuration = GetPlatformConfigurationIfAvailable()) &#123;</span><br><span class="line">    TRACE_EVENT1(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;RuntimeController::DispatchPlatformMessage&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;mode&quot;</span>, <span class="string">&quot;basic&quot;</span>);</span><br><span class="line">    <span class="comment">// 见 [7.7]             </span></span><br><span class="line">    platform_configuration-&gt;DispatchPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-7-PlatformConfiguration-DispatchPlatformMessage"><a href="#7-7-PlatformConfiguration-DispatchPlatformMessage" class="headerlink" title="7.7 PlatformConfiguration::DispatchPlatformMessage"></a>7.7 PlatformConfiguration::DispatchPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformConfiguration::DispatchPlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;tonic::DartState&gt; dart_state = library_.dart_state().lock();</span><br><span class="line">  <span class="keyword">if</span> (!dart_state) &#123;</span><br><span class="line">    FML_DLOG(WARNING)</span><br><span class="line">        &lt;&lt; <span class="string">&quot;Dropping platform message for lack of DartState on channel: &quot;</span></span><br><span class="line">        &lt;&lt; message-&gt;channel();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tonic::<span class="function">DartState::Scope <span class="title">scope</span><span class="params">(dart_state)</span></span>;</span><br><span class="line">  <span class="comment">// message-&gt;hasData() 是前面 [7.1] 中的 FlutterMethodCall 对象</span></span><br><span class="line">  Dart_Handle data_handle =</span><br><span class="line">      (message-&gt;hasData()) ? ToByteData(message-&gt;data()) : Dart_Null();</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsError(data_handle)) &#123;</span><br><span class="line">    FML_DLOG(WARNING)</span><br><span class="line">        &lt;&lt; <span class="string">&quot;Dropping platform message because of a Dart error on channel: &quot;</span></span><br><span class="line">        &lt;&lt; message-&gt;channel();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> response_id = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 跟 response_id 和 response 关联起来，由前面 [7.2.2] 可知这里 message-&gt;response() 为空</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> response = message-&gt;response()) &#123;</span><br><span class="line">    response_id = next_response_id_++;</span><br><span class="line">    pending_responses_[response_id] = response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// native -&gt; dart, 见 [7.8]  </span></span><br><span class="line">  tonic::LogIfError(</span><br><span class="line">      tonic::DartInvokeField(library_.value(), <span class="string">&quot;_dispatchPlatformMessage&quot;</span>,</span><br><span class="line">                             &#123;tonic::ToDart(message-&gt;channel()), data_handle,</span><br><span class="line">                              tonic::ToDart(response_id)&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-8-dispatchPlatformMessage"><a href="#7-8-dispatchPlatformMessage" class="headerlink" title="7.8 _dispatchPlatformMessage"></a>7.8 _dispatchPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hooks.dart -L144</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&#x27;vm:entry-point&#x27;</span>)</span><br><span class="line"><span class="comment">// ignore: unused_element</span></span><br><span class="line"><span class="keyword">void</span> _dispatchPlatformMessage(<span class="built_in">String</span> name, ByteData? data, <span class="built_in">int</span> responseId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (name == ChannelBuffers.kControlChannelName) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      channelBuffers.handleMessage(data!);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">      _printDebug(<span class="string">&#x27;Message to &quot;<span class="subst">$name</span>&quot; caused exception <span class="subst">$ex</span>&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>._respondToPlatformMessage(responseId, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.onPlatformMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 见 [7.8.1]</span></span><br><span class="line">    _invoke3&lt;<span class="built_in">String</span>, ByteData?, PlatformMessageResponseCallback&gt;(</span><br><span class="line">      <span class="built_in">window</span>.onPlatformMessage,</span><br><span class="line">      <span class="built_in">window</span>._onPlatformMessageZone,</span><br><span class="line">      name,</span><br><span class="line">      data,</span><br><span class="line">      (ByteData? responseData) &#123;</span><br><span class="line">        <span class="built_in">window</span>._respondToPlatformMessage(responseId, responseData);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    channelBuffers.push(name, data, (ByteData? responseData) &#123;</span><br><span class="line">      <span class="built_in">window</span>._respondToPlatformMessage(responseId, responseData);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-8-1"><a href="#7-8-1" class="headerlink" title="7.8.1"></a>7.8.1</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hooks.dart -L270</span></span><br><span class="line"><span class="comment">/// <span class="markdown">Invokes [callback] inside the given [zone] passing it [arg1], [arg2], and [arg3].</span></span></span><br><span class="line"><span class="keyword">void</span> _invoke3&lt;A1, A2, A3&gt;(<span class="keyword">void</span> callback(A1 a1, A2 a2, A3 a3)?, Zone zone, A1 arg1, A2 arg2, A3 arg3) &#123;</span><br><span class="line">  <span class="keyword">if</span> (callback == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">assert</span>(zone != <span class="keyword">null</span>); <span class="comment">// ignore: unnecessary_null_comparison</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (identical(zone, Zone.current)) &#123;</span><br><span class="line">    callback(arg1, arg2, arg3);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    zone.runGuarded(() &#123;</span><br><span class="line">      callback(arg1, arg2, arg3);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在给定的 Zone 里面，根据参数回调 callback.</p>
<ul>
<li>callback: window.onPlatformMessage, 见 [7.9]</li>
<li>zone: window._onPlatformMessageZone</li>
<li>arg1: name // channel 名</li>
<li>arg2: data // FlutterMethodCall 对象，见 [7.7]</li>
<li>arg3: window._respondToPlatformMessage, 见 [7.10]</li>
</ul>
<h2 id="7-9-onPlatformMessage"><a href="#7-9-onPlatformMessage" class="headerlink" title="7.9 onPlatformMessage"></a>7.9 onPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Listens for platform messages and directs them to the [defaultBinaryMessenger].</span></span><br><span class="line"><span class="keyword">mixin</span> ServicesBinding <span class="keyword">on</span> BindingBase, SchedulerBinding &#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initInstances() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initInstances();</span><br><span class="line">    _instance = <span class="keyword">this</span>;</span><br><span class="line">    _defaultBinaryMessenger = createBinaryMessenger();</span><br><span class="line">    _restorationManager = createRestorationManager();</span><br><span class="line">    <span class="comment">// 见 [7.9.1]</span></span><br><span class="line">    <span class="built_in">window</span>.onPlatformMessage = defaultBinaryMessenger.handlePlatformMessage;</span><br><span class="line">    initLicenses();</span><br><span class="line">    SystemChannels.system.setMessageHandler((<span class="built_in">dynamic</span> message) =&gt; handleSystemMessage(message <span class="keyword">as</span> <span class="built_in">Object</span>));</span><br><span class="line">    SystemChannels.lifecycle.setMessageHandler(_handleLifecycleMessage);</span><br><span class="line">    readInitialLifecycleStateFromNativeWindow();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-9-1-handlePlatformMessage"><a href="#7-9-1-handlePlatformMessage" class="headerlink" title="7.9.1 handlePlatformMessage"></a>7.9.1 handlePlatformMessage</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; handlePlatformMessage(</span><br><span class="line">    <span class="built_in">String</span> channel,</span><br><span class="line">    ByteData? data,</span><br><span class="line">    ui.PlatformMessageResponseCallback? callback,</span><br><span class="line">  ) <span class="keyword">async</span> &#123;</span><br><span class="line">    ByteData? response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 获取 handler, 跟 [3.6] 类似，现在的问题是在哪里设置的 _handlers 呢？见 [7.13]</span></span><br><span class="line">      <span class="keyword">final</span> MessageHandler? handler = _handlers[channel];</span><br><span class="line">      <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 执行 handler </span></span><br><span class="line">        response = <span class="keyword">await</span> handler(data);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ui.channelBuffers.push(channel, data, callback!);</span><br><span class="line">        callback = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">      FlutterError.reportError(FlutterErrorDetails(</span><br><span class="line">        exception: exception,</span><br><span class="line">        stack: stack,</span><br><span class="line">        <span class="keyword">library</span>: <span class="string">&#x27;services library&#x27;</span>,</span><br><span class="line">        context: ErrorDescription(<span class="string">&#x27;during a platform message callback&#x27;</span>),</span><br><span class="line">      ));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 回调 response, 见 [7.10]</span></span><br><span class="line">        callback(response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-10-respondToPlatformMessage"><a href="#7-10-respondToPlatformMessage" class="headerlink" title="7.10 _respondToPlatformMessage"></a>7.10 _respondToPlatformMessage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// window -L1216, 见 [7.11]</span></span><br><span class="line"><span class="comment">/// <span class="markdown">Called by [<span class="emphasis">_dispatchPlatformMessage].</span></span></span></span><br><span class="line">  <span class="keyword">void</span> _respondToPlatformMessage(<span class="built_in">int</span> responseId, ByteData? data)</span><br><span class="line">      native <span class="string">&#x27;PlatformConfiguration_respondToPlatformMessage&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><code>_dispatchPlatformMessage</code> 会调用 <code>_respondToPlatformMessage</code> 方法，而 <code>_respondToPlatformMessage</code> 又是一个 native 方法。</p>
<h2 id="7-11-RespondToPlatformMessage"><a href="#7-11-RespondToPlatformMessage" class="headerlink" title="7.11 _RespondToPlatformMessage"></a>7.11 _RespondToPlatformMessage</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_configuration.cc -L159</span></span><br><span class="line"><span class="keyword">void</span> _RespondToPlatformMessage(Dart_NativeArguments args) &#123;</span><br><span class="line">  tonic::DartCallStatic(&amp;RespondToPlatformMessage, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// platform_configuration.cc -L141</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RespondToPlatformMessage</span><span class="params">(Dart_Handle window,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> response_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> tonic::DartByteData&amp; data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsNull(data.dart_handle())) &#123;</span><br><span class="line">    UIDartState::Current()</span><br><span class="line">        -&gt;platform_configuration()</span><br><span class="line">        -&gt;CompletePlatformMessageEmptyResponse(response_id);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// TODO(engine): Avoid this copy.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* buffer = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(data.data());</span><br><span class="line">    <span class="comment">// 见 [7.11.1]</span></span><br><span class="line">    UIDartState::Current()</span><br><span class="line">        -&gt;platform_configuration()</span><br><span class="line">        -&gt;CompletePlatformMessageResponse(</span><br><span class="line">            response_id,</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;(buffer, buffer + data.length_in_bytes()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-11-1-PlatformConfiguration-CompletePlatformMessageResponse"><a href="#7-11-1-PlatformConfiguration-CompletePlatformMessageResponse" class="headerlink" title="7.11.1 PlatformConfiguration::CompletePlatformMessageResponse"></a>7.11.1 PlatformConfiguration::CompletePlatformMessageResponse</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlatformConfiguration::CompletePlatformMessageResponse</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> response_id,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; data)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 这 response_id 为 0, 对应着 [7.1] result 入参为 nil 的情况</span></span><br><span class="line">  <span class="keyword">if</span> (!response_id) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = pending_responses_.find(response_id);</span><br><span class="line">  <span class="comment">// 根据 response_id 没找到内容</span></span><br><span class="line">  <span class="keyword">if</span> (it == pending_responses_.end()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取 [7.7] 的 message-&gt;response(), 对应 [7.2.2] 的 response 对象</span></span><br><span class="line">  <span class="keyword">auto</span> response = <span class="built_in">std</span>::move(it-&gt;second);</span><br><span class="line">  <span class="comment">// 移除该回调</span></span><br><span class="line">  pending_responses_.erase(it);</span><br><span class="line">  <span class="comment">// 见 [7.3.4]</span></span><br><span class="line">  response-&gt;Complete(<span class="built_in">std</span>::make_unique&lt;fml::DataMapping&gt;(<span class="built_in">std</span>::move(data)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-12-setMethodCallHandler"><a href="#7-12-setMethodCallHandler" class="headerlink" title="7.12 setMethodCallHandler"></a>7.12 setMethodCallHandler</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// paltform_channel.dart -L377</span></span><br><span class="line"><span class="keyword">void</span> setMethodCallHandler(Future&lt;<span class="built_in">dynamic</span>&gt; <span class="built_in">Function</span>(MethodCall call)? handler) &#123;</span><br><span class="line">    <span class="comment">// 见 MethodChannel(this) 和 handler 关联起来 </span></span><br><span class="line">    _methodChannelHandlers[<span class="keyword">this</span>] = handler;</span><br><span class="line">    <span class="comment">// 见 [7.13]</span></span><br><span class="line">    binaryMessenger.setMessageHandler(</span><br><span class="line">      name,</span><br><span class="line">      handler == <span class="keyword">null</span></span><br><span class="line">        ? <span class="keyword">null</span></span><br><span class="line">        : (ByteData? message) =&gt; _handleAsMethodCall(message, handler),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-13-setMessageHandler"><a href="#7-13-setMessageHandler" class="headerlink" title="7.13 setMessageHandler"></a>7.13 setMessageHandler</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// binding.dart -L311</span></span><br><span class="line"><span class="keyword">void</span> setMessageHandler(<span class="built_in">String</span> channel, MessageHandler? handler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>)</span><br><span class="line">      _handlers.remove(channel);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      _handlers[channel] = handler;</span><br><span class="line">      ui.channelBuffers.drain(channel, (ByteData? data, ui.PlatformMessageResponseCallback callback) <span class="keyword">async</span> &#123;</span><br><span class="line">       <span class="keyword">await</span> handlePlatformMessage(channel, data, callback);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里跟前面 [7.9.1] 串联起来了，对 <code>_handlers</code> 进行赋值。</p>
<h1 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h1><h2 id="8-1-调用链路"><a href="#8-1-调用链路" class="headerlink" title="8.1 调用链路"></a>8.1 调用链路</h2><h3 id="8-1-1-dart-gt-native"><a href="#8-1-1-dart-gt-native" class="headerlink" title="8.1.1 dart -&gt; native"></a>8.1.1 dart -&gt; native</h3><p>调用流程如下：</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mUGGI2r5i-neno2THQeatT_9IYs5sjV5WBa3nWViDRBvGyKMW4bb7YCEwaZ0301WYHyushCicJOcKu__8oWsEYxJYuvnyKNiWYno_Dc-ahUlx8DoQFNmbi1dJYSNDF2UQocAp9kI6gczqy1xeP092Zq059i_o8kiNDkUA2fbVtqFqo3si12taxoHuocX89LSZ?width=1853&height=653&cropmode=none"></p>
<p>赋值 handler 流程图如下：<br><img src="https://sat02pap001files.storage.live.com/y4m-rYn8D1lzoPq_wbVvKy3EG6enZmedcNaBygocaNLZcdhSZeNYKXmP680OXlMqRjy7gHBixIXWcDiG9M3HusQuoTt8tRZP8l332NODfLERsK4nqIuhb8-x6ZySt9NsU3-NL3Sdd43joTTZ1rZ0AqR4djHPQzMPZbS2-g6xR8siN8pEl1pengn-_ghou21p20K?width=843&height=483&cropmode=none"></p>
<p>method channel 的执行涉及到主线程和UI线程的交互，代码调用从 dart -&gt; shell -&gt; native(ios), 执行完成后再原路返回 native(ios) -&gt; shell -&gt; dart.</p>
<ul>
<li>3.4 Shell::OnEngineHandlePlatformMessage, 在 UI 线程(io.flutter.1.ui), 将任务派发给主线程</li>
<li>6.1 PlatformMessageResponseDart::Complete, 在主线程(platform), 将任务派发给 UI 线程</li>
</ul>
<h3 id="8-1-2-native-gt-dart"><a href="#8-1-2-native-gt-dart" class="headerlink" title="8.1.2 native -&gt; dart"></a>8.1.2 native -&gt; dart</h3><p>调用流程如下：</p>
<p><img src="https://sat02pap001files.storage.live.com/y4mYWALpdQzLwOseOw8dbeMIzvvFQHdZzr8fEblvx10FYnSauMk-KRCNCVxgYPcZi_ooUOOGJ69jnQVjA-nKBpq-fdPzXuc2Ihwydb02HooyXOBIuUeXQGDFI2swtmsmgSFtaGVO_qHp6cQriPABQCkVdUDa83T_4F72eeaHOMvJyarXiwZ0kaSiNIcwsrjBMfi?width=2223&height=923&cropmode=none"></p>
<p>同 [8.1.1],  method channel 的执行涉及到主线程和UI线程的交互，代码调用从 native(ios) -&gt; shell -&gt; dart, 执行完成后再原路返回 dart -&gt; shell -&gt; native(ios).</p>
<ul>
<li>7.3.4 PlatformMessageResponseDarwin::Complete, 在 UI 线程(io.flutter.1.ui), 将任务派发给主线程</li>
<li>7.4 Shell::OnPlatformViewDispatchPlatformMessage,  在主线程(platform), 将任务派发给 UI 线程</li>
</ul>
<h2 id="8-2-相关概念"><a href="#8-2-相关概念" class="headerlink" title="8.2 相关概念"></a>8.2 相关概念</h2><ol>
<li>shell </li>
<li>isolate(和线程的关系)</li>
<li>ui platform 等线程，flutter 中有多少线程？</li>
<li>future Complete 异步调用</li>
<li>dart 和 native(ios) 中的相关编解码类</li>
</ol>
<h2 id="8-3-问题"><a href="#8-3-问题" class="headerlink" title="8.3 问题"></a>8.3 问题</h2><ol>
<li>dart 层和 native 层数据通信的本质是什么？</li>
<li>怎么监控 platform channel 的执行过程，方便调试？</li>
</ol>
<p>answer</p>
<ol>
<li>看源码可知，双方交互都是传递二进制数据，然后通过双方的编解码类来转成当前层所需要的对象，所以是二进制数据流；</li>
<li>可以自定义一个 <code>BinaryMessenger</code> 类，然后替换系统的 <code>ServicesBinding.defaultBinaryMessenger</code>，从而达到监控的目的；</li>
</ol>
<h1 id="10-参考链接"><a href="#10-参考链接" class="headerlink" title="10. 参考链接"></a>10. 参考链接</h1><ul>
<li><a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a></li>
<li><a href="http://gityuan.com/2019/08/10/flutter_channel/">深入理解Flutter的Platform Channel机制</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/24/matrix-flip/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/24/matrix-flip/" class="post-title-link" itemprop="url">矩阵翻转</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-24 22:16:56" itemprop="dateCreated datePublished" datetime="2021-02-24T22:16:56+08:00">2021-02-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在做今天的每日一题：<a href="https://leetcode-cn.com/problems/flipping-an-image/">832. 翻转图像</a>时，看到了之前的笔记，里面提到了一道类似的题目<a href="https://leetcode-cn.com/problems/rotate-image/">48. 旋转图像</a>，如果没记错的话，它应该是去年的一道每日一题。当时还想着要把沿对角线翻转的代码给记住的，但是现在也不记得了，为了完成去年前的任务，晚上花了点时间把相关翻转代码记录一下。</p>
<h1 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h1><p>给定一个 <code>n × n</code> 的二维矩阵 <code>matrix</code>(eg: <code>[[1,2,3],[4,5,6],[7,8,9]]</code>)，在遍历中分别输出行下标(i)和列表(j)的值。<br>以下的代码，记住画个图再来推理一篇，记忆效果会更好。</p>
<h2 id="水平上下翻转"><a href="#水平上下翻转" class="headerlink" title="水平上下翻转"></a>水平上下翻转</h2><p>行和是 n-1, 遍历一半；列正常处理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n/<span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">        swap(matrix[i][j], matrix[n-i<span class="number">-1</span>][j]);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&#x27;[&#x27;</span> &lt;&lt; i &lt;&lt; <span class="string">&#x27;,&#x27;</span> &lt;&lt; j &lt;&lt; <span class="string">&#x27;]&#x27;</span>&lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[0,0]</span></span><br><span class="line"><span class="comment">[0,1]</span></span><br><span class="line"><span class="comment">[0,2]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="垂直左右翻转"><a href="#垂直左右翻转" class="headerlink" title="垂直左右翻转"></a>垂直左右翻转</h2><p>行正常处理；列和是 n-1, 遍历一半。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n/<span class="number">2</span>; j++) &#123;</span><br><span class="line">        swap(matrix[i][j], matrix[i][n-j<span class="number">-1</span>]);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&#x27;[&#x27;</span> &lt;&lt; i &lt;&lt; <span class="string">&#x27;,&#x27;</span> &lt;&lt; j &lt;&lt; <span class="string">&#x27;]&#x27;</span>&lt;&lt; <span class="built_in">endl</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[0,0]</span></span><br><span class="line"><span class="comment">[1,0]</span></span><br><span class="line"><span class="comment">[2,0]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="主对角线（左上-右下）翻转"><a href="#主对角线（左上-右下）翻转" class="headerlink" title="主对角线（左上-右下）翻转"></a>主对角线（左上-右下）翻转</h2><p>交换i, j.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">        swap(matrix[i][j], matrix[j][i]);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&#x27;[&#x27;</span> &lt;&lt; i &lt;&lt; <span class="string">&#x27;,&#x27;</span> &lt;&lt; j &lt;&lt; <span class="string">&#x27;]&#x27;</span>&lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[1,0]</span></span><br><span class="line"><span class="comment">[2,0]</span></span><br><span class="line"><span class="comment">[2,1]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="副对角线（右上-左下）翻转"><a href="#副对角线（右上-左下）翻转" class="headerlink" title="副对角线（右上-左下）翻转"></a>副对角线（右上-左下）翻转</h2><p>交换i, j.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n<span class="number">-1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n-i<span class="number">-1</span>; j++) &#123;</span><br><span class="line">        swap(matrix[i][j], matrix[n-j<span class="number">-1</span>][n-i<span class="number">-1</span>]);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; j &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[0,0]</span></span><br><span class="line"><span class="comment">[0,1]</span></span><br><span class="line"><span class="comment">[1,0]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h1 id="套路"><a href="#套路" class="headerlink" title="套路"></a>套路</h1><ol>
<li>顺时针90度：主对角线（左上-右下）翻转，再垂直左右翻转</li>
<li>逆时针90度：主对角线（左上-右下）翻转，再水平上下翻转</li>
<li>顺时针180度：主对角线（左上-右下）翻转，再副对角线（右上-左下）翻转</li>
<li>逆时针180度：主对角线（左上-右下）翻转，再副对角线（右上-左下）翻转</li>
</ol>
<h2 id="48-旋转图像"><a href="#48-旋转图像" class="headerlink" title="48. 旋转图像"></a>48. 旋转图像</h2><blockquote>
<p>顺时针旋转 90 度。</p>
</blockquote>
<p>用套路1.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;&amp; matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = matrix.size();</span><br><span class="line">        <span class="keyword">if</span> (!n) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 主对角线翻转</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                myswap(matrix[i][j], matrix[j][i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 垂直左右翻转</span></span><br><span class="line">        <span class="keyword">int</span> mid = n &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mid; j++) &#123;</span><br><span class="line">                myswap(matrix[i][j], matrix[i][n-j<span class="number">-1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">myswap</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">int</span>&amp; b)</span> </span>&#123;</span><br><span class="line">        a = a ^ b;</span><br><span class="line">        b = a ^ b;</span><br><span class="line">        a = a ^ b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/23/binary-search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/23/binary-search/" class="post-title-link" itemprop="url">二分查找</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-23 07:34:04" itemprop="dateCreated datePublished" datetime="2021-01-23T07:34:04+08:00">2021-01-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>二分查找，就是在一个区间内查找某个值(eg: target)的时候，每次把区间一分为二，然后选择满足性质的区间(即包含 target)继续一分为二，直到区间长度为一。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/01/23/binary-search/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/21/compile-flutter-engine-using-Xcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/21/compile-flutter-engine-using-Xcode/" class="post-title-link" itemprop="url">用 Xcode 编译 Flutter Engine 源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-21 07:57:18" itemprop="dateCreated datePublished" datetime="2021-01-21T07:57:18+08:00">2021-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">flutter</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>参考官方 wiki <a href="https://github.com/flutter/flutter/wiki/Setting-up-the-Engine-development-environment">Setting up the Engine development environment</a> 和 <a href="http://gityuan.com/2019/08/03/flutter_engine_setup/">搭建Flutter Engine源码编译环境</a>，设置好环境。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/01/21/compile-flutter-engine-using-Xcode/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/09/runloop-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/09/runloop-note/" class="post-title-link" itemprop="url">Runloop 基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-09 13:02:34" itemprop="dateCreated datePublished" datetime="2019-03-09T13:02:34+08:00">2019-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是对 <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1">Threading Programming Guide - Run Loops</a> 文档的一个学习(其中参考了 <a href="https://opensource.apple.com/source/CF/CF-1153.18/CFRunLoop.c.auto.html">CFRunLoop</a> 源码)，其他例子在后期系统了解某个技术有涉及时再说。 其他高质量文章可见</p>
<ul>
<li><a href="https://blog.ibireme.com/2015/05/18/runloop/">深入理解RunLoop</a></li>
<li><a href="http://mrpeak.cn/blog/ios-runloop/">解密 Runloop</a></li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/09/runloop-note/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/02/wwdc-2018-219/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/02/wwdc-2018-219/" class="post-title-link" itemprop="url">Image and Graphics Best Practices</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-02 15:38:31" itemprop="dateCreated datePublished" datetime="2019-03-02T15:38:31+08:00">2019-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是对 <a href="https://developer.apple.com/videos/play/wwdc2018/219/">Image and Graphics Best Practices</a> 的一个学习记录文章，主要讲了图像加载的过程，要怎么优化内存和 CPU ，构建更流畅的应用程序。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/02/wwdc-2018-219/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/02/wwdc-2014-419/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="joakim.liu">
      <meta itemprop="description" content="你不解决问题，就会成为问题。iOS菜逗一枚。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛易疯先森的开发记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/02/wwdc-2014-419/" class="post-title-link" itemprop="url">Advanced Graphics and Animations for iOS Apps</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-02 09:07:01" itemprop="dateCreated datePublished" datetime="2019-03-02T09:07:01+08:00">2019-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是对 <a href="https://developer.apple.com/videos/play/wwdc2014/419/">Advanced Graphics and Animations for iOS Apps</a> 的一个学习记录文章，字幕在 <a href="https://asciiwwdc.com/2014/sessions/419">transcripts</a> ，当然也可以下载 <a href="https://wwdc.io/">WWDC</a> 在桌面上看带有字幕的视频。这篇挺实用的，讲解了渲染的基本流程，以及怎么发现并解决渲染性能的问题。(ps: 20中旬发现这个视频下架了，可以在 <a href="http://devstreaming.apple.com/videos/wwdc/2014/419xxli6f60a6bs/419/419_hd_advanced_graphics_and_animation_performance.mov?dl=1">419_hd_advanced_graphics_and_animation_performance.mov</a> 下载)。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/02/wwdc-2014-419/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">joakim.liu</p>
  <div class="site-description" itemprop="description">你不解决问题，就会成为问题。iOS菜逗一枚。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/JoakimLiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JoakimLiu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/JoakimLiu" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;JoakimLiu" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">joakim.liu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
